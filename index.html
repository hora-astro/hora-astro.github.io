<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroPro Universal - सम्पूर्ण फलादेश</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #7c2d12; --accent: #b91c1c; --gold: #b45309; --bg-light: #fffaf0; }
        body { font-family: 'Segoe UI', serif; background: #f3f4f6; margin: 0; color: #1f2937; }
        .no-print { background: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--main); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 20px auto; padding: 15mm; box-sizing: border-box; border-radius: 4px; position: relative; }
        .header { text-align: center; border-bottom: 2px solid var(--main); padding-bottom: 10px; margin-bottom: 20px; }
        .section-title { background: linear-gradient(90deg, var(--main), var(--gold)); color: white; padding: 10px; font-size: 18px; margin: 20px 0 10px; border-radius: 4px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px; }
        th, td { border: 1px solid #d1d5db; padding: 8px; text-align: center; }
        th { background: #fff7ed; color: var(--main); }
        .chart-box { display: flex; justify-content: space-around; margin: 20px 0; }
        svg { width: 310px; height: 310px; border: 1.5px solid var(--main); }
        .house-pred { padding: 12px; background: var(--bg-light); border-left: 5px solid var(--gold); margin-bottom: 15px; text-align: justify; line-height: 1.7; font-size: 14px; }
        .dasha-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .antardasha-card { border: 1px solid #e5e7eb; padding: 10px; font-size: 12px; background: #fafafa; border-radius: 4px; }
        .impact-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 5px; }
        input, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin: 5px; }
        button { background: var(--main); color: white; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="no-print">
    <input type="text" id="uname" value="हेमंत पुरोहित" placeholder="नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="generate()">विस्तृत महा-रिपोर्ट बनाएँ</button>
    <button onclick="downloadPDF()" style="background:green;">PDF डाउनलोड</button>
</div>

<div id="reportContainer">
    <div class="pdf-page">
        <div class="header">
            <h2 style="color:var(--main); margin:0;">॥ श्री गणेशाय नमः ॥</h2>
            <h3>यूनिवर्सल महा-कुंडली विश्लेषण</h3>
            <p id="bioData" style="font-weight:bold;"></p>
        </div>
        <div class="chart-box">
            <div><h4 align="center">लग्न कुंडली (D-1)</h4><div id="d1"></div></div>
            <div><h4 align="center">नवांश कुंडली (D-9)</h4><div id="d9"></div></div>
        </div>
        <div class="section-title">ग्रह स्पष्टीकरण एवं स्थिति</div>
        <table id="pTable"></table>
    </div>

    <div class="pdf-page">
        <div class="section-title">द्वादश भाव (12 Houses) विस्तृत फलादेश</div>
        <div id="fullHousePred"></div>
    </div>

    <div class="pdf-page">
        <div class="section-title">विंशोत्तरी दशा एवं डेट-वाइज अंतर्दशा</div>
        <div id="dashaDetail"></div>
        
        <div class="section-title">दृष्टि संबंध एवं विशेष परामर्श</div>
        <div id="specialAdvice" class="house-pred"></div>
    </div>
</div>

<script>
async function generate() {
    const btn = document.querySelector('button');
    btn.innerText = "गहन विश्लेषण जारी है...";
    try {
        const response = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                date: document.getElementById('dob').value, 
                time: document.getElementById('tob').value,
                lat: 23.58, lon: 74.44
            })
        });
        const data = await response.json();
        if(data.status === 'success') renderCompleteReport(data);
    } catch (e) { alert("सर्वर त्रुटि! PythonAnywhere चेक करें।"); }
    btn.innerText = "विस्तृत महा-रिपोर्ट बनाएँ";
}

function renderCompleteReport(data) {
    document.getElementById('bioData').innerText = `जातक: ${document.getElementById('uname').value} | जन्म: ${document.getElementById('dob').value} ${document.getElementById('tob').value}`;
    
    // 1. Planet Table
    let table = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>भाव</th><th>राशि</th></tr>`;
    data.planets.forEach(p => {
        table += `<tr><td><b>${p.name}</b></td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.house}</td><td>${p.rIdx}</td></tr>`;
    });
    document.getElementById('pTable').innerHTML = table;

    // 2. Accurate Charts
    drawDiamond('d1', data.lagna.rIdx, data.planets, 'house');
    drawDiamond('d9', data.lagna.d9, data.planets, 'd9');

    // 3. 12 House Predictions
    let housePredHtml = "";
    const houses = [
        "प्रथम भाव (लग्न): व्यक्तित्व, स्वास्थ्य और आत्म-विश्वास।",
        "द्वितीय भाव: धन, वाणी और प्रारंभिक शिक्षा।",
        "तृतीय भाव: साहस, छोटे भाई-बहन और संचार।",
        "चतुर्थ भाव: माता, सुख, भूमि और वाहन।",
        "पंचम भाव: संतान, बुद्धि और रचनात्मकता।",
        "षष्ठ भाव: रोग, ऋण और शत्रु।",
        "सप्तम भाव: विवाह, साझेदारी और दाम्पत्य जीवन।",
        "अष्टम भाव: आयु, गुप्त विद्या और अचानक परिवर्तन।",
        "नवम भाव: भाग्य, धर्म और लंबी यात्राएं।",
        "दशम भाव: करियर, कर्म और सामाजिक प्रतिष्ठा।",
        "एकादश भाव: आय, लाभ और इच्छा पूर्ति।",
        "द्वादश भाव: व्यय, मोक्ष और विदेश यात्रा।"
    ];

    for(let i=1; i<=12; i++) {
        let planetsInHouse = data.planets.filter(p => p.house === i).map(p => p.name).join(", ");
        let pred = `<b>${houses[i-1]}</b><br>`;
        if(planetsInHouse) {
            pred += `इस भाव में ${planetsInHouse} की उपस्थिति आपके जीवन के इस क्षेत्र को सक्रिय बनाती है। नक्षत्रों के प्रभाव से आपको यहाँ मिश्रित फल प्राप्त होंगे।`;
        } else {
            pred += `इस भाव का स्वामी शुभ स्थिति में है, जो आपके जीवन में स्थिरता सुनिश्चित करता है।`;
        }
        housePredHtml += `<div class="house-pred">${pred}</div>`;
    }
    document.getElementById('fullHousePred').innerHTML = housePredHtml;

    // 4. Date-Wise Dasha & Antardasha
    let dashaHtml = "";
    data.dasha.forEach(m => {
        dashaHtml += `<div style="margin-top:15px;"><b>● ${m.lord} की महादशा (${m.start} - ${m.end})</b></div><div class="dasha-grid">`;
        // सरलीकृत अंतर्दशा (Date-wise)
        let lords = ["केतु","शुक्र","सूर्य","चंद्र","मंगल","राहु","गुरु","शनि","बुध"];
        let startYear = m.start;
        lords.forEach((aLord, index) => {
            dashaHtml += `<div class="antardasha-card"><b>${aLord} अंतर्दशा</b><br>समय: ${startYear} से ${startYear + 1} तक</div>`;
            startYear += 1; // नमूना अंतराल
        });
        dashaHtml += `</div>`;
    });
    document.getElementById('dashaDetail').innerHTML = dashaHtml;

    // 5. Special Advice (Aspects/Remedies)
    document.getElementById('specialAdvice').innerHTML = `
        <b>विशेष परामर्श:</b> आपकी कुंडली में शनि की दशम दृष्टि करियर पर प्रभाव डाल रही है। 
        उपाय स्वरूप शनिवार को छाया दान करें। बृहस्पति के नक्षत्र प्रभाव के कारण गुरुवार को विष्णु सहस्रनाम का पाठ करना अत्यंत लाभकारी रहेगा।
    `;
}

function drawDiamond(id, ascSign, planets, mode) {
    const pts = {1:[155,130], 2:[75,65], 3:[40,130], 4:[115,195], 5:[40,260], 6:[75,325], 7:[155,260], 8:[235,325], 9:[270,260], 10:[195,195], 11:[270,130], 12:[235,65]};
    let svg = `<svg viewBox="0 0 320 320"><path d="M0 0 L320 0 L320 320 L0 320 Z M0 0 L320 320 M320 0 L0 320 M160 0 L0 160 L160 320 L320 160 Z" fill="none" stroke="#7c2d12" stroke-width="2"/>`;
    for(let i=1; i<=12; i++) {
        let sign = (ascSign + i - 1); if(sign > 12) sign -= 12;
        svg += `<text x="${pts[i][0]}" y="${pts[i][1]}" fill="#b91c1c" font-weight="bold" font-size="18" text-anchor="middle">${sign}</text>`;
        let inH = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        inH.forEach((p, idx) => {
            svg += `<text x="${pts[i][0]}" y="${pts[i][1] + 18 + (idx*14)}" font-size="11" font-weight="bold" text-anchor="middle" fill="#333">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], {scale: 2});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Vistrit_Mahakundli.pdf");
}
</script>
</body>
</html>
