<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hora Astro Pro | Free Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #e64a19; --bg: #fff5f2; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); text-align: center; margin: 0; padding: 10px; }
        .card { background: white; max-width: 500px; margin: auto; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Tabs */
        .tabs { display: flex; overflow-x: auto; gap: 5px; margin: 15px 0; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 10px; border: none; background: #eee; cursor: pointer; flex: 1; font-weight: bold; border-radius: 8px 8px 0 0; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }

        /* Kundli SVG */
        .kundli-svg { width: 100%; height: auto; background: white; border: 2px solid #333; margin-top: 10px; }
        .line { stroke: #333; stroke-width: 2; }
        .rashi-text { fill: #d32f2f; font-size: 16px; font-weight: bold; }
        .planet-text { fill: #000; font-size: 11px; font-weight: bold; }

        input, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; font-size: 13px; text-align: left; }
    </style>
</head>
<body>

<div class="card" id="kundli-report">
    <h1 style="color:var(--primary);">Hora Astro üåå</h1>
    
    <div class="no-print">
        <input type="text" id="date" placeholder="YYYY/MM/DD (2006/11/06)">
        <input type="text" id="time" placeholder="HH:MM (11:28)">
        <input type="text" id="lat" placeholder="Latitude (23.33)">
        <input type="text" id="lng" placeholder="Longitude (74.26)">
        <button onclick="fetchAllData()">‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
    </div>

    <div class="tabs no-print">
        <button class="tab-btn active" onclick="openTab(event, 'tab-d1')">D1 (‡§≤‡§ó‡•ç‡§®)</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-d9')">D9 (‡§®‡§µ‡§æ‡§Ç‡§∂)</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-panchang')">‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-dasha')">‡§¶‡§∂‡§æ</button>
    </div>

    <div id="tab-d1" class="tab-content" style="display:block;">
        <h3>‡§≤‡§ó‡•ç‡§® ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D1)</h3>
        <svg viewBox="0 0 300 300" class="kundli-svg" id="svg-d1"></svg>
    </div>

    <div id="tab-d9" class="tab-content">
        <h3>‡§®‡§µ‡§æ‡§Ç‡§∂ ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D9)</h3>
        <svg viewBox="0 0 300 300" class="kundli-svg" id="svg-d9"></svg>
    </div>

    <div id="tab-panchang" class="tab-content">
        <h3>‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
        <table id="panchang-table"></table>
    </div>

    <div id="tab-dasha" class="tab-content">
        <h3>‡§µ‡§ø‡§Ç‡§∂‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‡§Æ‡§π‡§æ‡§¶‡§∂‡§æ</h3>
        <table id="dasha-table">
            <thead><tr><th>‡§ó‡•ç‡§∞‡§π</th><th>‡§Ö‡§Ç‡§§ ‡§§‡§ø‡§•‡§ø</th></tr></thead>
            <tbody id="dasha-list"></tbody>
        </table>
    </div>

    <button class="no-print" style="background:#2e7d32; margin-top:20px;" onclick="downloadPDF()">PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç üìÑ</button>
</div>

<script>
    const hNames = {"Sun":"‡§∏‡•Ç‡§∞‡•ç‡§Ø","Moon":"‡§ö‡§Ç‡§¶‡•ç‡§∞","Mercury":"‡§¨‡•Å‡§ß","Venus":"‡§∂‡•Å‡§ï‡•ç‡§∞","Mars":"‡§Æ‡§Ç‡§ó‡§≤","Jupiter":"‡§ó‡•Å‡§∞‡•Å","Saturn":"‡§∂‡§®‡§ø","North Node":"‡§∞‡§æ‡§π‡•Ç","South Node":"‡§ï‡•á‡§§‡•Å"};

    const houseCoords = {
        1: {rx: 150, ry: 75, px: 150, py: 110},
        2: {rx: 75, ry: 45, px: 50, py: 70},
        3: {rx: 40, ry: 80, px: 40, py: 115},
        4: {rx: 75, ry: 150, px: 50, py: 185},
        5: {rx: 40, ry: 220, px: 40, py: 255},
        6: {rx: 75, ry: 265, px: 75, py: 240},
        7: {rx: 150, ry: 225, px: 150, py: 185},
        8: {rx: 225, ry: 265, px: 225, py: 240},
        9: {rx: 260, ry: 220, px: 260, py: 255},
        10: {rx: 225, ry: 150, px: 250, py: 185},
        11: {rx: 260, ry: 80, px: 260, py: 115},
        12: {rx: 225, ry: 45, px: 250, py: 70}
    };

    function openTab(evt, tabName) {
        document.querySelectorAll(".tab-content").forEach(t => t.style.display = "none");
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }

    async function fetchAllData() {
        const base = `https://hemantpurohit27.pythonanywhere.com/get_kundli?date=${document.getElementById('date').value}&time=${document.getElementById('time').value}&lat=${document.getElementById('lat').value}&lng=${document.getElementById('lng').value}`;
        
        const res = await fetch(base);
        const result = await res.json();
        
        if(result.status === "success") {
            drawSVG("svg-d1", result.asc_num, result.data);
            // ‡§Ø‡§π‡§æ‡§Å D9 ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§≠‡•Ä ‡§¨‡•à‡§ï‡§è‡§Ç‡§° ‡§∏‡•á ‡§Ü‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, ‡§Ö‡§≠‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è D1 ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç
            drawSVG("svg-d9", result.asc_num, result.data); 
            fillPanchang(result.panchang);
            fillDasha(result.dasha);
        }
    }

    function drawSVG(id, lagna, planets) {
        const svg = document.getElementById(id);
        svg.innerHTML = `
            <rect width="300" height="300" fill="none" stroke="#333" stroke-width="2"/>
            <line x1="0" y1="0" x2="300" y2="300" class="line"/>
            <line x1="300" y1="0" x2="0" y2="300" class="line"/>
            <line x1="150" y1="0" x2="0" y2="150" class="line"/>
            <line x1="0" y1="150" x2="150" y2="300" class="line"/>
            <line x1="150" y1="300" x2="300" y2="150" class="line"/>
            <line x1="300" y1="150" x2="150" y2="0" class="line"/>
        `;

        for (let i = 1; i <= 12; i++) {
            let rNum = ((lagna + i - 2) % 12) + 1;
            let c = houseCoords[i];
            svg.innerHTML += `<text x="${c.rx}" y="${c.ry}" class="rashi-text" text-anchor="middle">${rNum}</text>`;
        }

        const hCount = {};
        planets.forEach(p => {
            if (p.house) {
                if(!hCount[p.house]) hCount[p.house] = 0;
                let c = houseCoords[p.house];
                let offset = hCount[p.house] * 12;
                let name = hNames[p.name] || p.name.substring(0,2);
                svg.innerHTML += `<text x="${c.px}" y="${c.py + offset}" class="planet-text" text-anchor="middle">${name} ${Math.floor(p.degree)}¬∞</text>`;
                hCount[p.house]++;
            }
        });
    }

    function fillPanchang(data) {
        const table = document.getElementById("panchang-table");
        table.innerHTML = `
            <tr><td>‡§§‡§ø‡§•‡§ø</td><td>${data.tithi || 'N/A'}</td></tr>
            <tr><td>‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞</td><td>${data.nakshatra || 'N/A'}</td></tr>
            <tr><td>‡§Ø‡•ã‡§ó</td><td>${data.yoga || 'N/A'}</td></tr>
        `;
    }

    function fillDasha(data) {
        const body = document.getElementById("dasha-list");
        body.innerHTML = data.map(d => `<tr><td>${d.planet}</td><td>${d.end_date}</td></tr>`).join('');
    }

    function downloadPDF() {
        const element = document.getElementById('kundli-report');
        html2pdf().from(element).save();
    }
</script>
</body>
</html>
