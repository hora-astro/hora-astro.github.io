<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Professional Maha Kundli Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #7c2d12; }
        body { font-family: serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .controls { background: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--main); position: sticky; top: 0; z-index: 100; }
        .pdf-page { width: 210mm; background: white; margin: 20px auto; padding: 20mm; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .section-title { background: var(--main); color: white; padding: 10px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid var(--main); padding: 8px; text-align: center; }
        .chart-container { display: flex; justify-content: center; margin: 20px 0; }
        svg { width: 350px; height: 350px; border: 2px solid var(--main); }
        .pred-text { line-height: 1.8; text-align: justify; font-size: 17px; }
    </style>
</head>
<body>

<div class="controls">
    <input type="text" id="uname" value="हेमंत पुरोहित">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="generate()" style="background:var(--main); color:white; padding:10px;">रिपोर्ट जेनरेट करें</button>
    <button onclick="downloadPDF()" style="background:green; color:white; padding:10px;">PDF डाउनलोड</button>
</div>

<div id="reportArea">
    <div class="pdf-page">
        <h1 align="center" style="color:var(--main);">॥ श्री गणेशाय नमः ॥</h1>
        <h2 align="center">सम्पूर्ण जन्म कुंडली विश्लेषण</h2>
        <p id="metaInfo" align="center" style="font-weight:bold;"></p>
        
        <div class="chart-container"><div id="d1Chart"></div></div>
        
        <div class="section-title">ग्रह स्पष्टीकरण</div>
        <table id="pTable"></table>
        
        <div class="section-title">व्यक्तित्व एवं स्वभाव</div>
        <div id="naturePred" class="pred-text"></div>
    </div>
</div>

<script>
async function generate() {
    // 404 से बचने के लिए सीधा और सही URL
    const url = 'https://hemantpurohit27.pythonanywhere.com/calculate';
    
    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: document.getElementById('uname').value,
                date: document.getElementById('dob').value,
                time: document.getElementById('tob').value
            })
        });
        
        const data = await res.json();
        if(data.status === 'success') renderReport(data);
        else alert("Error: " + data.message);
    } catch (e) {
        alert("सर्वर से कनेक्शन नहीं हो पाया। कृपया सुनिश्चित करें कि आपने PythonAnywhere पर Reload बटन दबाया है।");
    }
}

function renderReport(data) {
    document.getElementById('metaInfo').innerText = `नाम: ${data.meta.name} | तिथि: ${data.meta.date} | समय: ${data.meta.time} | लग्न: ${data.lagna.nak}`;
    
    let rows = "<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>भाव</th></tr>";
    data.planets.forEach(p => {
        rows += `<tr><td>${p.name}</td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.house}</td></tr>`;
    });
    document.getElementById('pTable').innerHTML = rows;

    drawChart('d1Chart', data.lagna.rIdx, data.planets);
    
    document.getElementById('naturePred').innerHTML = `आपका लग्न <b>${data.lagna.nak}</b> नक्षत्र में है। ग्रहों की स्थिति के अनुसार आप एक बुद्धिमान और प्रभावशाली व्यक्तित्व के धनी हैं। एकादश भाव के ग्रह आपकी आय के स्रोतों को मजबूत करेंगे।`;
}

function drawChart(divId, asc, planets) {
    const pts = {1:[160,110], 2:[80,50], 3:[40,110], 4:[120,160], 5:[40,220], 6:[80,280], 7:[160,210], 8:[240,280], 9:[280,220], 10:[200,160], 11:[280,110], 12:[240,50]};
    let svg = `<svg viewBox="0 0 320 320"><path d="M0 0 L320 0 L320 320 L0 320 Z M0 0 L320 320 M320 0 L0 320 M160 0 L0 160 L160 320 L320 160 Z" fill="none" stroke="#7c2d12" stroke-width="2"/>`;
    for(let i=1; i<=12; i++) {
        let r = (asc + i - 1); if(r > 12) r -= 12;
        svg += `<text x="${pts[i][0]}" y="${pts[i][1]}" fill="red" font-weight="bold" font-size="16" text-anchor="middle">${r}</text>`;
        let inHouse = planets.filter(p => p.house === i);
        inHouse.forEach((p, idx) => {
            svg += `<text x="${pts[i][0]}" y="${pts[i][1] + 18 + (idx*14)}" font-size="11" font-weight="bold" text-anchor="middle">${p.name}</text>`;
        });
    }
    document.getElementById(divId).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const canvas = await html2canvas(document.querySelector(".pdf-page"));
    doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    doc.save("Report.pdf");
}
</script>
</body>
</html>
