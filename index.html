<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hora Astro | Ultimate Professional Fix</title>
    <style>
        :root { --primary: #ff5722; --bg: #fdf2f0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); text-align: center; margin: 0; padding: 10px; }
        .card { background: white; max-width: 450px; margin: auto; padding: 15px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        /* Location Suggestion Box */
        .search-container { position: relative; margin-bottom: 10px; }
        #suggestions { 
            position: absolute; background: white; width: 100%; z-index: 100; 
            border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 200px; 
            overflow-y: auto; display: none; text-align: left;
        }
        .s-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
        .s-item:hover { background: #f9f9f9; }

        input, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }

        /* SVG Precise Styling */
        .kundli-svg { width: 100%; height: auto; background: white; border: 2.5px solid #333; margin-top: 15px; }
        .line { stroke: #333; stroke-width: 2; }
        .rashi-text { fill: #d32f2f; font-size: 16px; font-weight: 900; }
        .planet-text { fill: #000; font-size: 11px; font-weight: bold; font-family: Arial, sans-serif; }
    </style>
</head>
<body>

<div class="card">
    <h1 style="color:var(--primary); margin:10px 0;">Hora Astro üåå</h1>
    
    <div class="search-container">
        <input type="text" id="loc" placeholder="‡§∂‡§π‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç (‡§ú‡•à‡§∏‡•á Banswara)..." autocomplete="off">
        <div id="suggestions"></div>
    </div>
    
    <input type="hidden" id="lat"> <input type="hidden" id="lng">
    <input type="text" id="date" placeholder="YYYY/MM/DD (‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø)">
    <input type="text" id="time" placeholder="HH:MM (‡§∏‡§Æ‡§Ø)">
    <button onclick="fetchChart()">‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç</button>

    <div id="chart-area" style="display:none;">
        <svg viewBox="0 0 300 300" class="kundli-svg">
            <rect width="300" height="300" fill="none" stroke="#333" stroke-width="2"/>
            <line x1="0" y1="0" x2="300" y2="300" class="line"/>
            <line x1="300" y1="0" x2="0" y2="300" class="line"/>
            <line x1="150" y1="0" x2="0" y2="150" class="line"/>
            <line x1="0" y1="150" x2="150" y2="300" class="line"/>
            <line x1="150" y1="300" x2="300" y2="150" class="line"/>
            <line x1="300" y1="150" x2="150" y2="0" class="line"/>
            
            <g id="rashiLayer"></g>
            <g id="planetLayer"></g>
        </svg>
    </div>
</div>

<script>
    const hNames = {"Sun":"‡§∏‡•Ç‡§∞‡•ç‡§Ø","Moon":"‡§ö‡§Ç‡§¶‡•ç‡§∞","Mercury":"‡§¨‡•Å‡§ß","Venus":"‡§∂‡•Å‡§ï‡•ç‡§∞","Mars":"‡§Æ‡§Ç‡§ó‡§≤","Jupiter":"‡§ó‡•Å‡§∞‡•Å","Saturn":"‡§∂‡§®‡§ø","North Node":"‡§∞‡§æ‡§π‡•Ç","South Node":"‡§ï‡•á‡§§‡•Å","Syzygy":"Sy","Pars Fortuna":"Pa"};

    // ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§ò‡§∞ (House) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡§ø‡§ï‡•ç‡§∏ ‡§î‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•ã‡§Ü‡§∞‡•ç‡§°‡§ø‡§®‡•á‡§ü‡•ç‡§∏
    const housePoints = {
        1:  {rx: 150, ry: 85,  px: 150, py: 115},
        2:  {rx: 75,  ry: 45,  px: 55,  py: 75},
        3:  {rx: 40,  ry: 80,  px: 40,  py: 110},
        4:  {rx: 85,  ry: 155, px: 55,  py: 175},
        5:  {rx: 40,  ry: 220, px: 40,  py: 250},
        6:  {rx: 75,  ry: 265, px: 65,  py: 240},
        7:  {rx: 150, ry: 215, px: 150, py: 185},
        8:  {rx: 225, ry: 265, px: 235, py: 240},
        9:  {rx: 260, ry: 220, px: 260, py: 250},
        10: {rx: 215, ry: 155, px: 245, py: 175},
        11: {rx: 260, ry: 80,  px: 260, py: 110},
        12: {rx: 225, ry: 45,  px: 245, py: 75}
    };

    // 1. ‡§∂‡§π‡§∞ ‡§ñ‡•ã‡§ú ‡§≤‡•â‡§ú‡§ø‡§ï (Location Dropdown)
    const locInp = document.getElementById('loc');
    const sugBox = document.getElementById('suggestions');

    locInp.oninput = async () => {
        if(locInp.value.length < 3) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${locInp.value}&limit=5`);
        const data = await res.json();
        sugBox.innerHTML = ""; sugBox.style.display = 'block';
        data.forEach(d => {
            let item = document.createElement('div');
            item.className = 's-item';
            item.innerText = d.display_name;
            item.onclick = () => {
                locInp.value = d.display_name;
                document.getElementById('lat').value = d.lat;
                document.getElementById('lng').value = d.lon;
                sugBox.style.display = 'none';
            };
            sugBox.appendChild(item);
        });
    };

    // 2. ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§°‡•á‡§ü‡§æ ‡§î‡§∞ ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó (Kundli Core)
    async function fetchChart() {
        const lat = document.getElementById('lat').value;
        if(!lat) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡•á ‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!"); return; }

        const url = `https://hemantpurohit27.pythonanywhere.com/get_kundli?date=${document.getElementById('date').value}&time=${document.getElementById('time').value}&lat=${lat}&lng=${document.getElementById('lng').value}`;
        const res = await fetch(url);
        const result = await res.json();
        
        if (result.status === "success") {
            document.getElementById('chart-area').style.display = 'block';
            const rLayer = document.getElementById('rashiLayer');
            const pLayer = document.getElementById('planetLayer');
            rLayer.innerHTML = ""; pLayer.innerHTML = "";
            
            // ‡§≤‡§ó‡•ç‡§® ‡§î‡§∞ ‡§∞‡§æ‡§∂‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§ï‡•ç‡§∞‡§Æ
            const lagna = result.asc_num;
            for (let i = 1; i <= 12; i++) {
                let rNum = ((lagna + i - 2) % 12) + 1;
                let pt = housePoints[i];
                rLayer.innerHTML += `<text x="${pt.rx}" y="${pt.ry}" class="rashi-text" text-anchor="middle">${rNum}</text>`;
            }

            // ‡§ó‡•ç‡§∞‡§π‡•ã‡§Ç ‡§ï‡§æ ‡§™‡•ç‡§≤‡•á‡§∏‡§Æ‡•á‡§Ç‡§ü (Vertical Stacking)
            const count = {};
            result.data.forEach(p => {
                if (p.house) {
                    if(!count[p.house]) count[p.house] = 0;
                    let pt = housePoints[p.house];
                    let moveDown = count[p.house] * 13; // ‡§ó‡•ç‡§∞‡§π‡•ã‡§Ç ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§ï‡•Ä ‡§¶‡•Ç‡§∞‡•Ä
                    let name = hNames[p.name] || p.name.substring(0,2);
                    let deg = Math.floor(p.degree || 0);
                    
                    pLayer.innerHTML += `<text x="${pt.px}" y="${pt.py + moveDown}" class="planet-text" text-anchor="middle">${name} ${deg}¬∞</text>`;
                    count[p.house]++;
                }
            });
        }
    }
</script>
</body>
</html>
