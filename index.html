<div class="controls" style="background:#1e293b; padding:15px; border-radius:8px; display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
    <input type="text" id="uName" placeholder="नाम" value="Hemant Purohit" style="width:150px;">
    <input type="text" id="uCity" placeholder="शहर" value="Banswara" style="width:150px;">
    <input type="date" id="uDate" value="1980-03-27">
    <input type="time" id="uTime" value="08:10">
    <button onclick="runV80()" style="background:#ea580c; color:white; border:none; padding:10px 20px; cursor:pointer; font-weight:bold;">कुंडली जनरेट करें</button>
</div>

<div id="reportCard" style="display:none; background:white; color:black; padding:20px; border:8px double #7c2d12;">
    <h3 align="center" id="metaTitle" style="color:#7c2d12;"></h3>
    <div id="v80Chart" style="max-width:400px; margin:auto;"></div>
    <table border="1" style="width:100%; border-collapse:collapse; margin-top:20px; text-align:center;">
        <thead style="background:#7c2d12; color:white;">
            <tr><th>ग्रह (Planet)</th><th>राशि (Sign)</th><th>अंश (Degree)</th></tr>
        </thead>
        <tbody id="v80Table"></tbody>
    </table>
</div>

<script>
    async function runV80() {
        const d = document.getElementById('uDate').value;
        const t = document.getElementById('uTime').value;
        const url = `https://hemantpurohit27.pythonanywhere.com/api/v80?date=${d}&time=${t}&lat=24.58&lng=73.71`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            if(data.error) throw new Error(data.error);

            document.getElementById('reportCard').style.display = 'block';
            document.getElementById('metaTitle').innerText = `॥ ${document.getElementById('uName').value} - सटीक KP विवरण ॥`;

            // तालिका और चार्ट दोनों के लिए एक ही लूप का उपयोग
            let rows = "";
            data.planets.forEach(p => {
                rows += `<tr><td style="color:blue; font-weight:bold;">${p.name}</td><td>${p.sign}</td><td>${p.deg}°</td></tr>`;
            });
            document.getElementById('v80Table').innerHTML = rows;

            drawPreciseChart("v80Chart", data.asc, data.planets);
        } catch(e) { alert("Error: बैकएंड v80 चेक करें!"); }
    }

    function drawPreciseChart(divId, asc, planets) {
        const coords = {1:[175,130], 2:[85,60], 3:[40,130], 4:[115,215], 5:[40,290], 6:[85,360], 7:[175,290], 8:[265,360], 9:[310,290], 10:[225,215], 11:[310,130], 12:[265,60]};
        let svg = `<svg viewBox="0 0 350 350" width="100%"><path d="M0 0 L350 350 M350 0 L0 350 M175 0 L0 175 L175 350 L350 175 Z" fill="none" stroke="red" stroke-width="2.5"/>`;
        
        for (let h = 1; h <= 12; h++) {
            let sNum = ((asc + h - 2) % 12) + 1;
            svg += `<text x="${coords[h][0]}" y="${coords[h][1]}" fill="red" font-weight="bold" font-size="22" text-anchor="middle">${sNum}</text>`;
            
            // "Absolute Lock": ग्रह केवल उसी खाने में जाएगा जहाँ तालिका वाली राशि का नंबर लिखा है
            let matched = planets.filter(p => p.sign === sNum);
            matched.forEach((p, i) => {
                svg += `<text x="${coords[h][0]}" y="${coords[h][1] + 25 + (i*16)}" fill="blue" font-size="12" font-weight="bold" text-anchor="middle">${p.name}</text>`;
            });
        }
        document.getElementById(divId).innerHTML = svg + `</svg>`;
    }
</script>
