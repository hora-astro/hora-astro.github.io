<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroExpert Pro - कमर्शियल कुंडली सॉफ्टवेयर</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #7c2d12; --gold: #b45309; --paper: #fffdf5; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 50px; }
        
        /* UI Components */
        .no-print { background: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--main); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 25px auto; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 20px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        
        /* Chart Styling */
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-box { text-align: center; background: #fff; padding: 10px; border: 1.5px solid #eee; border-radius: 8px; }
        svg { width: 100%; height: auto; max-width: 350px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.05)); }
        
        /* Table & Text */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: center; }
        th { background: #fff7ed; color: var(--main); font-weight: bold; }
        .house-analysis { border-left: 6px solid var(--main); background: var(--paper); padding: 15px; margin-bottom: 12px; line-height: 1.8; text-align: justify; font-size: 15px; border-radius: 4px; }
        
        .header-title { color: var(--main); border-bottom: 2px solid var(--gold); display: inline-block; margin-bottom: 10px; padding-bottom: 5px; }
        input, button { padding: 12px; margin: 5px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        button { background: var(--main); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #451a03; transform: scale(1.05); }
    </style>
</head>
<body>

<div class="no-print">
    <input type="text" id="uname" value="हेमंत पुरोहित" placeholder="जातक का नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="generateCommercialReport()">सम्पूर्ण कुंडली रिपोर्ट जेनरेट करें</button>
    <button onclick="downloadPDF()" style="background: #15803d;">PDF रिपोर्ट डाउनलोड</button>
</div>

<div id="printArea">
    <div class="pdf-page">
        <center>
            <h1 class="header-title">॥ श्री गणेशाय नमः ॥</h1>
            <h2 id="dispName">व्यावसायिक जन्म कुंडली रिपोर्ट</h2>
            <p id="dispDetails"></p>
        </center>

        <div class="chart-grid">
            <div class="chart-box">
                <h3 style="color:var(--main)">लग्न कुंडली (D1)</h3>
                <div id="d1Chart"></div>
            </div>
            <div class="chart-box">
                <h3 style="color:var(--main)">नवांश कुंडली (D9)</h3>
                <div id="d9Chart"></div>
            </div>
        </div>

        <h3 class="header-title">ग्रह स्पष्टीकरण (Planetary Degrees)</h3>
        <table id="planetTable"></table>
    </div>

    <div class="pdf-page">
        <h3 class="header-title">द्वादश भाव (12 Houses) - सूक्ष्म फलादेश</h3>
        <div id="houseFphal"></div>
    </div>

    <div class="pdf-page">
        <h3 class="header-title">विंशोत्तरी महादशा एवं समय चक्र</h3>
        <div id="dashaTable"></div>
        
        <h3 class="header-title">व्यापार, स्वास्थ्य एवं विशेष ज्योतिषीय उपाय</h3>
        <div class="house-analysis">
            <b>● स्वास्थ्य परामर्श:</b> आपकी कुंडली के अनुसार लग्न स्वामी की स्थिति उत्तम है, जो दीर्घायु प्रदान करती है। राहु-शनि के प्रभाव से मानसिक तनाव संभव है, योग का सहारा लें। <br>
            <b>● करियर एवं धन:</b> एकादश भाव में ग्रहों की युति बड़े आर्थिक लाभ का संकेत देती है। आप व्यापारिक क्षेत्र में नेतृत्व करेंगे। <br><br>
            <b>सटीक उपाय:</b> <br>
            1. मंगलवार को हनुमान जी को चोला चढ़ाएं। <br>
            2. पक्षियों को प्रतिदिन सात प्रकार का अनाज (सप्तधान) खिलाएं। <br>
            3. ॐ नमो भगवते वासुदेवाय मंत्र का 108 बार जप करें।
        </div>
    </div>
</div>

<script>
async function generateCommercialReport() {
    const response = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            date: document.getElementById('dob').value, 
            time: document.getElementById('tob').value 
        })
    });
    const data = await response.json();
    if(data.status === 'success') renderEngine(data);
}

function renderEngine(data) {
    document.getElementById('dispName').innerText = document.getElementById('uname').value;
    document.getElementById('dispDetails').innerText = `जन्म तिथि: ${document.getElementById('dob').value} | समय: ${document.getElementById('tob').value}`;
    
    // 1. Planetary Table
    let pTable = `<tr><th>ग्रह</th><th>राशि</th><th>अंश</th><th>नक्षत्र</th><th>पद</th><th>भाव</th></tr>`;
    data.planets.forEach(p => {
        pTable += `<tr><td><b>${p.name}</b></td><td>${p.house}</td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.charan}</td><td>${p.house}</td></tr>`;
    });
    document.getElementById('planetTable').innerHTML = pTable;

    // 2. Optimized Chart Drawing (Centralized Logic)
    drawSmartChart('d1Chart', data.lagna.rIdx, data.planets, 'house');
    drawSmartChart('d9Chart', data.lagna.d9, data.planets, 'd9');

    // 3. 12 House Analysis
    const houseLabels = ["व्यक्तित्व (Lagna)", "धन एवं वाणी", "साहस एवं पराक्रम", "सुख एवं माता", "संतान एवं विद्या", "रोग एवं ऋण", "विवाह एवं साझेदारी", "आयु एवं संकट", "भाग्य एवं धर्म", "कर्म एवं करियर", "लाभ एवं आय", "व्यय एवं मोक्ष"];
    let hHtml = "";
    for(let i=1; i<=12; i++) {
        let pList = data.planets.filter(p => p.house === i).map(p => p.name).join(", ");
        hHtml += `<div class="house-analysis"><b>${i}. ${houseLabels[i-1]} भाव:</b><br>`;
        if(pList) hHtml += `इस भाव में <b>${pList}</b> स्थित हैं। यह युति आपके जीवन में इस क्षेत्र को अत्यंत सक्रिय बनाती है। यहाँ स्थित ग्रहों का प्रभाव आपके भाग्य को दिशा देगा।`;
        else hHtml += `यह भाव रिक्त है, किन्तु भाव स्वामी की स्थिति अनुसार यह आपको सामान्य फल प्रदान करेगा।`;
        hHtml += `</div>`;
    }
    document.getElementById('houseFphal').innerHTML = hHtml;

    // 4. Dasha Table
    let dHtml = "<table><tr><th>ग्रह</th><th>आरंभ तिथि</th><th>समाप्ति तिथि</th><th>प्रकार</th></tr>";
    data.dasha.forEach(m => {
        dHtml += `<tr style="background:#fef3c7"><td><b>${m.lord}</b></td><td>${m.start}</td><td>${m.end}</td><td>महादशा</td></tr>`;
    });
    document.getElementById('dashaTable').innerHTML = dHtml + "</table>";
}

function drawSmartChart(divId, ascSign, planets, type) {
    // Perfect Geometric Center Points for North Indian Chart
    const points = {
        1: [175, 140], 2: [87, 85],   3: [55, 140], 
        4: [125, 215], 5: [55, 285],  6: [87, 345], 
        7: [175, 285], 8: [262, 345], 9: [295, 285], 
        10: [225, 215], 11: [295, 140], 12: [262, 85]
    };

    let svg = `<svg viewBox="0 0 350 380">
        <path d="M0 0 L350 0 L350 350 L0 350 Z M0 0 L350 350 M350 0 L0 350 M175 0 L0 175 L175 350 L350 175 Z" 
              fill="none" stroke="#7c2d12" stroke-width="2.5"/>`;

    for (let i = 1; i <= 12; i++) {
        let sign = (ascSign + i - 1); if (sign > 12) sign -= 12;
        let cx = points[i][0];
        let cy = points[i][1];

        // 1. Sign Number (Absolutely Centralized)
        svg += `<text x="${cx}" y="${cy}" fill="#b91c1c" font-weight="bold" font-size="20" opacity="0.2" text-anchor="middle" dominant-baseline="middle">${sign}</text>`;

        // 2. Planets (Positioned around Center)
        let list = (type === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        
        list.forEach((p, idx) => {
            let xOff = (idx % 2 === 0) ? -22 : 22;
            let yOff = Math.floor(idx / 2) * 16 - 5;
            if(list.length === 1) { xOff = 0; yOff = 10; } // Single planet centering
            
            svg += `<text x="${cx + xOff}" y="${cy + yOff}" font-size="12" font-weight="bold" text-anchor="middle" fill="#333">${p.name}</text>`;
        });
    }
    document.getElementById(divId).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const sections = document.querySelectorAll('.pdf-page');
    for(let i=0; i<sections.length; i++) {
        const canvas = await html2canvas(sections[i], {scale: 3});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save(`${document.getElementById('uname').value}_Kundli_Report.pdf`);
}
</script>
</body>
</html>
