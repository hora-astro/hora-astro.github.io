<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Universal Kundli</title>
    <style>
        :root { --primary: #b91c1c; --secondary: #1e293b; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--secondary); }
        .container { max-width: 1000px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        
        /* Input Area */
        .input-panel { padding: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #fff; }
        .field { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; outline: none; }
        input:focus { border-color: var(--primary); }
        .main-btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; grid-column: 1 / -1; transition: 0.2s; }
        .main-btn:hover { background: #991b1b; }

        /* Output Area */
        .output-grid { display: none; grid-template-columns: 1.2fr 1fr; gap: 20px; padding: 25px; animation: fadeIn 0.5s; }
        @media (max-width: 768px) { .output-grid { grid-template-columns: 1fr; } }
        
        .chart-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; }
        svg { width: 100%; height: auto; max-width: 450px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: var(--secondary); color: white; padding: 12px; font-size: 14px; }
        td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; font-weight: 600; font-size: 14px; }
        
        #loader { display: none; text-align: center; padding: 20px; font-weight: bold; color: var(--primary); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0;">॥ प्रोफेशनल यूनिवर्सल कुंडली सॉफ्टवेयर ॥</h1>
        <p style="margin:5px 0 0; opacity: 0.9;">सटीक खगोलीय गणना और ग्रह स्पष्ट</p>
    </div>

    <div class="input-panel">
        <div class="field">
            <label>शहर का नाम (Universal Search)</label>
            <input type="text" id="city" placeholder="उदा: Banswara, Mumbai, London" onblur="searchLocation()">
        </div>
        <div class="field">
            <label>जन्म तारीख</label>
            <input type="date" id="dob" value="1980-03-27">
        </div>
        <div class="field">
            <label>जन्म समय</label>
            <input type="time" id="tob" value="08:10">
        </div>
        
        <input type="hidden" id="lat" value="23.55">
        <input type="hidden" id="lon" value="74.43">
        
        <button class="main-btn" onclick="generateKundli()">कुंडली जनरेट करें ★</button>
    </div>

    <div id="loader">गणना की जा रही है, कृपया प्रतीक्षा करें...</div>

    <div id="results" class="output-grid">
        <div class="chart-card">
            <h3 style="color:var(--primary); margin-top:0;">लग्न कुंडली (D1 Chart)</h3>
            <div id="svgContainer"></div>
            <p id="loc-display" style="font-size:12px; color:gray; margin-top:10px;"></p>
        </div>

        <div class="chart-card">
            <h3 style="color:var(--primary); margin-top:0;">ग्रह स्पष्ट विवरण</h3>
            <table>
                <thead>
                    <tr><th>ग्रह</th><th>राशि</th><th>अंश</th></tr>
                </thead>
                <tbody id="planetBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// 1. पूरी दुनिया के शहरों के लिए लोकेशन सर्च (Universal API)
async function searchLocation() {
    const city = document.getElementById('city').value;
    if(city.length < 3) return;
    
    document.getElementById('loader').style.display = 'block';
    document.getElementById('loader').innerText = "लोकेशन खोजी जा रही है...";

    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
        const data = await res.json();
        if(data.length > 0) {
            document.getElementById('lat').value = data[0].lat;
            document.getElementById('lon').value = data[0].lon;
            document.getElementById('loc-display').innerText = "स्थान: " + data[0].display_name;
            document.getElementById('loader').innerText = "स्थान सेट कर दिया गया है।";
        }
    } catch(e) { console.error("Geo Error"); }
    setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
}

// 2. PythonAnywhere से कुंडली डेटा लाना
async function generateKundli() {
    const loader = document.getElementById('loader');
    const results = document.getElementById('results');
    
    loader.style.display = 'block';
    loader.innerText = "ग्रहों की सटीक गणना की जा रही है...";
    results.style.display = 'none';

    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };

    try {
        const response = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if(data.status === 'success') {
            loader.style.display = 'none';
            results.style.display = 'grid';
            renderView(data);
        } else {
            loader.innerText = "Error: " + data.message;
        }
    } catch (err) {
        loader.innerText = "सर्वर कनेक्शन एरर! क्या आपका PythonAnywhere 'Reload' है?";
    }
}

// 3. UI और चार्ट रेंडर करना
function renderView(data) {
    // टेबल अपडेट
    document.getElementById('planetBody').innerHTML = data.planets.map(p => `
        <tr><td>${p.name}</td><td>${p.rashi}</td><td>${p.deg}°</td></tr>
    `).join('');

    // डायमंड चार्ट बनाना
    drawNorthIndianChart(data.lagna, data.planets);
}

function drawNorthIndianChart(asc, planets) {
    const container = document.getElementById('svgContainer');
    const coords = [
        {x:200, y:130}, {x:100, y:70}, {x:50, y:130}, {x:150, y:200},
        {x:50, y:270}, {x:100, y:330}, {x:200, y:270}, {x:300, y:330},
        {x:350, y:270}, {x:250, y:200}, {x:350, y:130}, {x:300, y:70}
    ];

    let svgStr = `<svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="400" fill="white" stroke="#333" stroke-width="2"/>
        <line x1="0" y1="0" x2="400" y2="400" stroke="#333"/>
        <line x1="400" y1="0" x2="0" y2="400" stroke="#333"/>
        <line x1="200" y1="0" x2="0" y2="200" stroke="#333"/>
        <line x1="200" y1="0" x2="400" y2="200" stroke="#333"/>
        <line x1="0" y1="200" x2="200" y2="400" stroke="#333"/>
        <line x1="200" y1="400" x2="400" y2="200" stroke="#333"/>`;

    for (let i = 0; i < 12; i++) {
        let rNum = (asc + i) > 12 ? (asc + i) - 12 : (asc + i);
        // राशि नंबर
        svgStr += `<text x="${coords[i].x}" y="${coords[i].y}" fill="#b91c1c" font-size="24" font-weight="bold" text-anchor="middle">${rNum}</text>`;
        
        let m = 0;
        planets.forEach(p => {
            if (p.rIdx === rNum) {
                // ग्रह का नाम
                svgStr += `<text x="${coords[i].x}" y="${coords[i].y + 25 + (m * 18)}" fill="#1e293b" font-size="14" font-weight="bold" text-anchor="middle">${p.name}</text>`;
                m++;
            }
        });
    }
    svgStr += `</svg>`;
    container.innerHTML = svgStr;
}
</script>
</body>
</html>
