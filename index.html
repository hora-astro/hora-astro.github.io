<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hora Astro Pro | D1, D9, Panchang & Dasha</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #e64a19; --bg: #fff5f2; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); text-align: center; margin: 0; padding: 10px; }
        .card { background: white; max-width: 500px; margin: auto; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Tabs Styling */
        .tabs { display: flex; overflow-x: auto; gap: 5px; margin: 15px 0; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 12px; border: none; background: #eee; cursor: pointer; flex: 1; font-weight: bold; border-radius: 8px 8px 0 0; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; padding: 10px 0; }

        /* Kundli SVG Styling */
        .kundli-svg { width: 100%; max-width: 350px; height: auto; background: white; border: 2px solid #333; margin: auto; }
        .line { stroke: #333; stroke-width: 1.5; }
        .rashi-text { fill: #d32f2f; font-size: 16px; font-weight: bold; }
        .planet-text { fill: #000; font-size: 11px; font-weight: bold; }

        input, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 10px; font-size: 14px; text-align: left; }
        th { background: #f8f8f8; color: var(--primary); }

        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="card" id="report-area">
    <h1 style="color:var(--primary); margin-bottom: 5px;">Hora Astro Pro üåå</h1>
    <p style="font-size: 12px; color: #666; margin-top: 0;">D1, D9, Panchang & Vimsottari Dasha</p>
    
    <div class="no-print">
        <input type="text" id="date" placeholder="YYYY/MM/DD (‡§ú‡•à‡§∏‡•á 2006/11/06)">
        <input type="text" id="time" placeholder="HH:MM (‡§ú‡•à‡§∏‡•á 11:28)">
        <input type="text" id="lat" placeholder="Latitude (‡§ú‡•à‡§∏‡•á 23.33)">
        <input type="text" id="lng" placeholder="Longitude (‡§ú‡•à‡§∏‡•á 74.26)">
        <button onclick="fetchAllData()">‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
    </div>

    <div class="tabs no-print">
        <button class="tab-btn active" onclick="openTab(event, 'tab-d1')">D1 (‡§≤‡§ó‡•ç‡§®)</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-d9')">D9 (‡§®‡§µ‡§æ‡§Ç‡§∂)</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-panchang')">‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-dasha')">‡§¶‡§∂‡§æ</button>
    </div>

    <div id="tab-d1" class="tab-content" style="display:block;">
        <h3>‡§≤‡§ó‡•ç‡§® ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D1 Chart)</h3>
        <div id="svg-container-d1"></div>
    </div>

    <div id="tab-d9" class="tab-content">
        <h3>‡§®‡§µ‡§æ‡§Ç‡§∂ ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D9 Chart)</h3>
        <div id="svg-container-d9"></div>
    </div>

    <div id="tab-panchang" class="tab-content">
        <h3>‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
        <table id="panchang-table">
            <tbody id="panchang-body"></tbody>
        </table>
    </div>

    <div id="tab-dasha" class="tab-content">
        <h3>‡§µ‡§ø‡§Ç‡§∂‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‡§Æ‡§π‡§æ‡§¶‡§∂‡§æ</h3>
        <table>
            <thead><tr><th>‡§ó‡•ç‡§∞‡§π</th><th>‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§§‡§ø‡§•‡§ø</th></tr></thead>
            <tbody id="dasha-body"></tbody>
        </table>
    </div>

    <button class="no-print" style="background:#2e7d32; margin-top:20px;" onclick="downloadPDF()">PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç üìÑ</button>
</div>

<script>
    const hNames = {"Sun":"‡§∏‡•Ç‡§∞‡•ç‡§Ø","Moon":"‡§ö‡§Ç‡§¶‡•ç‡§∞","Mercury":"‡§¨‡•Å‡§ß","Venus":"‡§∂‡•Å‡§ï‡•ç‡§∞","Mars":"‡§Æ‡§Ç‡§ó‡§≤","Jupiter":"‡§ó‡•Å‡§∞‡•Å","Saturn":"‡§∂‡§®‡§ø","North Node":"‡§∞‡§æ‡§π‡•Ç","South Node":"‡§ï‡•á‡§§‡•Å"};

    // ‡§∏‡§ü‡•Ä‡§ï ‡§ï‡•ã‡§∞‡•ç‡§°‡§ø‡§®‡•á‡§ü‡•ç‡§∏ (Houses 1-12)
    const coords = {
        1: {rx: 150, ry: 75, px: 150, py: 110},
        2: {rx: 75, ry: 45, px: 55, py: 70},
        3: {rx: 40, ry: 75, px: 40, py: 110},
        4: {rx: 85, ry: 150, px: 55, py: 180},
        5: {rx: 40, ry: 225, px: 45, py: 255},
        6: {rx: 75, ry: 265, px: 75, py: 240},
        7: {rx: 150, ry: 220, px: 150, py: 185},
        8: {rx: 225, ry: 265, px: 225, py: 240},
        9: {rx: 265, ry: 225, px: 260, py: 255},
        10: {rx: 220, ry: 150, px: 250, py: 180},
        11: {rx: 265, ry: 75, px: 260, py: 110},
        12: {rx: 225, ry: 45, px: 245, py: 70}
    };

    function openTab(evt, tabName) {
        document.querySelectorAll(".tab-content").forEach(t => t.style.display = "none");
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }

    // ‡§Ø‡§π‡•Ä ‡§µ‡§π ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§Ü‡§™‡§®‡•á ‡§™‡•Ç‡§õ‡§æ ‡§•‡§æ
    async function fetchAllData() {
        const btn = event.target;
        btn.innerText = "‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
        
        try {
            const url = `https://hemantpurohit27.pythonanywhere.com/get_kundli?date=${document.getElementById('date').value}&time=${document.getElementById('time').value}&lat=${document.getElementById('lat').value}&lng=${document.getElementById('lng').value}`;
            const res = await fetch(url);
            const result = await res.json();
            
            if(result.status === "success") {
                // 1. D1 ‡§î‡§∞ D9 ‡§ö‡§æ‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§¨‡§®‡§æ‡§è‡§Ç
                drawSVG("svg-container-d1", result.asc_num, result.d1_data);
                drawSVG("svg-container-d9", result.d9_asc_num, result.d9_data); 
                
                // 2. ‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó ‡§≠‡§∞‡•á‡§Ç
                fillPanchang(result.panchang);
                
                // 3. ‡§¶‡§∂‡§æ ‡§≠‡§∞‡•á‡§Ç
                fillDasha(result.dasha);
                
                btn.innerText = "‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç";
            }
        } catch (e) {
            alert("Error fetching data!");
            btn.innerText = "‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç";
        }
    }

    function drawSVG(containerId, lagna, planets) {
        const container = document.getElementById(containerId);
        let svgHtml = `<svg viewBox="0 0 300 300" class="kundli-svg">
            <rect width="300" height="300" fill="none" stroke="#333" stroke-width="2"/>
            <line x1="0" y1="0" x2="300" y2="300" class="line"/>
            <line x1="300" y1="0" x2="0" y2="300" class="line"/>
            <line x1="150" y1="0" x2="0" y2="150" class="line"/>
            <line x1="0" y1="150" x2="150" y2="300" class="line"/>
            <line x1="150" y1="300" x2="300" y2="150" class="line"/>
            <line x1="300" y1="150" x2="150" y2="0" class="line"/>`;

        // ‡§∞‡§æ‡§∂‡§ø‡§Ø‡§æ‡§Å ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        for (let i = 1; i <= 12; i++) {
            let rNum = ((lagna + i - 2) % 12) + 1;
            let c = coords[i];
            svgHtml += `<text x="${c.rx}" y="${c.ry}" class="rashi-text" text-anchor="middle">${rNum}</text>`;
        }

        // ‡§ó‡•ç‡§∞‡§π ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        const hCount = {};
        planets.forEach(p => {
            if (p.house) {
                if(!hCount[p.house]) hCount[p.house] = 0;
                let c = coords[p.house];
                let offset = hCount[p.house] * 12;
                let name = hNames[p.name] || p.name.substring(0,2);
                svgHtml += `<text x="${c.px}" y="${c.py + offset}" class="planet-text" text-anchor="middle">${name} ${Math.floor(p.degree)}¬∞</text>`;
                hCount[p.house]++;
            }
        });

        svgHtml += `</svg>`;
        container.innerHTML = svgHtml;
    }

    function fillPanchang(data) {
        const body = document.getElementById("panchang-body");
        body.innerHTML = `
            <tr><td>‡§§‡§ø‡§•‡§ø (Tithi)</td><td>${data.tithi}</td></tr>
            <tr><td>‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞ (Nakshatra)</td><td>${data.nakshatra}</td></tr>
            <tr><td>‡§Ø‡•ã‡§ó (Yoga)</td><td>${data.yoga}</td></tr>
            <tr><td>‡§µ‡§æ‡§∞ (Day)</td><td>${data.vaar}</td></tr>
        `;
    }

    function fillDasha(data) {
        const body = document.getElementById("dasha-body");
        body.innerHTML = data.map(d => `<tr><td>${hNames[d.planet] || d.planet}</td><td>${d.end_date}</td></tr>`).join('');
    }

    function downloadPDF() {
        const element = document.getElementById('report-area');
        html2pdf().from(element).set({
            margin: 10,
            filename: 'My_Kundli_HoraAstro.pdf',
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
    }
</script>
</body>
</html>
