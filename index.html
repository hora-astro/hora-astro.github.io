<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AstroMaster Pro - Vedic Commercial Suite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #b45309; --success: #16a34a; --danger: #dc2626; }
        body { font-family: 'Sanskrit', Arial, sans-serif; background: #e5e7eb; margin: 0; }
        .toolbar { background: #fff; padding: 20px; text-align: center; border-bottom: 5px solid var(--maroon); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 30px auto; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 20px rgba(0,0,0,0.3); position: relative; }
        .pdf-page::after { content: "AstroMaster Pro - Confidential"; position: absolute; bottom: 10px; right: 20px; font-size: 10px; color: #ccc; }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin: 20px 0; }
        .chart-box { border: 3px solid #333; padding: 15px; background: #fffdf5; border-radius: 8px; }
        
        table { width: 100%; border-collapse: collapse; margin: 20px 0; background: #fff; }
        th, td { border: 1.5px solid #999; padding: 12px; text-align: center; font-size: 14px; }
        th { background: #800000; color: white; }
        
        .u-txt { color: var(--success); font-weight: bold; } /* उच्च */
        .n-txt { color: var(--danger); font-weight: bold; }  /* नीच */
        
        .pred-box { background: #fff9db; border-left: 10px solid var(--maroon); padding: 25px; line-height: 1.8; margin-bottom: 25px; border-radius: 5px; font-size: 16px; border: 1px solid #ffe082; }
        .dasha-sub-row { font-size: 12px; color: #444; background: #f9fafb; }
        
        button { background: var(--maroon); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित">
    <input type="date" id="custDob" value="1980-03-27">
    <input type="time" id="custTob" value="10:30">
    <button onclick="calculateFullReport()">संपूर्ण फलादेश जेनरेट करें</button>
    <button onclick="downloadPDF()" style="background:#059669;">PDF सेव करें</button>
</div>

<div id="mainReport">
    <div class="pdf-page">
        <h1 style="text-align:center; color:var(--maroon); text-decoration: underline;">॥ श्री गणेशाय नमः ॥</h1>
        <h2 style="text-align:center;">वैदिक जन्म कुंडली विश्लेषण रिपोर्ट</h2>
        
        <div class="chart-grid">
            <div class="chart-box"><h3>लग्न कुंडली (D1)</h3><div id="d1_svg"></div></div>
            <div class="chart-box"><h3>नवांश कुंडली (D9)</h3><div id="d9_svg"></div></div>
        </div>

        <table id="spasht_tbl"></table>
    </div>

    <div class="pdf-page">
        <h2 style="color:var(--maroon); border-bottom: 2px solid;">महादशा - अंतर्दशा - प्रत्यंतर समय चक्र</h2>
        <div id="dasha_content"></div>
    </div>

    <div id="house_predictions"></div>
</div>

<script>
const dOrder = ["केतु","शुक्र","सूर्य","चंद्र","मंगल","राहु","गुरु","शनि","बुध"];
const dYears = {"केतु":7,"शुक्र":20,"सूर्य":6,"चंद्र":10,"मंगल":7,"राहु":18,"गुरु":16,"शनि":19,"बुध":17};

// उच्च (Exaltation) और नीच (Debilitation) राशियाँ
const EX_SIGNS = {"सूर्य":1, "चंद्र":2, "मंगल":10, "बुध":6, "गुरु":4, "शुक्र":12, "शनि":7, "राहु":3, "केतु":9};
const DB_SIGNS = {"सूर्य":7, "चंद्र":8, "मंगल":4, "बुध":12, "गुरु":10, "शुक्र":6, "शनि":1, "राहु":9, "केतु":3};

const HOUSE_TITLES = [
    "प्रथम भाव (तनु): व्यक्तित्व, स्वास्थ्य और स्वभाव",
    "द्वितीय भाव (धन): संपत्ति, वाणी और कुटुंब",
    "तृतीय भाव (सहज): साहस, छोटे भाई-बहन और पराक्रम",
    "चतुर्थ भाव (सुख): माता, वाहन, सुख और अचल संपत्ति",
    "पंचम भाव (सुत): संतान, बुद्धि, विद्या और प्रेम",
    "षष्ठ भाव (रिपु): शत्रु, रोग, ऋण और प्रतियोगिता",
    "सप्तम भाव (जाया): विवाह, साझेदारी और वैवाहिक जीवन",
    "अष्टम भाव (मृत्यु): आयु, आकस्मिक घटनाएं और शोध",
    "नवम भाव (भाग्य): धर्म, भाग्य, पिता और लंबी यात्राएं",
    "दशम भाव (कर्म): करियर, पद-प्रतिष्ठा और राजनीति",
    "एकादश भाव (लाभ): आय, बड़े भाई-बहन और सिद्धि",
    "द्वादश भाव (व्यय): मोक्ष, विदेश यात्रा और खर्च"
];

async function calculateFullReport() {
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            date: document.getElementById('custDob').value, 
            time: document.getElementById('custTob').value 
        })
    });
    const data = await res.json();
    if(data.status === 'success') renderUI(data);
}

function renderUI(data) {
    // 1. Spasht Table
    let sTbl = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र (पद)</th><th>राशि (D1)</th><th>नवांश (D9)</th><th>अवस्था</th></tr>`;
    data.planets.forEach(p => {
        let status = (p.rIdx === EX_SIGNS[p.name]) ? "<span class='u-txt'>उच्च</span>" : 
                     (p.rIdx === DB_SIGNS[p.name]) ? "<span class='n-txt'>नीच</span>" : "सामान्य";
        sTbl += `<tr><td><b>${p.name}</b></td><td>${p.deg}°</td><td>${p.nak} (${p.charan})</td><td>${p.rIdx}</td><td>${p.d9}</td><td>${status}</td></tr>`;
    });
    document.getElementById('spasht_tbl').innerHTML = sTbl;

    // 2. Dasha with Pratyantar
    let dHtml = `<table><tr><th>दशा स्वामी</th><th>अवधि (प्रारंभ - अंत)</th><th>प्रत्यंतर विवरण (सूक्ष्म समय)</th></tr>`;
    data.dasha.forEach(m => {
        let pFlow = "";
        let mStart = new Date(m.start.split('-').reverse().join('-'));
        let mYears = dYears[m.lord];
        
        // प्रत्यंतर गणना (Simplified Logic: Top 3 Pratyantars)
        for(let j=0; j<3; j++) {
            let pLord = dOrder[(dOrder.indexOf(m.lord) + j) % 9];
            let pDays = (mYears * dYears[pLord] * 365.25) / (120 * 9); // Approximate
            let pEnd = new Date(mStart.getTime() + pDays * 24 * 60 * 60 * 1000);
            pFlow += `• ${pLord}: ${mStart.toLocaleDateString('hi-IN')} से ${pEnd.toLocaleDateString('hi-IN')}<br>`;
            mStart = pEnd;
        }
        
        dHtml += `<tr><td><b>${m.lord}</b></td><td>${m.start} <br>से<br> ${m.end}</td><td style='text-align:left;'>${pFlow}</td></tr>`;
    });
    document.getElementById('dasha_content').innerHTML = dHtml + `</table>`;

    // 3. House Predictions
    let pHtml = "";
    for(let i=1; i<=12; i++) {
        let pInH = data.planets.filter(p => p.house === i);
        let pNames = pInH.map(p => p.name).join(", ");
        pHtml += `<div class="pdf-page">
            <h2 style="color:var(--maroon); border-bottom: 2px solid;">${HOUSE_TITLES[i-1]}</h2>
            <div class="pred-box">
                <b>स्थित ग्रह:</b> ${pNames || "कोई ग्रह नहीं"}<br><br>
                <b>शास्त्रीय विवेचना:</b> इस भाव का स्वामी (भावेश) कुंडली के अन्य केंद्रों से शुभ दृष्टि प्राप्त कर रहा है। 
                ${pInH.length > 0 ? "इस भाव में ग्रहों की उपस्थिति जीवन के इस क्षेत्र में सक्रियता को दर्शाती है।" : "भाव रिक्त होने के कारण भावेश के गोचर अनुसार फल प्राप्त होंगे।"} <br><br>
                <b>विस्तृत फल:</b> वैदिक ज्योतिष के अनुसार, ${i} भाव में ${pNames} का होना जातक को विशेष रूप से ${i==1?'दीर्घायु और तेज':i==10?'राजकीय सफलता':'उन्नति'} प्रदान करेगा। 
                नवांश कुंडली (D9) में स्थिति पुष्ट होने से यह फल अधिक स्थायी होंगे।
            </div>
        </div>`;
    }
    document.getElementById('house_predictions').innerHTML = pHtml;

    drawChart('d1_svg', data.lagna.rIdx, data.planets, 'house');
    drawChart('d9_svg', data.lagna.d9, data.planets, 'd9');
}

function drawChart(id, asc, planets, mode) {
    const coords = {1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]};
    let svg = `<svg viewBox="0 0 450 480"><path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#333" stroke-width="2.5"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 1); if (sign > 12) sign -= 12;
        let [x, y] = coords[i];
        svg += `<text x="${x}" y="${y+5}" fill="#800000" font-weight="900" font-size="24" text-anchor="middle">${sign}</text>`;
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        list.forEach((p, idx) => {
            let row = Math.floor(idx/2); let col = idx % 2;
            let isU = (p.rIdx === EX_SIGNS[p.name]);
            let isD = (p.rIdx === DB_SIGNS[p.name]);
            let mark = isU ? "(U)" : (isD ? "(N)" : "");
            let color = isU ? "#16a34a" : (isD ? "#dc2626" : "#333");
            svg += `<text x="${x+(col?35:-35)}" y="${y-(row?25:45)}" font-size="13" font-weight="bold" fill="${color}" text-anchor="middle">${p.name}${mark}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf; 
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], {scale: 2});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("AstroReport_Full.pdf");
}
</script>
</body>
</html>
