<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>HORA ASTRO SUPREME V60.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --main-red: #8b0000; --gold: #d4af37; }
        body { background: #0f172a; color: white; font-family: 'Arial', sans-serif; padding: 10px; }
        .setup-box { background: #1e293b; padding: 20px; border-radius: 12px; max-width: 900px; margin: auto; border: 1px solid var(--gold); }
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        input { padding: 12px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; }
        
        .report-paper { background: white; color: black; padding: 30px; width: 800px; margin: 20px auto; border: 8px double var(--main-red); display: none; }
        .chart-flex { display: flex; gap: 20px; justify-content: center; margin: 20px 0; }
        .svg-container { border: 2px solid var(--main-red); padding: 10px; background: #fff; width: 350px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background: #f8fafc; color: var(--main-red); }
        
        .btn-calc { background: var(--gold); color: black; font-weight: bold; padding: 15px; width: 100%; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn-pdf { background: #16a34a; color: white; padding: 15px; width: 800px; margin: 10px auto; display: none; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        #city-results { position: absolute; background: white; color: black; width: 250px; z-index: 100; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="setup-box">
    <h2 align="center" style="color:var(--gold); margin-top:0;">üïâÔ∏è HORA ASTRO SUPREME (PRO)</h2>
    <div class="input-row">
        <input type="text" id="uname" placeholder="‡§ú‡§æ‡§§‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ" value="Hemant Purohit">
        <div style="position:relative">
            <input type="text" id="city" placeholder="‡§∂‡§π‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç (Banswara...)" oninput="searchLocation(this.value)" style="width:100%">
            <div id="city-results"></div>
        </div>
        <input type="date" id="udate" value="2006-11-06">
        <input type="time" id="utime" value="11:28">
    </div>
    <input type="hidden" id="lat"><input type="hidden" id="lng">
    <button class="btn-calc" onclick="generateKundli()">‡§™‡•Ç‡§∞‡•ç‡§£ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§è‡§µ‡§Ç ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
</div>

<div id="report-area" class="report-paper">
    <h1 align="center" style="color:var(--main-red); margin-bottom:0;">‡•• ‡§ú‡§®‡•ç‡§Æ ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ ‡••</h1>
    <p align="center" id="panchang-text" style="font-weight:bold; color:#555;"></p>
    
    <div class="chart-flex">
        <div class="svg-container">
            <h4 align="center">‡§≤‡§ó‡•ç‡§® ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D1)</h4>
            <div id="d1-chart"></div>
        </div>
        <div class="svg-container">
            <h4 align="center">‡§®‡§µ‡§æ‡§Ç‡§∂ ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D9)</h4>
            <div id="d9-chart"></div>
        </div>
    </div>

    <table id="planet-table"></table>

    <div style="margin-top:20px; padding:15px; border-left:5px solid var(--gold); background:#fffbeb;">
        <h3>‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§´‡§≤‡§æ‡§¶‡•á‡§∂ ‡§è‡§µ‡§Ç ‡§¶‡•É‡§∑‡•ç‡§ü‡§ø ‡§¨‡§≤:</h3>
        <ul id="predictions-list" style="line-height:1.6;"></ul>
    </div>
</div>

<button id="pdf-trigger" class="btn-pdf" onclick="downloadPDF()">üì• ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä PDF ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</button>

<script>
    // 1. ‡§∂‡§π‡§∞ ‡§ñ‡•ã‡§ú ‡§ï‡•á ‡§≤‡§ø‡§è Nominatim API
    async function searchLocation(q) {
        if(q.length < 3) return;
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const data = await resp.json();
        let html = '';
        data.slice(0,5).forEach(item => {
            html += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer" onclick="selectCity('${item.display_name}', ${item.lat}, ${item.lon})">${item.display_name}</div>`;
        });
        document.getElementById('city-results').innerHTML = html;
    }

    function selectCity(name, lat, lon) {
        document.getElementById('city').value = name;
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lon;
        document.getElementById('city-results').innerHTML = '';
    }

    // 2. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ó‡§£‡§®‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (‡§π‡•á‡§Æ‡§Ç‡§§ ‡§ú‡•Ä ‡§ï‡§æ URL ‡§Ø‡§π‡§æ‡§Å ‡§π‡•à)
    async function generateKundli() {
        const lat = document.getElementById('lat').value;
        if(!lat) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!"); return; }

        // ‡§Ü‡§™‡§ï‡§æ PythonAnywhere URL
        const baseUrl = "https://hemantpurohit27.pythonanywhere.com/api/v60_engine";
        const params = `?name=${document.getElementById('uname').value}&date=${document.getElementById('udate').value}&time=${document.getElementById('utime').value}&lat=${lat}&lng=${document.getElementById('lng').value}`;
        
        try {
            const response = await fetch(baseUrl + params);
            const data = await response.json();

            document.getElementById('report-area').style.display = 'block';
            document.getElementById('pdf-trigger').style.display = 'block';

            // ‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó ‡§î‡§∞ ‡§®‡§æ‡§Æ
            document.getElementById('panchang-text').innerText = `‡§®‡§æ‡§Æ: ${document.getElementById('uname').value} | ‡§∏‡§Ç‡§µ‡§§: 2063 | ‡§Æ‡§æ‡§π: ${data.panchang.month} | ‡§§‡§ø‡§•‡§ø: ${data.panchang.tithi} | ‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞: ${data.panchang.nakshatra}`;

            // ‡§ö‡§æ‡§∞‡•ç‡§ü ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó
            drawNorthChart("d1-chart", data.asc, data.planets);
            drawNorthChart("d9-chart", 8, data.planets); // D9 ‡§µ‡•É‡§∂‡•ç‡§ö‡§ø‡§ï ‡§≤‡§ó‡•ç‡§® ‡§™‡§∞ ‡§∏‡•ç‡§•‡§ø‡§∞

            // ‡§ó‡•ç‡§∞‡§π ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ
            let pTable = `<tr><th>‡§ó‡•ç‡§∞‡§π</th><th>‡§∞‡§æ‡§∂‡§ø</th><th>‡§Ö‡§Ç‡§∂</th><th>‡§≠‡§æ‡§µ</th></tr>`;
            data.planets.forEach(p => {
                pTable += `<tr><td>${p.name}</td><td>${p.sign}</td><td>${p.deg}¬∞</td><td>${p.house}</td></tr>`;
            });
            document.getElementById('planet-table').innerHTML = pTable;

            // ‡§´‡§≤‡§æ‡§¶‡•á‡§∂
            let pList = "";
            data.predictions.forEach(p => pList += `<li>${p}</li>`);
            document.getElementById('predictions-list').innerHTML = pList;

        } catch (error) {
            alert("API ‡§∏‡•á ‡§ú‡•Å‡•ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§ï‡§ø PythonAnywhere ‡§™‡§∞ 'app.py' ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
        }
    }

    function drawNorthChart(id, asc, planets) {
        const h = {1:[175,120], 2:[85,60], 3:[50,120], 4:[125,200], 5:[50,280], 6:[85,340], 7:[175,280], 8:[265,340], 9:[350,280], 10:[225,200], 11:[350,120], 12:[265,60]};
        let svg = `<svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 0 L400 400 M400 0 L0 400 M200 0 L0 200 L200 400 L400 200 Z" fill="none" stroke="#8b0000" stroke-width="2.5"/>`;
        
        for(let i=1; i<=12; i++) {
            let r_num = ((asc + i - 2) % 12) + 1;
            svg += `<text x="${h[i][0]}" y="${h[i][1]}" fill="red" font-weight="bold" font-size="18" text-anchor="middle">${r_num}</text>`;
            let p_names = planets.filter(p => p.house === i).map(p => p.name).join(' ');
            svg += `<text x="${h[i][0]}" y="${h[i][1]+25}" fill="#000" font-size="13" font-weight="bold" text-anchor="middle">${p_names}</text>`;
        }
        document.getElementById(id).innerHTML = svg + `</svg>`;
    }

    async function downloadPDF() {
        const doc = new jspdf.jsPDF('p', 'mm', 'a4');
        const element = document.getElementById('report-area');
        
        const canvas = await html2canvas(element, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save(`${document.getElementById('uname').value}_Kundli_V60.pdf`);
    }
</script>
</body>
</html>
