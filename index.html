<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Astro Professional Workstation V220</title>
    <style>
        :root { --gold: #f59e0b; --maroon: #7c2d12; --dark: #020617; }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .workstation { max-width: 1300px; margin: auto; }
        
        /* Input Panel */
        .input-bar { background: #1e293b; padding: 20px; border-radius: 12px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; border-bottom: 4px solid var(--gold); }
        input { padding: 10px; border-radius: 6px; border: none; font-size: 14px; }
        button { background: var(--gold); color: black; font-weight: bold; border: none; padding: 10px 30px; border-radius: 6px; cursor: pointer; }
        
        /* Layout Grid */
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 25px; }
        .section-box { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
        
        /* Charts Area */
        .chart-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .chart-card { flex: 1; background: white; color: black; padding: 10px; border-radius: 8px; text-align: center; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { background: var(--maroon); color: white; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #334155; font-weight: bold; color: #cbd5e1; }
        .dasha-hl { color: var(--gold); font-size: 18px; }
        #locSug { position: absolute; background: white; color: black; width: 250px; border-radius: 4px; z-index: 100; }
    </style>
</head>
<body>

<div class="workstation">
    <div class="input-bar">
        <input type="text" id="uName" placeholder="नाम लिखें" value="Hemant Purohit">
        <div style="position:relative;">
            <input type="text" id="uCity" placeholder="शहर सर्च करें..." oninput="getLoc()">
            <div id="locSug"></div>
        </div>
        <input type="date" id="uDate" value="1980-03-27">
        <input type="time" id="uTime" value="08:10">
        <button onclick="calculateAll()">सॉफ्टवेयर लोड करें</button>
    </div>

    <div id="outputUI" style="display:none;">
        <div class="main-grid">
            <div>
                <div class="section-box" style="margin-bottom:20px;">
                    <h3 style="margin-top:0; color:var(--gold);">॥ पंच-तत्व पंचांग व विवरण ॥</h3>
                    <div id="panInfo" style="display:flex; gap:30px; font-size:16px;"></div>
                </div>

                <div class="chart-row">
                    <div class="chart-card">
                        <strong style="color:var(--maroon)">D1 - जन्म कुंडली (Lahiri)</strong>
                        <div id="d1Draw"></div>
                    </div>
                    <div class="chart-card">
                        <strong style="color:var(--maroon)">D9 - नवमांश कुंडली</strong>
                        <div id="d9Draw"></div>
                    </div>
                </div>

                <div class="section-box">
                    <h3 style="color:var(--gold);">निरयण ग्रह स्पष्ट (KP / Sidereal Table)</h3>
                    <table>
                        <thead>
                            <tr><th>ग्रह</th><th>राशि सं.</th><th>अंश - कला - विकला</th></tr>
                        </thead>
                        <tbody id="planetTable"></tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="section-box" style="margin-bottom:20px;">
                    <h3 style="color:var(--gold);">विंशोत्तरी महादशा</h3>
                    <p>वर्तमान महादशा स्वामी:</p>
                    <div class="dasha-hl" id="dashaOwner"></div>
                </div>

                <div class="section-box">
                    <h3 style="color:var(--gold);">भाव चलित (Cusp) विवरण</h3>
                    <div id="cuspInfo" style="font-size:12px; line-height:1.8;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let lat = 24.58, lng = 73.71;

    async function getLoc() {
        const q = document.getElementById('uCity').value;
        if(q.length < 3) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const data = await res.json();
        const box = document.getElementById('locSug'); box.innerHTML = "";
        data.forEach(i => {
            let d = document.createElement('div'); d.style.padding="8px"; d.style.cursor="pointer"; d.style.borderBottom="1px solid #eee";
            d.innerText = i.display_name;
            d.onclick = () => { lat=i.lat; lng=i.lon; document.getElementById('uCity').value=i.display_name.split(',')[0]; box.innerHTML=""; };
            b.appendChild(d); // Note: Fix 'b' to 'box' below
            box.appendChild(d);
        });
    }

    async function calculateAll() {
        const url = `https://hemantpurohit27.pythonanywhere.com/api/v220?date=${document.getElementById('uDate').value}&time=${document.getElementById('uTime').value}&lat=${lat}&lng=${lng}`;
        const res = await fetch(url);
        const data = await res.json();
        
        document.getElementById('outputUI').style.display = "block";
        
        // Panchang
        document.getElementById('panInfo').innerHTML = `<span><b>तिथि:</b> ${data.panchang.tithi}</span> | <span><b>स्थान:</b> ${document.getElementById('uCity').value}</span>`;
        
        // Planet Table
        let rows = "";
        data.planets.forEach(p => {
            rows += `<tr><td style="color:var(--gold)">${p.name}</td><td>${p.d1}</td><td>${p.deg_str}</td></tr>`;
        });
        document.getElementById('planetTable').innerHTML = rows;

        // Dasha
        document.getElementById('dashaOwner').innerText = data.dasha;

        // Cusp Info
        let cText = ""; data.panchang.bhava.forEach((v, i) => { cText += `भाव ${i+1}: ${Math.floor(v/30)}° ${Math.floor(v%30)}'<br>`; });
        document.getElementById('cuspInfo').innerHTML = cText;

        // Charts
        renderKundli("d1Draw", data.asc, data.planets, "d1");
        renderKundli("d9Draw", data.asc_d9, data.planets, "d9");
    }

    function renderKundli(id, asc, planets, key) {
        const h = {1:[175,130], 2:[85,60], 3:[40,130], 4:[115,215], 5:[40,290], 6:[85,360], 7:[175,290], 8:[265,360], 9:[310,290], 10:[225,215], 11:[310,130], 12:[265,60]};
        let svg = `<svg viewBox="0 0 350 350" width="100%"><path d="M0 0 L350 350 M350 0 L0 350 M175 0 L0 175 L175 350 L350 175 Z" fill="none" stroke="#7c2d12" stroke-width="2.5"/>`;
        for (let i = 1; i <= 12; i++) {
            let s = ((asc + i - 2) % 12) + 1;
            svg += `<text x="${h[i][0]}" y="${h[i][1]}" fill="#7c2d12" font-weight="bold" font-size="22" text-anchor="middle">${s}</text>`;
            planets.filter(pl => pl[key] === s).forEach((pl, idx) => {
                svg += `<text x="${h[i][0]}" y="${h[i][1] + 25 + (idx*16)}" fill="#1e40af" font-size="12" font-weight="bold" text-anchor="middle">${pl.name}</text>`;
            });
        }
        document.getElementById(id).innerHTML = svg + `</svg>`;
    }
</script>
</body>
</html>
