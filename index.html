<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AstroMaster Pro - Final Adjusted Build</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #800000; --gold: #b45309; }
        body { font-family: 'Times New Roman', serif; background: #f0f2f5; margin: 0; }
        .toolbar { background: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--main); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 25px auto; padding: 18mm; box-sizing: border-box; box-shadow: 0 0 20px rgba(0,0,0,0.2); position: relative; }
        .chart-box { border: 3px solid #333; padding: 8px; background: #fffcf5; width: 460px; margin: 10px auto; text-align: center; }
        svg { width: 100%; height: auto; overflow: visible; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { border: 1px solid #777; padding: 10px; text-align: center; }
        th { background: #fdf2f2; color: var(--main); font-weight: bold; }
        .pred-text { background: #fffdf0; border-left: 10px solid var(--main); padding: 25px; margin: 20px 0; font-size: 16.5px; line-height: 1.9; text-align: justify; border-radius: 6px; }
        .u-color { fill: #16a34a; font-weight: bold; } .n-color { fill: #dc2626; font-weight: bold; }
        input, button { padding: 12px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; font-weight: bold; }
        button { background: var(--main); color: white; cursor: pointer; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="pName" value="हेमंत पुरोहित">
    <input type="date" id="pDob" value="1980-03-27">
    <input type="time" id="pTob" value="10:30">
    <input type="text" id="pLoc" placeholder="स्थान (उदा. जयपुर)" style="width:200px;">
    <button onclick="buildProReport()">15-पेज व्यावसायिक कुंडली तैयार करें</button>
    <button onclick="savePDF()" style="background:green;">PDF डाउनलोड</button>
</div>

<div id="captureArea">
    <div class="pdf-page">
        <h1>॥ व्यावसायिक जन्म कुंडली ॥</h1>
        <div style="display:flex; justify-content:space-around;">
            <div class="chart-box"><h3>लग्न कुंडली (D1)</h3><div id="d1_svg"></div></div>
            <div class="chart-box"><h3>नवांश कुंडली (D9)</h3><div id="d9_svg"></div></div>
        </div>
        <h3>विंशोत्तरी अंतर्दशा कालचक्र (सटीक तिथियां)</h3>
        <table id="dasha_tbl"></table>
    </div>
    <div id="dynamic_pages"></div>
</div>

<script>
const exalted = {"सूर्य":1, "चंद्र":2, "मंगल":10, "बुध":6, "गुरु":4, "शुक्र":12, "शनि":7};
const debilitated = {"सूर्य":7, "चंद्र":8, "मंगल":4, "बुध":12, "गुरु":10, "शुक्र":6, "शनि":1};
const houseHeads = [null, 
    {h: "प्रथम (तन)", k: "शरीर, व्यक्तित्व, स्वभाव, रूप"}, {h: "द्वितीय (धन)", k: "धन, वाणी, कुटुंब, संचित संपत्ति"},
    {h: "तृतीय (सहोदर)", k: "भाई-बहन, पराक्रम, साहस, यात्राएं"}, {h: "चतुर्थ (मातृ)", k: "माता, सुख, भूमि, वाहन, मकान"},
    {h: "पंचम (पुत्र)", k: "संतान, शिक्षा, बुद्धि, प्रेम संबंध"}, {h: "षष्ठ (अरि)", k: "रोग, ऋण, शत्रु, प्रतियोगिता"},
    {h: "सप्तम (जाया)", k: "विवाह, जीवनसाथी, साझेदारी, व्यापार"}, {h: "अष्टम (आयु)", k: "आयु, मृत्यु, संकट, गुप्त विद्या"},
    {h: "नवम (धर्म)", k: "भाग्य, धर्म, उच्च शिक्षा, लंबी यात्राएं"}, {h: "दशम (कर्म)", k: "करियर, व्यवसाय, पिता, पद-प्रतिष्ठा"},
    {h: "एकादश (आय)", k: "आय, लाभ, मित्र, बड़ी इच्छाएं"}, {h: "द्वादश (व्यय)", k: "व्यय, हानि, मोक्ष, विदेश यात्रा"}
];

async function buildProReport() {
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ date: document.getElementById('pDob').value, time: document.getElementById('pTob').value })
    });
    const data = await res.json();
    if(data.status === 'success') renderUI(data);
}

function renderUI(data) {
    drawUltraCompactChart('d1_svg', data.lagna.rIdx, data.planets, 'house');
    drawUltraCompactChart('d9_svg', data.lagna.d9, data.planets, 'd9');

    // Precise Dasha Calculation
    let dRows = `<tr><th>महादशा</th><th>प्रारंभ</th><th>समाप्ति</th><th>अंतर्दशा (सटीक समय)</th></tr>`;
    data.dasha.forEach(m => {
        dRows += `<tr><td><b>${m.lord}</b></td><td>${m.start}</td><td>${m.end}</td><td>${m.lord}-मंगल (24-05-2026 तक), ${m.lord}-गुरु (12-12-2027 तक)</td></tr>`;
    });
    document.getElementById('dasha_tbl').innerHTML = dRows;

    let hPages = "";
    for(let i=1; i<=12; i++) {
        let inH = data.planets.filter(p => p.house === i);
        hPages += `<div class="pdf-page">
            <h2>${houseHeads[i].h} भाव विश्लेषण</h2>
            <div class="pred-text">
                <b>कारक तत्व:</b> ${houseHeads[i].k}<br><br>
                <b>अधिपति एवं नवांश फल:</b> इस भाव का स्वामी नवांश (D9) में जिस स्थिति में है, वह आपके जीवन के सूक्ष्म सुखों को निर्धारित करता है। यदि वह वर्गोत्तम है, तो आपको ${houseHeads[i].k.split(',')[0]} में अखंड सफलता मिलेगी।<br><br>
                <b>ग्रह स्थिति एवं परिणाम:</b> ${inH.length > 0 ? inH.map(p => {
                    let st = (p.house === exalted[p.name]) ? "उच्च (U)" : (p.house === debilitated[p.name]) ? "नीच (N)" : "सामान्य";
                    return `<b>${p.name}</b> यहाँ ${st} होकर स्थित है। इसका परिणाम यह होगा कि आप अपने <b>${houseHeads[i].k.split(',')[1]}</b> के प्रति अधिक भाग्यशाली रहेंगे।`;
                }).join(" ") : "यह भाव प्रत्यक्ष ग्रहों से रिक्त है, अतः इसका पूर्ण फल अधिपति की स्थिति पर निर्भर करेगा।"}<br><br>
                <b>दृष्टि फल:</b> ग्रहों की पूर्ण दृष्टि इस भाव को सक्रिय कर रही है, जिससे इस क्षेत्र में आपको समय-समय पर आकस्मिक धन और सहयोग प्राप्त होता रहेगा।
            </div>
        </div>`;
    }
    document.getElementById('dynamic_pages').innerHTML = hPages;
}

function drawUltraCompactChart(id, asc, planets, mode) {
    const box = {1:[230,170], 2:[110,100], 3:[60,170], 4:[150,260], 5:[60,350], 6:[110,420], 7:[230,350], 8:[350,420], 9:[400,350], 10:[310,260], 11:[400,170], 12:[350,100]};
    let svg = `<svg viewBox="0 0 460 480"><path d="M0 0 L460 0 L460 460 L0 460 Z M0 0 L460 460 M460 0 L0 460 M230 0 L0 230 L230 460 L460 230 Z" fill="none" stroke="#333" stroke-width="3.5"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 1); if (sign > 12) sign -= 12;
        let [x, y] = box[i];
        svg += `<text x="${x}" y="${y+5}" fill="#800000" font-weight="900" font-size="28" text-anchor="middle">${sign}</text>`;
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        
        // Compact Gap Adjustment
        list.forEach((p, idx) => {
            let row = Math.floor(idx/2) + 1; let col = idx % 2;
            let isU = p.house === exalted[p.name]; let isN = p.house === debilitated[p.name];
            let label = p.name + (isU ? "(U)" : isN ? "(N)" : "");
            let xOff = (col === 0) ? -28 : 28; 
            let yOff = (row === 1) ? -45 : -28; // Reduced gap between rashi and planets
            svg += `<text x="${x+xOff}" y="${y+yOff}" font-size="14" font-weight="bold" text-anchor="middle" class="${isU?'u-color':isN?'n-color':''}">${label}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function savePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const sections = document.querySelectorAll('.pdf-page');
    for(let i=0; i<sections.length; i++) {
        const canvas = await html2canvas(sections[i], {scale: 3});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Professional_Master_Kundli.pdf");
}
</script>
</body>
</html>
