<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>ASTRO PRO V55.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --gold: #d4af37; --bg: #0f172a; }
        body { background: var(--bg); color: white; font-family: 'Arial', sans-serif; padding: 20px; }
        .main-card { max-width: 850px; margin: auto; background: white; color: black; padding: 30px; border-radius: 10px; }
        .input-section { background: #1e293b; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .btn-main { background: var(--gold); border: none; padding: 12px; font-weight: bold; cursor: pointer; grid-column: 1/-1; }
        
        .panchang-ribbon { display: flex; justify-content: space-around; background: #fef3c7; padding: 10px; border: 1px solid var(--gold); margin-bottom: 20px; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .svg-box { border: 2px solid #000; padding: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f1f5f9; }
    </style>
</head>
<body>

<div class="input-section">
    <input type="text" id="uname" placeholder="‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç">
    <input type="text" id="city" placeholder="‡§∂‡§π‡§∞ (‡§â‡§¶‡§æ. Banswara)" oninput="searchLoc(this.value)">
    <input type="date" id="udate" value="2006-11-06">
    <input type="time" id="utime" value="11:28">
    <input type="hidden" id="lat"><input type="hidden" id="lng">
    <button class="btn-main" onclick="loadData()">‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
    <div id="city-list" style="position:absolute; background:white; color:black;"></div>
</div>

<div id="capture-area" class="main-card" style="display:none">
    <h2 align="center" style="color:#b45309; margin-top:0;">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</h2>
    <div class="panchang-ribbon" id="pan-ui"></div>

    <div class="chart-grid">
        <div class="svg-box">
            <h4 align="center">‡§≤‡§ó‡•ç‡§® ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D1)</h4>
            <div id="d1-chart"></div>
        </div>
        <div class="svg-box">
            <h4 align="center">‡§®‡§µ‡§æ‡§Ç‡§∂ ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D9)</h4>
            <div id="d9-chart"></div>
        </div>
    </div>

    <table id="p-table"></table>

    <div style="margin-top:20px; font-size:12px; border-top:1px solid #eee; padding-top:10px;">
        <b>‡§´‡§≤‡§æ‡§¶‡•á‡§∂:</b> ‡§ó‡•Å‡§∞‡•Å ‡§ï‡§æ 12‡§µ‡•á‡§Ç ‡§≠‡§æ‡§µ ‡§Æ‡•á‡§Ç ‡§π‡•ã‡§®‡§æ ‡§Ü‡§ß‡•ç‡§Ø‡§æ‡§§‡•ç‡§Æ‡§ø‡§ï ‡§ù‡•Å‡§ï‡§æ‡§µ ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§ ‡§∂‡•Å‡§ï‡•ç‡§∞ 11‡§µ‡•á‡§Ç ‡§≠‡§æ‡§µ ‡§Æ‡•á‡§Ç ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§∏‡§Æ‡•É‡§¶‡•ç‡§ß‡§ø ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
    </div>
</div>

<button id="pdf-btn" style="display:none; width:100%; max-width:850px; margin:20px auto; display:block; padding:15px; background:green; color:white; border:none; border-radius:10px; cursor:pointer;" onclick="downloadPDF()">üì• ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</button>

<script>
    async function searchLoc(q) {
        if(q.length < 3) return;
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const data = await r.json();
        let h = '';
        data.slice(0,3).forEach(i => h += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer" onclick="setLoc('${i.display_name}',${i.lat},${i.lon})">${i.display_name}</div>`);
        document.getElementById('city-list').innerHTML = h;
    }

    function setLoc(n, la, lo) {
        document.getElementById('city').value = n;
        document.getElementById('lat').value = la; document.getElementById('lng').value = lo;
        document.getElementById('city-list').innerHTML = '';
    }

    async function loadData() {
        if(!document.getElementById('lat').value) { alert("‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!"); return; }
        
        const url = `https://hemantpurohit27.pythonanywhere.com/api/v55_final?name=${document.getElementById('uname').value}&date=${document.getElementById('udate').value}&time=${document.getElementById('utime').value}&lat=${document.getElementById('lat').value}&lng=${document.getElementById('lng').value}`;
        const res = await fetch(url);
        const d = await res.json();

        document.getElementById('capture-area').style.display = 'block';
        document.getElementById('pdf-btn').style.display = 'block';

        document.getElementById('pan-ui').innerHTML = `<span>‡§®‡§æ‡§Æ: ${d.name}</span> | <span>‡§Æ‡§æ‡§π: ${d.panchang.month}</span> | <span>‡§§‡§ø‡§•‡§ø: ${d.panchang.tithi}</span> | <span>‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞: ${d.panchang.nak}</span>`;

        document.getElementById('d1-chart').innerHTML = drawChart(d.asc, d.planets);
        document.getElementById('d9-chart').innerHTML = drawChart(8, d.planets);

        let thtml = `<tr><th>‡§ó‡•ç‡§∞‡§π</th><th>‡§Ö‡§Ç‡§∂</th><th>‡§≠‡§æ‡§µ</th></tr>`;
        d.planets.forEach(p => thtml += `<tr><td>${p.name}</td><td>${p.deg}¬∞</td><td>${p.house}</td></tr>`);
        document.getElementById('p-table').innerHTML = thtml;
    }

    function drawChart(asc, planets) {
        const c = {1:[150,100], 2:[75,50], 3:[50,75], 4:[100,150], 5:[50,225], 6:[75,250], 7:[150,200], 8:[225,250], 9:[250,225], 10:[200,150], 11:[250,75], 12:[225,50]};
        let svg = `<svg viewBox="0 0 300 300" style="width:100%"><path d="M0 0 L300 300 M300 0 L0 300 M150 0 L0 150 L150 300 L300 150 Z" stroke="black" fill="none" stroke-width="1.5"/>`;
        for(let i=1; i<=12; i++) {
            let s = ((asc + i - 2) % 12) + 1;
            svg += `<text x="${c[i][0]}" y="${c[i][1]}" fill="red" font-weight="bold" text-anchor="middle" font-size="14">${s}</text>`;
            let p_names = planets.filter(p => p.house === i).map(p => p.name).join(' ');
            svg += `<text x="${c[i][0]}" y="${c[i][1]+18}" fill="blue" font-size="10" text-anchor="middle">${p_names}</text>`;
        }
        return svg + `</svg>`;
    }

    function downloadPDF() {
        const element = document.getElementById('capture-area');
        const opt = {
            margin: 10,
            filename: `${document.getElementById('uname').value}_Kundli.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>
</body>
</html>
