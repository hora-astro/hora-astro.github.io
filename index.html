<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Professional Astro Software</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #daa520; }
        body { font-family: 'Segoe UI', sans-serif; background: #fdf2f2; padding: 20px; }
        .input-card { background: white; padding: 20px; border-radius: 12px; max-width: 850px; margin: auto; border-bottom: 5px solid var(--maroon); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px; }
        input, button { padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        button { background: var(--maroon); color: white; border: none; font-weight: bold; cursor: pointer; }
        .chart-box { border: 2px solid var(--maroon); background: white; padding: 10px; text-align: center; }
        .status-ex { color: #1a73e8; font-weight: bold; }
        .status-db { color: #d93025; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background: #800000; color: white; }
        .prediction-box { background: #fffde7; border-left: 5px solid #ffd600; padding: 20px; margin-top: 20px; font-size: 16px; line-height: 1.8; }
    </style>
</head>
<body>

<div class="input-card">
    <h2 style="text-align:center; color:var(--maroon); margin-top:0;">॥ भाग्य विधाता एस्ट्रो सॉफ्टवेयर ॥</h2>
    <div class="grid-inputs">
        <input type="text" id="custName" value="हेमंत पुरोहित" placeholder="नाम">
        <input type="date" id="dob" value="1980-03-27">
        <input type="time" id="tob" value="10:30">
        <input type="text" id="lat" value="23.54" placeholder="Lat">
        <input type="text" id="lon" value="74.47" placeholder="Lon">
        <button onclick="generateKundli()">जेनरेट करें</button>
    </div>
</div>

<div id="report-area" style="display:none; max-width:950px; margin: 40px auto;">
    <div id="capture-section" style="background:white; padding:30px; border:1px solid #ddd;">
        <h2 id="out-title" style="text-align:center; color:var(--maroon);"></h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div class="chart-box"><h3>D1 लग्न कुंडली</h3><div id="d1-svg"></div></div>
            <div class="chart-box"><h3>D9 नवांश कुंडली</h3><div id="d9-svg"></div></div>
        </div>
        <table id="p-table">
            <thead><tr><th>ग्रह</th><th>अंश</th><th>भाव</th><th>राशि</th><th>स्थिति</th></tr></thead>
            <tbody></tbody>
        </table>
        <div id="predictions" class="prediction-box"></div>
    </div>
    <button onclick="downloadPDF()" style="width:100%; padding:15px; margin-top:10px; background:green; color:white; border:none; border-radius:6px; font-size:16px;">PDF डाउनलोड करें</button>
</div>

<script>
const LAGNA_CONTENT = {
    1: { swami: "मंगल", फल: "मेष लग्न के लिए मंगल, सूर्य और गुरु अत्यंत शुभ फलदायी होते हैं। शुक्र और बुध मारक बन सकते हैं।" },
    2: { swami: "शुक्र", फल: "वृष लग्न में शनि योगकारक होकर राजयोग देता है। शुक्र और बुध भी शुभ फल देते हैं।" },
    3: { swami: "बुध", फल: "मिथुन लग्न के लिए शुक्र और शनि मित्र हैं। मंगल इस लग्न के लिए शुभ नहीं माना जाता।" },
    4: { swami: "चंद्र", फल: "कर्क लग्न में मंगल योगकारक है। गुरु और चंद्र भी शुभ फल प्रदान करते हैं।" },
    5: { swami: "सूर्य", फल: "सिंह लग्न के लिए मंगल और सूर्य श्रेष्ठ हैं। शनि और शुक्र यहाँ मारक हो सकते हैं।" },
    6: { swami: "बुध", फल: "कन्या लग्न में शुक्र और बुध की युति राजयोग बनाती है। मंगल अशुभ फल देता है।" },
    7: { swami: "शुक्र", फल: "तुला लग्न के लिए शनि परम योगकारक है। बुध और शुक्र भी समृद्धि देते हैं।" },
    8: { swami: "मंगल", फल: "वृश्चिक लग्न के लिए चंद्र और गुरु अत्यंत शुभ हैं। मंगल लग्नेश होकर उन्नति देता है।" },
    9: { swami: "गुरु", फल: "धनु लग्न के लिए सूर्य और मंगल राजयोग कारक हैं। गुरु स्वयं शुभ फल देता है।" },
    10: { swami: "शनि", फल: "मकर लग्न के लिए शुक्र सबसे बड़ा मित्र है। बुध भी अनुकूल फल देता है।" },
    11: { swami: "शनि", फल: "कुम्भ लग्न के लिए शुक्र और बुध शुभ हैं। लग्नेश शनि स्वयं उन्नति देता है।" },
    12: { swami: "गुरु", फल: "मीन लग्न के लिए मंगल और चंद्र अत्यंत शुभ हैं। गुरु लग्नेश होकर ज्ञान देता है।" }
};

async function generateKundli() {
    const btn = document.querySelector("button");
    btn.innerText = "गणना चालू है...";
    
    try {
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                date: document.getElementById('dob').value,
                time: document.getElementById('tob').value,
                lat: document.getElementById('lat').value,
                lon: document.getElementById('lon').value
            })
        });
        const data = await res.json();
        if(data.status === 'success') {
            document.getElementById('out-title').innerText = "नाम: " + document.getElementById('custName').value + " | लग्न: " + data.lagna.name;
            renderAll(data);
        }
    } catch(e) { 
        alert("कनेक्शन फेल! कृपया PythonAnywhere सर्वर को 'Reload' करें।"); 
    } finally { btn.innerText = "जेनरेट करें"; }
}

function renderAll(data) {
    let html = "";
    data.planets.forEach(p => {
        let cls = p.status === "उच्च" ? "status-ex" : (p.status === "नीच" ? "status-db" : "");
        html += `<tr><td>${p.name}</td><td>${p.deg}</td><td>${p.house}</td><td>${p.sign}</td><td class="${cls}">${p.status}</td></tr>`;
    });
    document.querySelector("#p-table tbody").innerHTML = html;

    const info = LAGNA_CONTENT[data.lagna.idx];
    document.getElementById('predictions').innerHTML = `<h3>${data.lagna.name} लग्न फलादेश (FortuneWithStars)</h3><p><b>स्वामी:</b> ${info.swami}</p><p>${info.फल}</p>`;

    drawChart("d1-svg", data.lagna.idx, data.planets, 'house');
    drawChart("d9-svg", data.planets[0].d9, data.planets, 'd9');
    document.getElementById('report-area').style.display = 'block';
}

function drawChart(id, asc, planets, mode) {
    const coords = {1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]};
    let svg = `<svg viewBox="0 0 450 480" width="100%"><path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#333" stroke-width="2"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]+5}" fill="maroon" font-weight="bold" font-size="22" text-anchor="middle">${sign}</text>`;
        let inH = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        inH.forEach((p, idx) => { svg += `<text x="${coords[i][0]}" y="${coords[i][1]-20-(idx*15)}" font-size="12" text-anchor="middle" fill="#444">${p.name}</text>`; });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.getElementById('capture-section'), {scale: 2});
    const doc = new jsPDF('p', 'mm', 'a4');
    doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    doc.save("Kundli_Report.pdf");
}
</script>
</body>
</html>
