<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Advanced Vedic Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Arial'; background: #333; margin: 0; }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 20px auto; padding: 20mm; border: 1px solid #000; box-sizing: border-box; }
        .chart-box { display: flex; justify-content: space-around; margin: 30px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #800000; padding: 10px; text-align: center; font-size: 14px; }
        th { background: #800000; color: white; }
        .pred-section { margin-bottom: 40px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .status-high { color: green; font-weight: bold; border: 1px solid green; padding: 2px; }
        .status-low { color: red; font-weight: bold; border: 1px solid red; padding: 2px; }
        .own-sign { color: blue; font-weight: bold; }
    </style>
</head>
<body>

<div style="background:#1a1a1a; padding:20px; text-align:center;">
    <input type="date" id="dob" value="1995-05-15">
    <input type="time" id="tob" value="10:30">
    <button onclick="generate()" style="padding:10px 20px; background:gold; border:none; cursor:pointer; font-weight:bold;">कुंडली जेनरेट करें</button>
</div>

<div id="reportArea"></div>

<script>
async function generate() {
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ date: document.getElementById('dob').value, time: document.getElementById('tob').value })
    });
    const d = await res.json();
    if(d.status === 'success') renderUI(d);
}

function renderUI(d) {
    const area = document.getElementById('reportArea');
    area.innerHTML = "";

    // PAGE 1: Charts
    let p1 = `<div class="pdf-page">
        <h1 align="center" style="color:#800000;">॥ जन्म विवरण एवं कुंडलियां ॥</h1>
        <div class="chart-box">
            <div id="d1_chart" style="width:340px;"></div>
            <div id="d9_chart" style="width:340px;"></div>
        </div>
        <table>
            <tr><th>ग्रह</th><th>अंश</th><th>भाव</th><th>अवस्था</th></tr>
            ${d.planets.map(p => `<tr><td>${p.name}</td><td>${p.deg}</td><td>${p.house}</td>
            <td><span class="${p.status==='उच्च'?'status-high':p.status==='नीच'?'status-low':p.status==='स्वराशि'?'own-sign':''}">
            ${p.status}</span></td></tr>`).join('')}
        </table>
    </div>`;
    area.innerHTML += p1;

    // PAGES: विस्तृत फलादेश (प्रत्येक ग्रह का भावेश के अनुसार)
    d.planets.forEach(p => {
        area.innerHTML += `<div class="pdf-page">
            <h2 style="color:#800000; border-bottom: 2px solid #800000;">${p.name} फलादेश विश्लेषण</h2>
            <div class="pred-section">
                <p><b>कारकत्व:</b> ${p.info.karaka} के स्वामी हैं।</p>
                <p><b>भावेश स्थिती:</b> आपकी कुंडली में ${p.name}, भाव संख्या <b>${p.lords.join(' और ')}</b> के स्वामी होकर <b>${p.house}</b> भाव में बैठे हैं।</p>
                <p><b>अवस्था फल:</b> ${p.status === 'उच्च' ? 'ग्रह अपनी सर्वोच्च शक्ति में है, यह राजयोग प्रदान करेगा।' : p.status === 'नीच' ? 'नीच राशि में होने से संबंधित भावों के फल में देरी और संघर्ष रहेगा।' : 'ग्रह सामान्य बल के साथ शुभ फलदायी है।'}</p>
                <p><b>विस्तृत फल:</b> ${p.house} भाव में ${p.name} की उपस्थिति दर्शाती है कि जातक के जीवन में ${p.info.karaka} से जुड़ी चीजें प्रमुखता से रहेंगी। यदि यह ग्रह केंद्र (1,4,7,10) या त्रिकोण (1,5,9) भावों का स्वामी है, तो यह विशेष धन और मान-सम्मान दिलाएगा।</p>
                <p><b>उपाय:</b> ${p.status === 'नीच' ? 'नियमित रूप से दान करें और बीज मंत्र का जप करें।' : 'ग्रह के रत्न को धारण करना या यंत्र पूजा करना शुभ रहेगा।'}</p>
            </div>
        </div>`;
    });

    // PAGES: विंशोत्तरी दशा
    d.dasha.forEach(da => {
        area.innerHTML += `<div class="pdf-page">
            <h2 style="color:#800000;">विंशोत्तरी महादशा: ${da.l}</h2>
            <p><b>अवधि:</b> ${da.s} से ${da.e}</p>
            <table>
                <tr><th>अंतर्दशा स्वामी</th><th>समाप्ति तिथि</th></tr>
                ${da.subs.map(s => `<tr><td>${s.l}</td><td>${s.e}</td></tr>`).join('')}
            </table>
        </div>`;
    });

    drawNorthChart('d1_chart', d.lagna, d.planets, 'house', 'लग्न कुंडली');
    drawNorthChart('d9_chart', d.d9_lagna, d.planets, 'd9', 'नवांश कुंडली');
}

function drawNorthChart(divId, asc, planets, mode, title) {
    const pos = {1:[150,140], 2:[75,60], 3:[35,140], 4:[100,220], 5:[35,300], 6:[75,360], 7:[150,300], 8:[225,360], 9:[265,300], 10:[200,220], 11:[265,140], 12:[225,60]};
    let svg = `<svg viewBox="0 0 300 400" width="100%">
        <text x="150" y="20" text-anchor="middle" font-weight="bold" fill="#800000">${title}</text>
        <path d="M0 40 L300 40 L300 340 L0 340 Z M0 40 L300 340 M300 40 L0 340 M150 40 L0 190 L150 340 L300 190 Z" fill="none" stroke="#800000" stroke-width="2"/>`;
    
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 1) > 12 ? (asc + i - 1) - 12 : (asc + i - 1);
        let [x, y] = pos[i];
        // राशि नंबर - अब बॉक्स के बिल्कुल कोने में या सही स्थान पर
        svg += `<text x="${x}" y="${y}" fill="#800000" font-weight="bold" font-size="14" text-anchor="middle">${sign}</text>`;
        
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        list.forEach((p, idx) => {
            let xOff = (idx % 2 === 0) ? -25 : 25;
            let yOff = Math.floor(idx / 2) * 15 + 15;
            svg += `<text x="${x + xOff}" y="${y + yOff}" font-size="10" text-anchor="middle" fill="#444">${p.name}</text>`;
        });
    }
    document.getElementById(divId).innerHTML = svg + `</svg>`;
}
</script>
</body>
</html>
