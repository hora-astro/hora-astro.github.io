<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AstroMaster Pro - Final Commercial Build</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #800000; --gold: #b45309; }
        body { font-family: 'Georgia', serif; background: #eee; margin: 0; }
        .toolbar { background: white; padding: 15px; border-bottom: 4px solid var(--main); position: sticky; top: 0; z-index: 1000; display: flex; justify-content: center; gap: 10px; }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 15px auto; padding: 15mm; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .panchang-bar { background: #fdf2f2; border: 1.5px solid var(--main); padding: 8px; display: flex; justify-content: space-around; font-weight: bold; margin-bottom: 10px; font-size: 14px; }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .box { border: 2px solid #333; padding: 10px; text-align: center; background: #fffdf5; }
        svg { width: 100%; height: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        th, td { border: 1px solid #777; padding: 6px; text-align: center; }
        th { background: #eee; color: var(--main); }
        .u-clr { fill: #16a34a; font-weight: bold; } .n-clr { fill: #dc2626; font-weight: bold; }
        .report-text { background: #fdfbf0; border-left: 6px solid var(--main); padding: 15px; margin: 15px 0; line-height: 1.6; text-align: justify; border-radius: 4px; }
        input, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; }
        button { background: var(--main); color: white; cursor: pointer; border: none; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="pName" value="हेमंत पुरोहित">
    <input type="date" id="pDob" value="1980-03-27">
    <input type="time" id="pTob" value="10:30">
    <input type="text" id="pLoc" placeholder="जन्म स्थान (उदा. जयपुर)">
    <button onclick="runCalculation()">15-पेज रिपोर्ट जेनरेट करें</button>
    <button onclick="saveAsPDF()" style="background:green;">PDF सेव करें</button>
</div>

<div id="captureArea">
    <div class="pdf-page">
        <h2 style="text-align:center; color:var(--main); margin:0;">॥ विस्तृत व्यावसायिक जन्मपत्रिका ॥</h2>
        <div id="panchang_disp" class="panchang-bar">वार: शुक्रवार | तिथि: शुक्ल पक्ष | नक्षत्र: उत्तराभाद्रपद | योग: सुकर्मा</div>
        
        <div class="chart-row">
            <div class="box"><h3>लग्न कुंडली (D1)</h3><div id="d1_canvas"></div></div>
            <div class="box"><h3>नवांश कुंडली (D9)</h3><div id="d9_canvas"></div></div>
        </div>
        
        <table id="planet_tbl"></table>
    </div>

    <div class="pdf-page">
        <h2 style="border-bottom: 2px solid var(--main);">विंशोत्तरी महादशा एवं समस्त अंतर्दशा (सटीक समय)</h2>
        <table id="dasha_tbl"></table>
    </div>

    <div id="analysis_pages"></div>
</div>

<script>
const naks = ["अश्विनी","भरणी","कृत्तिका","रोहिणी","मृगशिरा","आर्द्रा","पुनर्वसु","पुष्य","अश्लेषा","मघा","पूर्वा फाल्गुनी","उत्तरा फाल्गुनी","हस्त","चित्रा","स्वाती","विशाखा","अनुराधा","ज्येष्ठा","मूल","पूर्वाषाढ़ा","उत्तराषाढ़ा","श्रवण","धनिष्ठा","शतभिषा","पूर्वाभाद्रपद","उत्तराभाद्रपद","रेवती"];
const dOrder = ["केतु","शुक्र","सूर्य","चंद्र","मंगल","राहु","गुरु","शनि","बुध"];
const dYears = {"केतु":7,"शुक्र":20,"सूर्य":6,"चंद्र":10,"मंगल":7,"राहु":18,"गुरु":16,"शनि":19,"बुध":17};

// Planet Standards from images (1).jpeg
const exaltRashi = {"सूर्य":1, "चंद्र":2, "मंगल":10, "बुध":6, "गुरु":4, "शुक्र":12, "शनि":7, "राहु":3, "केतु":9};
const debilRashi = {"सूर्य":7, "चंद्र":8, "मंगल":4, "बुध":12, "गुरु":10, "शुक्र":6, "शनि":1, "राहु":9, "केतु":3};

async function runCalculation() {
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ date: document.getElementById('pDob').value, time: document.getElementById('pTob').value })
    });
    const data = await res.json();
    if(data.status === 'success') renderCompleteSoftware(data);
}

function renderCompleteSoftware(data) {
    // 1. Planet Table with corrected Exaltation/Debilitation
    let pTbl = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>पद</th><th>D9 राशि</th><th>स्थिति</th><th>बल</th></tr>`;
    data.planets.forEach(p => {
        let abs = (p.deg + (p.house-1)*30);
        let nIdx = Math.floor(abs / 13.3333) % 27;
        let pad = Math.floor((abs % 13.3333) / 3.3333) + 1;
        let st = (p.house === exaltRashi[p.name]) ? "उच्च" : (p.house === debilRashi[p.name]) ? "नीच" : "सामान्य";
        pTbl += `<tr><td>${p.name}</td><td>${p.deg.toFixed(2)}°</td><td>${naks[nIdx]}</td><td>${pad}</td><td>${p.d9}</td><td>${st}</td><td>1.4 (बलवान)</td></tr>`;
    });
    document.getElementById('planet_tbl').innerHTML = pTbl;

    // 2. Exact Dasha & Antardasha Dates (Sync with Mahadasha)
    let dTbl = `<tr><th>महादशा</th><th>प्रारंभ</th><th>समाप्ति</th><th>अंतर्दशा विश्लेषण (9 ग्रह)</th></tr>`;
    data.dasha.forEach(m => {
        let mStart = new Date(m.start);
        let sIdx = dOrder.indexOf(m.lord);
        let subFlow = "<div style='display:grid; grid-template-columns:1fr 1fr; gap:5px; text-align:left; font-size:10px;'>";
        for(let i=0; i<9; i++) {
            let sLord = dOrder[(sIdx+i)%9];
            let durationDays = (dYears[m.lord] * dYears[sLord] * 365.25) / 120;
            mStart.setDate(mStart.getDate() + durationDays);
            subFlow += `<span>• ${m.lord}-${sLord}: ${mStart.toLocaleDateString('en-GB')} तक</span>`;
        }
        subFlow += "</div>";
        dTbl += `<tr><td><b>${m.lord}</b></td><td>${m.start}</td><td>${m.end}</td><td>${subFlow}</td></tr>`;
    });
    document.getElementById('dasha_tbl').innerHTML = dTbl;

    // 3. Detailed 12 House Predictions (D1 to D9 Linkage)
    let pHtml = "";
    for(let i=1; i<=12; i++) {
        let inH = data.planets.filter(p => p.house === i);
        pHtml += `<div class="pdf-page">
            <h2 style="color:var(--main); border-bottom:1px solid #ccc;">भाव ${i} - विस्तृत शास्त्रीय विश्लेषण</h2>
            <div class="report-text">
                <b>स्थित ग्रह एवं दृष्टि संबंध:</b> इस भाव में <b>${inH.map(p=>p.name).join(", ") || "कोई प्रत्यक्ष ग्रह नहीं"}</b> स्थित है। 
                D1 के अनुसार भाव स्वामी का संबंध शुभ है। नवांश (D9) में यह ग्रह <b>${inH[0]?.d9 || 'मित्र'}</b> राशि में बैठा है, जो फल को 
                <b>${inH[0]?.d9 === exaltRashi[inH[0]?.name] ? 'अत्यंत श्रेष्ठ' : 'स्थिर'}</b> बनाता है। <br><br>
                <b>संपूर्ण फल:</b> दृष्टि संबंधों के आधार पर, यह भाव जातक को जीवन के मध्यम काल में पूर्ण सफलता दिलाएगा। 
                महादशा स्वामी के साथ इस भाव के स्वामी का षडबल संबंध उत्तम होने से कार्य सिद्धि के प्रबल योग हैं।
            </div>
        </div>`;
    }
    document.getElementById('analysis_pages').innerHTML = pHtml;

    drawK('d1_canvas', data.lagna.rIdx, data.planets, 'house');
    drawK('d9_canvas', data.lagna.d9, data.planets, 'd9');
}

function drawK(id, asc, planets, mode) {
    const pts = {1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]};
    let svg = `<svg viewBox="0 0 450 480"><path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#333" stroke-width="3"/>`;
    for (let i = 1; i <= 12; i++) {
        let r = (asc + i - 1); if (r > 12) r -= 12;
        let [x, y] = pts[i];
        svg += `<text x="${x}" y="${y+5}" fill="#800000" font-weight="900" font-size="28" text-anchor="middle">${r}</text>`;
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === r);
        list.forEach((p, idx) => {
            let uTag = (p.house === exaltRashi[p.name]) ? "(U)" : (p.house === debilRashi[p.name]) ? "(N)" : "";
            let cl = (p.house === exaltRashi[p.name]) ? "u-clr" : (p.house === debilRashi[p.name]) ? "n-clr" : "";
            svg += `<text x="${x+(idx%2?35:-35)}" y="${y-(idx>1?25:45)}" font-size="14" font-weight="bold" class="${cl}" text-anchor="middle">${p.name}${uTag}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function saveAsPDF() {
    const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], {scale: 2});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Professional_Astro_Report.pdf");
}
</script>
</body>
</html>
