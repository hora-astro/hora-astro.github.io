<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Astro-Omni X-Stream V22.0</title>
    <style>
        :root { --accent: #f39c12; --dark: #0d1117; }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; }
        .header { background: #161b22; padding: 20px; border-bottom: 2px solid var(--accent); text-align: center; }
        .container { max-width: 1100px; margin: auto; padding: 20px; }
        
        /* Location Search Box */
        .search-container { position: relative; width: 100%; }
        #loc_results { position: absolute; background: white; color: black; width: 100%; z-index: 100; border-radius: 4px; }
        .loc-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #ddd; }

        .input-bar { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr 1.5fr auto; gap: 10px; background: #21262d; padding: 20px; border-radius: 8px; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 15px; border-radius: 10px; color: black; }
        .panchang-bar { background: var(--accent); color: black; display: flex; justify-content: space-around; padding: 10px; font-weight: bold; margin: 15px 0; border-radius: 5px; }
        
        svg { width: 100%; height: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #161b22; }
        th, td { padding: 10px; border: 1px solid #30363d; text-align: center; }
        th { background: #21262d; color: var(--accent); }
    </style>
</head>
<body>

    <div class="header">
        <h1>üåå ASTRO-OMNI X-STREAM V22.0</h1>
    </div>

    <div class="container">
        <div class="input-bar">
            <input type="text" id="name" placeholder="‡§®‡§æ‡§Æ" value="Hemant Purohit">
            <input type="date" id="date" value="2006-11-06">
            <input type="time" id="time" value="11:28">
            <input type="text" id="lat" placeholder="Lat" value="24.58">
            <input type="text" id="lng" placeholder="Lng" value="73.71">
            <div class="search-container">
                <input type="text" id="city_search" placeholder="‡§∂‡§π‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="searchCity(this.value)">
                <div id="loc_results"></div>
            </div>
            <button onclick="loadKundli()" style="background:var(--accent); border:none; font-weight:bold; cursor:pointer;">‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
        </div>

        <div id="main_ui" style="display:none">
            <div class="panchang-bar">
                <span id="p_tithi"></span> | <span id="p_nak"></span> | <span id="p_place"></span>
            </div>

            <div class="chart-grid">
                <div class="card"><h3>D1 ‡§≤‡§ó‡•ç‡§® ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä</h3><div id="d1_svg"></div></div>
                <div class="card"><h3>D9 ‡§®‡§µ‡§æ‡§Ç‡§∂ ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä</h3><div id="d9_svg"></div></div>
            </div>

            <table>
                <thead><tr><th>‡§ó‡•ç‡§∞‡§π</th><th>‡§∞‡§æ‡§∂‡§ø</th><th>‡§Ö‡§Ç‡§∂</th><th>‡§≠‡§æ‡§µ</th></tr></thead>
                <tbody id="planet_body"></tbody>
            </table>
        </div>
    </div>

<script>
    // 1. ‡§∂‡§π‡§∞ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (Location Search)
    async function searchCity(query) {
        if(query.length < 3) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
        const data = await res.json();
        let html = "";
        data.slice(0, 5).forEach(item => {
            html += `<div class="loc-item" onclick="setLoc(${item.lat}, ${item.lon}, '${item.display_name}')">${item.display_name}</div>`;
        });
        document.getElementById('loc_results').innerHTML = html;
    }

    function setLoc(lat, lon, name) {
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lon;
        document.getElementById('city_search').value = name;
        document.getElementById('loc_results').innerHTML = "";
    }

    // 2. ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ
    async function loadKundli() {
        const url = `/api/kundli_v22?date=${document.getElementById('date').value}&time=${document.getElementById('time').value}&lat=${document.getElementById('lat').value}&lng=${document.getElementById('lng').value}`;
        const res = await fetch(url);
        const d = await res.json();

        document.getElementById('main_ui').style.display = 'block';
        document.getElementById('p_tithi').innerText = "‡§§‡§ø‡§•‡§ø: " + d.panchang.tithi;
        document.getElementById('p_nak').innerText = "‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞: " + d.panchang.nak;
        document.getElementById('p_place').innerText = "‡§∏‡•ç‡§•‡§æ‡§®: " + document.getElementById('city_search').value;

        document.getElementById('d1_svg').innerHTML = drawNorthChart(d.asc, d.planets, 'd1');
        document.getElementById('d9_svg').innerHTML = drawNorthChart(d.d9_asc, d.planets, 'd9');

        document.getElementById('planet_body').innerHTML = d.planets.map(p => `<tr><td>${p.name}</td><td>${p.sign}</td><td>${p.deg}</td><td>${p.house}</td></tr>`).join('');
    }

    function drawNorthChart(lagna, planets, type) {
        const pos = {1:[150,85], 2:[75,40], 3:[40,75], 4:[100,150], 5:[40,225], 6:[75,260], 7:[150,215], 8:[225,260], 9:[260,225], 10:[200,150], 11:[260,75], 12:[225,40]};
        let svg = `<svg viewBox="0 0 300 300"><path d="M0 0 L300 300 M300 0 L0 300 M150 0 L0 150 L150 300 L300 150 Z" stroke="#000" fill="none" stroke-width="2"/><rect width="300" height="300" fill="none" stroke="#000" stroke-width="3"/>`;
        
        // ‡§∞‡§æ‡§∂‡§ø ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ (Corrected placement)
        for(let i=1; i<=12; i++) {
            let r = ((lagna + i - 2) % 12) + 1;
            svg += `<text x="${pos[i][0]}" y="${pos[i][1]}" fill="red" font-weight="bold" font-size="18" text-anchor="middle">${r}</text>`;
        }

        let tracker = {};
        planets.forEach(p => {
            let p_sign = (type === 'd1') ? p.sign : p.d9_sign;
            let house = ((p_sign - lagna + 12) % 12) + 1;
            if(!tracker[house]) tracker[house] = 0;
            svg += `<text x="${pos[house][0]}" y="${pos[house][1] + 20 + (tracker[house]*16)}" fill="blue" font-weight="bold" font-size="12" text-anchor="middle">${p.name}</text>`;
            tracker[house]++;
        });
        return svg + "</svg>";
    }
</script>
</body>
</html>
