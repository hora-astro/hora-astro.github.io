<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AstroPro Commercial Software</title>
    <style>
        :root { --brand: #e67e22; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', Arial; margin: 0; background: #fdfdfd; }
        .nav { background: var(--dark); color: white; padding: 15px; display: flex; gap: 15px; justify-content: center; position: sticky; top:0; z-index: 1000;}
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .search-box { position: relative; }
        #cityList { position: absolute; background: white; border: 1px solid #ccc; width: 100%; top: 40px; display: none; color: black; z-index: 1001;}
        #cityList div { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .ex-tag { color: green; font-weight: bold; }
        .db-tag { color: red; font-weight: bold; }
        svg { background: #fff; border: 1px solid var(--brand); border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #f8f9fa; color: var(--dark); }
        button { background: var(--brand); color: white; border: none; padding: 10px 25px; border-radius: 4px; cursor: pointer; font-weight: bold;}
    </style>
</head>
<body>

<div class="nav">
    <input type="text" id="name" value="हेमंत पुरोहित">
    <input type="date" id="dob" value="1980-03-27" onchange="generate()">
    <input type="time" id="tob" value="10:30" onchange="generate()">
    <div class="search-box">
        <input type="text" id="loc" placeholder="शहर खोजें..." oninput="search(this.value)">
        <div id="cityList"></div>
    </div>
    <input type="hidden" id="lat" value="23.32"><input type="hidden" id="lon" value="74.26">
    <button onclick="generate()">कुंडली अपडेट करें</button>
</div>

<div class="container" id="report">
    <div class="card" id="panchang-box" style="margin-bottom:20px; display:none;">
        <h2>दैनिक पंचांग</h2>
        <div id="pan-data"></div>
    </div>

    <div class="chart-grid">
        <div class="card"><h3>लग्न कुंडली (D1)</h3><div id="d1_chart"></div></div>
        <div class="card"><h3>नवांश कुंडली (D9)</h3><div id="d9_chart"></div></div>
    </div>

    <div class="card">
        <h3>ग्रह स्थिति एवं फलादेश</h3>
        <table id="p-table">
            <thead><tr><th>ग्रह</th><th>अंश</th><th>भाव</th><th>स्थिति</th><th>नवांश राशि</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
async function search(q) {
    if(q.length < 3) return;
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await res.json();
    const list = document.getElementById('cityList');
    list.innerHTML = ""; list.style.display = "block";
    data.slice(0, 5).forEach(i => {
        let d = document.createElement('div');
        d.innerText = i.display_name;
        d.onclick = () => {
            document.getElementById('lat').value = i.lat;
            document.getElementById('lon').value = i.lon;
            document.getElementById('loc').value = i.display_name.split(',')[0];
            list.style.display = "none";
            generate();
        };
        list.appendChild(d);
    });
}

async function generate() {
    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.status === 'success') renderUI(data);
}

function renderUI(data) {
    // पंचांग
    document.getElementById('panchang-box').style.display = 'block';
    document.getElementById('pan-data').innerHTML = `<b>दिन:</b> ${data.panchang.day} | <b>समय क्षेत्र:</b> IST ${data.panchang.tz}`;

    // टेबल अपडेट
    const tbody = document.querySelector('#p-table tbody');
    tbody.innerHTML = "";
    data.planets.forEach(p => {
        tbody.innerHTML += `<tr>
            <td>${p.name}</td><td>${p.deg}</td><td>${p.house}</td>
            <td class="${p.status==='उच्च'?'ex-tag':(p.status==='नीच'?'db-tag':'')}">${p.status}</td>
            <td>${p.d9}</td>
        </tr>`;
    });

    // चार्ट्स
    drawChart('d1_chart', data.lagna, data.planets, 'house');
    drawChart('d9_chart', data.d9_lagna, data.planets, 'd9');
}

function drawChart(divId, asc, planets, mode) {
    const coords = {1:[110,80], 2:[55,45], 3:[15,80], 4:[75,135], 5:[15,190], 6:[55,225], 7:[110,190], 8:[165,225], 9:[205,190], 10:[145,135], 11:[205,80], 12:[165,45]};
    let svg = `<svg viewBox="0 0 225 270" width="100%"><path d="M0 0 L225 0 L225 270 L0 270 Z M0 0 L225 270 M225 0 L0 270 M112 0 L0 135 L112 270 L225 135 Z" fill="none" stroke="#e67e22" stroke-width="2"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]}" fill="#2c3e50" font-weight="bold" font-size="14" text-anchor="middle">${sign}</text>`;
        let pInHouse = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        pInHouse.forEach((p, idx) => {
            svg += `<text x="${coords[i][0]}" y="${coords[i][1] + 15 + (idx*12)}" font-size="10" text-anchor="middle" fill="${p.status==='उच्च'?'green':(p.status==='नीच'?'red':'#555')}">${p.name}</text>`;
        });
    }
    document.getElementById(divId).innerHTML = svg + `</svg>`;
}
</script>
</body>
</html>
