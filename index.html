<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AstroBusiness KP Professional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --kp-blue: #0f172a; --kp-gold: #f59e0b; }
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; }
        .sidebar { background: var(--kp-blue); color: white; min-height: 100vh; padding: 20px; }
        .main-content { padding: 30px; }
        .nav-tabs .nav-link.active { background: var(--kp-gold); color: white; border: none; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .chart-svg { max-width: 450px; margin: auto; display: block; }
        .dasha-scroll { max-height: 500px; overflow-y: auto; }
        .planet-row:hover { background: #fff7ed; cursor: pointer; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 sidebar">
            <h3 class="mb-4">KP Pro Engine</h3>
            <div class="mb-3">
                <label>जातक का नाम</label>
                <input type="text" id="name" class="form-control" value="हेमंत पुरोहित">
            </div>
            <div class="mb-3">
                <label>जन्म तिथि</label>
                <input type="date" id="dob" class="form-control" value="1980-03-27">
            </div>
            <div class="mb-3">
                <label>जन्म समय</label>
                <input type="time" id="tob" class="form-control" value="10:30">
            </div>
            <div class="mb-3">
                <label>अक्षांश (Lat)</label>
                <input type="number" id="lat" class="form-control" value="23.58">
            </div>
            <div class="mb-3">
                <label>देशांतर (Lon)</label>
                <input type="number" id="lon" class="form-control" value="74.44">
            </div>
            <button onclick="calculateAll()" class="btn btn-warning w-100 fw-bold">कुंडली विश्लेषण करें</button>
        </div>

        <div class="col-md-9 main-content">
            <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab1">लग्न एवं नवांश</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab2">ग्रह एवं भाव विवरण</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab3">विंशोत्तरी दशा</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab1">
                    <div class="row">
                        <div class="col-md-6 card p-3">
                            <h5 class="text-center">लग्न कुंडली (D1)</h5>
                            <div id="d1Chart"></div>
                        </div>
                        <div class="col-md-6 card p-3">
                            <h5 class="text-center">नवांश कुंडली (D9)</h5>
                            <div id="d9Chart"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab2">
                    <div class="card p-4">
                        <h4>KP ग्रह स्थिति (Planetary Significations)</h4>
                        <table class="table table-hover mt-3">
                            <thead class="table-dark">
                                <tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>स्वामी</th><th>उप-स्वामी</th><th>भाव</th></tr>
                            </thead>
                            <tbody id="pBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab3">
                    <div class="card p-4">
                        <h4>विंशोत्तरी महादशा चक्र</h4>
                        <div id="dashaList" class="accordion mt-3 dasha-scroll"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function calculateAll() {
    const payload = {
        name: document.getElementById('name').value,
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };

    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    if(data.status === 'success') {
        renderUI(data);
    }
}

function renderUI(data) {
    // 1. Planets Table
    let html = "";
    data.planets.forEach(p => {
        html += `<tr class="planet-row"><td><b>${p.name}</b></td><td>${p.full_deg}</td><td>${p.nak}</td><td>${p.nLord}</td><td>${p.sub}</td><td><span class="badge bg-primary">${p.house}</span></td></tr>`;
    });
    document.getElementById('pBody').innerHTML = html;

    // 2. Dasha Accordion
    let dHtml = "";
    data.dasha.forEach((d, i) => {
        dHtml += `
        <div class="accordion-item">
            <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#d${i}">
                <b>${d.lord}</b> की महादशा (${d.until} तक)
            </button></h2>
            <div id="d${i}" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <table class="table table-sm">
                        ${d.subs.map(s => `<tr><td>${s.lord}</td><td class="text-end">${s.until} तक</td></tr>`).join('')}
                    </table>
                </div>
            </div>
        </div>`;
    });
    document.getElementById('dashaList').innerHTML = dHtml;

    // 3. Draw Charts
    drawKundli('d1Chart', data.cusps[0].rIdx, data.planets, true);
    drawKundli('d9Chart', data.cusps[0].d9, data.planets, false);
}

function drawKundli(id, asc, planets, isD1) {
    const pts = {1:[190,160], 2:[90,70], 3:[40,140], 4:[140,200], 5:[40,260], 6:[90,330], 7:[190,260], 8:[280,330], 9:[340,260], 10:[240,200], 11:[340,140], 12:[280,70]};
    let svg = `<svg viewBox="0 0 380 380" class="chart-svg">
        <path d="M0 0 L380 0 L380 380 L0 380 Z M0 0 L380 380 M380 0 L0 380 M190 0 L0 190 L190 380 L380 190 Z" fill="none" stroke="#0f172a" stroke-width="2"/>`;
    for(let i=1; i<=12; i++) {
        let r = (asc + i - 1); if(r > 12) r -= 12;
        svg += `<text x="${pts[i][0]}" y="${pts[i][1]}" fill="#b91c1c" font-weight="bold" font-size="22" text-anchor="middle">${r}</text>`;
        let inHouse = isD1 ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === r);
        inHouse.forEach((p, idx) => {
            svg += `<text x="${pts[i][0]}" y="${pts[i][1] + 20 + (idx*16)}" font-size="13" text-anchor="middle" fill="#334155">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}
</script>
</body>
</html>
