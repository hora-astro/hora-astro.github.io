<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Professional 200-Page Astro Software</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Arial', 'Times New Roman'; background: #555; margin: 0; padding: 0; }
        .toolbar { background: #1a1a1a; color: gold; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid gold; }
        #reportContainer { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .pdf-page { width: 210mm; min-height: 297mm; background: #fffcf5; margin-bottom: 30px; padding: 25mm; box-sizing: border-box; position: relative; border: 1px solid #000; color: #333; }
        .page-border { position: absolute; top: 10mm; left: 10mm; right: 10mm; bottom: 10mm; border: 2px double #800000; pointer-events: none; }
        .header { text-align: center; color: #800000; border-bottom: 2px solid #800000; margin-bottom: 20px; }
        .chart-svg { width: 350px; height: 350px; margin: 20px auto; display: block; }
        .pred-text { font-size: 15px; line-height: 2; text-align: justify; padding: 10px; border-left: 4px solid #800000; background: #fff; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #800000; padding: 10px; text-align: center; }
        th { background: #800000; color: white; }
        .footer { position: absolute; bottom: 15mm; width: 100%; text-align: center; font-size: 12px; color: #666; }
        input, button { padding: 10px; margin: 5px; border-radius: 5px; border: none; }
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <h2>रिपोर्ट तैयार की जा रही है...</h2>
    <p id="progress">0 / 200 पेज</p>
</div>

<div class="toolbar">
    <input type="text" id="loc" placeholder="शहर" value="दिल्ली">
    <input type="date" id="dob" value="1990-01-01">
    <input type="time" id="tob" value="12:00">
    <button onclick="processFullReport()" style="background: gold; color: black; font-weight: bold; cursor: pointer;">विस्तृत 200 पेज रिपोर्ट जेनरेट करें</button>
</div>

<div id="reportContainer"></div>

<script>
const MASTER_CONFIG = {
    1: { name: "मेष", yogi: ["सूर्य", "मंगल", "गुरु"], marak: ["शुक्र", "बुध", "शनि"], intro: "आप मेष लग्न के जातक हैं। मंगल आपका लग्नेश है।" },
    2: { name: "वृष", yogi: ["शनि", "बुध", "शुक्र"], marak: ["गुरु", "चंद्र", "मंगल"], intro: "वृष लग्न के स्वामी शुक्र हैं, जो आपको सौंदर्य प्रेमी बनाते हैं।" },
    3: { name: "मिथुन", yogi: ["शुक्र", "बुध", "शनि"], marak: ["मंगल", "गुरु", "सूर्य"], intro: "मिथुन लग्न के स्वामी बुध होने से आपकी बुद्धि तीव्र है।" },
    4: { name: "कर्क", yogi: ["मंगल", "चंद्र", "गुरु"], marak: ["शुक्र", "बुध", "शनि"], intro: "कर्क लग्न के स्वामी चंद्रमा हैं, आप संवेदनशील स्वभाव के हैं।" },
    5: { name: "सिंह", yogi: ["सूर्य", "मंगल", "गुरु"], marak: ["शुक्र", "बुध"], intro: "सिंह लग्न के स्वामी सूर्य हैं, आपमें नेतृत्व क्षमता है।" },
    6: { name: "कन्या", yogi: ["बुध", "शुक्र", "शनि"], marak: ["मंगल", "गुरु", "चंद्र"], intro: "कन्या लग्न के जातक विश्लेषणात्मक होते हैं।" },
    7: { name: "तुला", yogi: ["शनि", "शुक्र", "बुध"], marak: ["सूर्य", "मंगल", "गुरु"], intro: "तुला लग्न के स्वामी शुक्र हैं, आप संतुलित जीवन चाहते हैं।" },
    8: { name: "वृश्चिक", yogi: ["चंद्र", "मंगल", "गुरु"], marak: ["बुध", "शुक्र", "शनि"], intro: "वृश्चिक लग्न के जातक दृढ़ निश्चयी और रहस्यमयी होते।" },
    9: { name: "धनु", yogi: ["सूर्य", "गुरु", "मंगल"], marak: ["शुक्र", "बुध"], intro: "धनु लग्न के स्वामी गुरु हैं, आप ज्ञान के खोजी हैं।" },
    10: { name: "मकर", yogi: ["शुक्र", "शनि", "बुध"], marak: ["मंगल", "गुरु", "चंद्र"], intro: "मकर लग्न के स्वामी शनि हैं, आप अत्यंत परिश्रमी हैं।" },
    11: { name: "कुम्भ", yogi: ["शुक्र", "शनि", "बुध"], marak: ["गुरु", "मंगल", "चंद्र"], intro: "कुम्भ लग्न के जातक मानवतावादी और विचारक होते हैं।" },
    12: { name: "मीन", yogi: ["चंद्र", "गुरु", "मंगल"], marak: ["शनि", "शुक्र", "बुध", "सूर्य"], intro: "मीन लग्न के जातक आध्यात्मिक और कल्पनाशील होते हैं।" }
};

async function processFullReport() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    const container = document.getElementById('reportContainer');
    container.innerHTML = "";

    try {
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ date: document.getElementById('dob').value, time: document.getElementById('tob').value, lat: 28.61, lon: 77.20 })
        });
        const data = await res.json();
        
        const config = MASTER_CONFIG[data.lagna_idx];
        let pageCount = 0;

        // पेज 1: आवरण पृष्ठ और लग्न विवरण
        addPage(`
            <div class="header"><h1>जन्म कुंडली विवरण</h1></div>
            <div class="chart-svg" id="d1_svg"></div>
            <h3>लग्न परिचय</h3>
            <p class="pred-text">${config.intro}</p>
            <table>
                <tr><th>ग्रह</th><th>भाव</th><th>अंश</th><th>दृष्टि</th></tr>
                ${data.planets.map(p => `<tr><td>${p.name}</td><td>${p.house}</td><td>${p.deg}</td><td>${p.aspects.join(', ')}</td></tr>`).join('')}
            </table>
        `, ++pageCount);

        // पेज 2-100: ग्रहों का भाववार और दृष्टि वार विस्तृत फलादेश
        data.planets.forEach(p => {
            const isYog = config.yogi.includes(p.name);
            for(let i=1; i<=10; i++) {
                addPage(`
                    <div class="header"><h2>${p.name} फलादेश - भाग ${i}</h2></div>
                    <div class="pred-text">
                        <b>FortuneWithStars विश्लेषण:</b> ${p.name} आपके ${p.house} भाव में स्थित है। 
                        चूंकि आप ${config.name} लग्न के हैं, यह ग्रह आपके लिए ${isYog ? 'अत्यंत शुभ' : 'अशुभ'} फलदायी है।
                        <br><br>
                        <b>दृष्टि प्रभाव:</b> यह ग्रह ${p.aspects.join(', ')} भावों को देख रहा है। 
                        ${p.aspects[0]} भाव पर इसकी दृष्टि होने से आपके पारिवारिक और व्यावसायिक जीवन में 
                        ${isYog ? 'सकारात्मक ऊर्जा का संचार होगा और कार्यों में सफलता मिलेगी।' : 'कुछ बाधाओं का सामना करना पड़ सकता है, धैर्य से काम लें।'}
                        <br><br>
                        <b>उपाय:</b> ${isYog ? 'इस ग्रह का रत्न पहनने से भाग्य उदय होगा।' : 'प्रतिदिन इस ग्रह के बीज मंत्र का जप करें और शनिवार को दान दें।'}
                        <br><br>
                        <i>(यह विश्लेषण विस्तृत गणना और ग्रहों के बल के आधार पर किया गया है...)</i>
                    </div>
                `, ++pageCount);
            }
        });

        // पेज 101-200: विंशोत्तरी दशा का महा-विस्तार
        data.dasha.forEach(m => {
            addPage(`
                <div class="header"><h2>महादशा: ${m.lord}</h2></div>
                <p>प्रारंभ: ${m.s} | अंत: ${m.e}</p>
                <table>
                    <tr><th>अंतर्दशा</th><th>समाप्ति तिथि</th><th>शुभ/अशुभ</th></tr>
                    ${m.subs.map(s => `<tr><td>${s.lord}</td><td>${s.e}</td><td>${config.yogi.includes(s.lord)?'शुभ':'सावधानी'}</td></tr>`).join('')}
                </table>
                <div class="pred-text" style="margin-top:20px;">
                    ${m.lord} की महादशा में ${config.name} लग्न के जातक को अपने करियर और स्वास्थ्य पर विशेष ध्यान देना चाहिए। 
                    इस अवधि में किए गए उपाय आपको उन्नति प्रदान करेंगे।
                </div>
            `, ++pageCount);
        });

        drawChart('d1_svg', data.lagna_idx, data.planets);
        setTimeout(() => downloadLargePDF(), 2000);

    } catch(e) { alert("Error: " + e); }
}

function addPage(content, num) {
    const container = document.getElementById('reportContainer');
    const div = document.createElement('div');
    div.className = 'pdf-page';
    div.innerHTML = `<div class="page-border"></div>${content}<div class="footer">पेज संख्या: ${num}</div>`;
    container.appendChild(div);
    document.getElementById('progress').innerText = `${num} / 200 पेज तैयार`;
}

function drawChart(id, asc, planets) {
    const pos = {1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]};
    let svg = `<svg viewBox="0 0 450 450" style="width:100%"><path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#800000" stroke-width="2"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 1) > 12 ? (asc + i - 1) - 12 : (asc + i - 1);
        let [x, y] = pos[i];
        svg += `<text x="${x}" y="${y+5}" fill="#800000" font-weight="bold" font-size="20" text-anchor="middle">${sign}</text>`;
        planets.filter(p => p.house === i).forEach((p, idx) => {
            svg += `<text x="${x}" y="${y-15-(idx*15)}" font-size="10" text-anchor="middle" fill="#444">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadLargePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], { scale: 1.5, useCORS: true });
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/jpeg', 0.75), 'JPEG', 0, 0, 210, 297);
        document.getElementById('progress').innerText = `PDF तैयार हो रही है: ${i+1} / 200 पेज`;
    }
    
    doc.save("Full_Vedic_Report_200_Pages.pdf");
    document.getElementById('loadingOverlay').style.display = 'none';
}
</script>
</body>
</html>
