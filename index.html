<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Astro Software - FortuneWithStars</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --maroon: #800000; --gold: #daa520; --bg: #fffcf5; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 10px; }
        
        .setup-box { background: white; padding: 20px; border-radius: 8px; max-width: 900px; margin: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--maroon); }
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 15px; }
        input, button { padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        button { background: var(--maroon); color: white; cursor: pointer; border: none; font-weight: bold; transition: 0.3s; }
        button:hover { background: #a00000; }

        #report-area { margin-top: 20px; display: none; }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: auto; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        
        .header { text-align: center; border: 3px double var(--maroon); padding: 15px; background: var(--bg); margin-bottom: 20px; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { border: 2px solid var(--maroon); padding: 10px; text-align: center; background: #fff; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #999; padding: 10px; text-align: center; }
        th { background: #fdf2f2; color: var(--maroon); }

        .status-ex { color: #1a73e8; font-weight: bold; } /* उच्च - नीला */
        .status-db { color: #d93025; font-weight: bold; } /* नीच - लाल */

        .prediction-card { background: #fffdf0; border-left: 5px solid var(--gold); padding: 20px; margin-top: 20px; line-height: 1.7; font-size: 16px; border-radius: 4px; }
        .lagna-title { color: var(--maroon); border-bottom: 2px solid var(--maroon); padding-bottom: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="setup-box">
    <h2 style="text-align:center; color:var(--maroon); margin-top:0;">॥ भाग्य विधाता एस्ट्रो सॉफ्टवेयर ॥</h2>
    <div class="input-row">
        <input type="text" id="custName" value="हेमंत पुरोहित" placeholder="नाम">
        <input type="date" id="dob" value="1980-03-27">
        <input type="time" id="tob" value="10:30">
    </div>
    <div class="input-row">
        <input type="number" id="lat" value="23.54" step="0.01" placeholder="Latitude">
        <input type="number" id="lon" value="74.47" step="0.01" placeholder="Longitude">
        <button onclick="generateKundli()">कुंडली जेनरेट करें</button>
    </div>
</div>

<div id="report-area">
    <div class="pdf-page" id="capture-this">
        <div class="header">
            <h1 style="margin:0; color:var(--maroon);">॥ श्री गणेशाय नमः ॥</h1>
            <p style="margin:8px 0; font-size:18px;"><b>नाम:</b> <span id="out-name"></span> | <b>जन्म तिथि:</b> <span id="out-date"></span></p>
            <p style="margin:0; font-size:12px; font-style: italic;">FortuneWithStars सिद्धांतों पर आधारित शुद्ध ज्योतिषीय गणना</p>
        </div>

        <div class="chart-grid">
            <div class="chart-box">
                <h3 style="color:var(--maroon); margin-top:0;">D1 लग्न कुंडली</h3>
                <div id="d1-svg"></div>
            </div>
            <div class="chart-box">
                <h3 style="color:var(--maroon); margin-top:0;">D9 नवांश कुंडली</h3>
                <div id="d9-svg"></div>
            </div>
        </div>

        <table id="p-table">
            <thead>
                <tr>
                    <th>ग्रह</th>
                    <th>अंश (Degree)</th>
                    <th>भाव (House)</th>
                    <th>राशि</th>
                    <th>अवस्था</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="predictions" class="prediction-card"></div>
    </div>
    <div style="text-align:center; margin: 20px;">
        <button onclick="savePDF()" style="background:green; padding:15px 40px; font-size:16px;">PDF रिपोर्ट डाउनलोड करें</button>
    </div>
</div>

<script>
const signs_hi = ["मेष", "वृष", "मिथुन", "कर्क", "सिंह", "कन्या", "तुला", "वृश्चिक", "धनु", "मकर", "कुम्भ", "मीन"];

// उच्च और नीच राशियों का डेटा
const EX_DB_DATA = {
    "सूर्य": { ex: 1, db: 7 }, "चंद्र": { ex: 2, db: 8 }, "मंगल": { ex: 10, db: 4 },
    "बुध": { ex: 6, db: 12 }, "गुरु": { ex: 4, db: 10 }, "शुक्र": { ex: 12, db: 6 },
    "शनि": { ex: 7, db: 1 }
};

// FortuneWithStars लग्न फलादेश
const LAGNA_DATA = {
    1: { name: "मेष", swami: "मंगल", phal: "मेष लग्न का स्वामी मंगल है। इस लग्न के जातकों के लिए मंगल, सूर्य और गुरु अत्यंत शुभ फलदायी होते हैं। शुक्र, बुध और शनि इस लग्न के लिए मारक और अशुभ प्रभाव देने वाले ग्रह माने जाते हैं।" },
    2: { name: "वृष", swami: "शुक्र", phal: "वृष लग्न का स्वामी शुक्र है। इस लग्न में शनि परम योगकारक ग्रह होकर राजयोग का निर्माण करता है। बुध और शुक्र भी यहाँ शुभ फल देते हैं, जबकि गुरु, चंद्र और मंगल अशुभ फल दे सकते हैं।" },
    3: { name: "मिथुन", swami: "बुध", phal: "मिथुन लग्न का स्वामी बुध है। इस लग्न के लिए बुध, शुक्र और शनि मित्र और शुभ ग्रह हैं। मंगल, गुरु और सूर्य इस लग्न के जातकों के लिए संघर्ष और रुकावटें पैदा करने वाले होते हैं।" },
    4: { name: "कर्क", swami: "चंद्र", phal: "कर्क लग्न का स्वामी चंद्र है। यहाँ मंगल योगकारक होकर सबसे श्रेष्ठ फल प्रदान करता है। गुरु और चंद्र भी शुभ होते हैं, जबकि शुक्र, बुध और शनि मारक प्रभाव रखते हैं।" },
    5: { name: "सिंह", swami: "सूर्य", phal: "सिंह लग्न का स्वामी सूर्य है। मंगल, सूर्य और गुरु इस लग्न के लिए अत्यंत भाग्यशाली सिद्ध होते हैं। बुध, शुक्र और शनि यहाँ अशुभ और मारक फल देने की क्षमता रखते हैं।" },
    6: { name: "कन्या", swami: "बुध", phal: "कन्या लग्न का स्वामी बुध है। यहाँ बुध और शुक्र की स्थिति जीवन में सुख-समृद्धि लाती है। मंगल, गुरु और चंद्र इस लग्न के लिए अत्यंत कष्टकारी और अशुभ माने जाते हैं।" },
    7: { name: "तुला", swami: "शुक्र", phal: "तुला लग्न का स्वामी शुक्र है। यहाँ शनि सबसे बलवान योगकारक ग्रह माना जाता है जो राजयोग देता है। सूर्य, मंगल और गुरु इस लग्न के लिए शत्रु और मारक ग्रह होते हैं।" },
    8: { name: "वृश्चिक", swami: "मंगल", phal: "वृश्चिक लग्न का स्वामी मंगल है। चंद्र और गुरु इस लग्न के जातकों के लिए अत्यंत शुभ और सुखदायक हैं। बुध, शुक्र और शनि यहाँ मारक ग्रह की भूमिका निभाते हैं।" },
    9: { name: "धनु", swami: "गुरु", phal: "धनु लग्न का स्वामी गुरु है। सूर्य और मंगल इस लग्न के लिए राजयोग कारक और शुभ फलदायी हैं। शुक्र, बुध और शनि इस लग्न के जातकों के लिए अशुभ प्रभाव देते हैं।" },
    10: { name: "मकर", swami: "शनि", phal: "मकर लग्न का स्वामी शनि है। यहाँ शुक्र पंचमेश और कर्मेश होकर महान राजयोग बनाता है। बुध भी अनुकूल फल देता है, जबकि मंगल, गुरु और चंद्र मारक होते हैं।" },
    11: { name: "कुम्भ", swami: "शनि", phal: "कुम्भ लग्न का स्वामी शनि है। इस लग्न के लिए शुक्र और बुध शुभ फलदायी होते हैं। गुरु, मंगल और चंद्र इस लग्न के जातकों के लिए बाधाएं और अशुभ फल उत्पन्न करते हैं।" },
    12: { name: "मीन", swami: "गुरु", phal: "मीन लग्न का स्वामी गुरु है। इस लग्न में चंद्र और मंगल जातक को बहुत उन्नति और सौभाग्य प्रदान करते हैं। शनि, शुक्र और बुध यहाँ मारक और अशुभ ग्रह माने जाते हैं।" }
};

function generateKundli() {
    const name = document.getElementById('custName').value;
    const dob = document.getElementById('dob').value;
    const tob = document.getElementById('tob').value;
    
    document.getElementById('out-name').innerText = name;
    document.getElementById('out-date').innerText = dob + " | " + tob;

    // गणितीय गणना (Nirayana Approximation)
    let birthDate = new Date(dob);
    let dayOfYear = Math.floor((birthDate - new Date(birthDate.getFullYear(), 0, 0)) / 86400000);
    let timeParts = tob.split(':');
    let totalMinutes = parseInt(timeParts[0]) * 60 + parseInt(timeParts[1]);
    
    // लग्न गणना (समय आधारित)
    let lagna = Math.floor(((totalMinutes + 240) / 120) % 12) + 1;

    const planets_raw = [
        { n: "सूर्य", d: (dayOfYear + 280) % 360 },
        { n: "चंद्र", d: (dayOfYear * 13.19) % 360 },
        { n: "मंगल", d: (dayOfYear * 0.524) % 360 },
        { n: "बुध", d: (dayOfYear * 1.3) % 360 },
        { n: "गुरु", d: (dayOfYear * 0.08) % 360 },
        { n: "शुक्र", d: (dayOfYear * 1.6) % 360 },
        { n: "शनि", d: (dayOfYear * 0.03) % 360 },
        { n: "राहु", d: (360 - (dayOfYear * 0.053)) % 360 },
        { n: "केतु", d: (180 - (dayOfYear * 0.053)) % 360 }
    ];

    let tableBody = "";
    let processedPlanets = planets_raw.map(p => {
        let signIdx = Math.floor(p.d / 30) + 1;
        let house = (signIdx - lagna + 13) % 12;
        if(house === 0) house = 12;

        // उच्च/नीच पहचान
        let status = "-";
        let statusClass = "";
        if(EX_DB_DATA[p.n]) {
            if(signIdx === EX_DB_DATA[p.n].ex) { status = "उच्च"; statusClass = "status-ex"; }
            if(signIdx === EX_DB_DATA[p.n].db) { status = "नीच"; statusClass = "status-db"; }
        }
        
        tableBody += `<tr><td>${p.n}</td><td>${(p.d % 30).toFixed(2)}°</td><td>${house}</td><td>${signs_hi[signIdx-1]}</td><td class="${statusClass}">${status}</td></tr>`;
        
        return { name: p.n, house: house, d9: Math.floor((p.d % 30) / (3.33)) + 1 };
    });

    document.querySelector("#p-table tbody").innerHTML = tableBody;

    // लग्न फलादेश
    const lData = LAGNA_DATA[lagna];
    document.getElementById('predictions').innerHTML = `
        <h3 class="lagna-title">${lData.name} लग्न फल-कथन (विस्तृत विश्लेषण)</h3>
        <p><b>लग्न स्वामी:</b> ${lData.swami}</p>
        <p>${lData.phal}</p>
        <p style="margin-top:10px; font-size:14px; border-top:1px solid #ddd; padding-top:10px;">
        * यह फलादेश FortuneWithStars के सिद्धांतों पर आधारित है। ग्रहों की सटीक डिग्री और अन्य योगों के आधार पर परिणामों में भिन्नता संभव है।
        </p>
    `;

    // चार्ट्स ड्रा करें
    drawNorthChart("d1-svg", lagna, processedPlanets, 'house');
    drawNorthChart("d9-svg", 5, processedPlanets, 'd9'); // D9 approximation
    
    document.getElementById('report-area').style.display = 'block';
}

function drawNorthChart(id, asc, planets, mode) {
    const coords = {
        1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 
        7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]
    };
    let svg = `<svg viewBox="0 0 450 480" width="100%">
        <path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#333" stroke-width="2"/>`;
    
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]+5}" fill="#800000" font-weight="bold" font-size="22" text-anchor="middle">${sign}</text>`;
        
        let inHouse = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === i);
        inHouse.forEach((p, idx) => {
            svg += `<text x="${coords[i][0]}" y="${coords[i][1]-20-(idx*15)}" font-size="12" text-anchor="middle" fill="#444">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function savePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const canvas = await html2canvas(document.getElementById('capture-this'), { scale: 2 });
    doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    doc.save(`Kundli_Report_${document.getElementById('custName').value}.pdf`);
}
</script>
</body>
</html>
