<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satik Jyotish Universal | सटीक ज्योतिष</title>
    <style>
        :root { --red: #b91c1c; --gold: #f59e0b; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .app-container { max-width: 950px; margin: auto; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; border-top: 6px solid var(--red); }
        .header { background: var(--red); color: white; padding: 20px; text-align: center; }
        
        /* Input Section */
        .input-card { padding: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; border-bottom: 2px solid #eee; }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; color: #334155; }
        input { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; }
        button { background: var(--red); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.3s; grid-column: 1 / -1; }
        button:hover { background: #991b1b; transform: translateY(-2px); }

        /* Output Section */
        .results { display: none; grid-template-columns: 1.2fr 1fr; gap: 20px; padding: 20px; }
        @media (max-width: 768px) { .results { grid-template-columns: 1fr; } }
        
        .chart-box { background: #fff; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; }
        svg { width: 100%; max-width: 400px; height: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background: #334155; color: white; padding: 12px; }
        td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; font-weight: bold; }
        
        #status-msg { text-align: center; padding: 10px; font-weight: bold; }
        .loading { color: var(--red); }
        .error { color: #dc2626; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1 style="margin:0;">॥ सटीक यूनिवर्सल ज्योतिष सॉफ्टवेयर ॥</h1>
        <p style="margin:5px 0 0;">प्रोफेशनल कुंडली एवं ग्रह स्पष्ट गणना</p>
    </div>

    <div class="input-card">
        <div class="input-group">
            <label>जन्म तारीख</label>
            <input type="date" id="dob" value="1979-12-03">
        </div>
        <div class="input-group">
            <label>जन्म समय</label>
            <input type="time" id="tob" value="02:00">
        </div>
        <div class="input-group">
            <label>शहर (सर्च करें)</label>
            <input type="text" id="city" placeholder="उदा: Banswara" onchange="fetchLocation()">
        </div>
        <input type="hidden" id="lat" value="23.55">
        <input type="hidden" id="lon" value="74.43">
        
        <button onclick="calculateKundli()">कुंडली व ग्रह स्पष्ट तैयार करें ★</button>
    </div>

    <div id="status-msg"></div>

    <div id="output" class="results">
        <div class="chart-box">
            <h3 style="color:var(--red); margin-top:0;">लग्न कुंडली (North Indian)</h3>
            <svg id="kundliSvg" viewBox="0 0 400 400"></svg>
        </div>

        <div class="chart-box">
            <h3 style="color:var(--red); margin-top:0;">ग्रह एवं नक्षत्र स्पष्ट</h3>
            <table>
                <thead>
                    <tr><th>ग्रह</th><th>राशि</th><th>अंश</th><th>नक्षत्र</th></tr>
                </thead>
                <tbody id="planetTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// 1. शहर से Lat/Lon निकालना
async function fetchLocation() {
    const city = document.getElementById('city').value;
    if(city.length < 3) return;
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
        const data = await res.json();
        if(data.length > 0) {
            document.getElementById('lat').value = data[0].lat;
            document.getElementById('lon').value = data[0].lon;
            document.getElementById('status-msg').innerHTML = `<span style="color:green;">स्थान सेट: ${data[0].display_name}</span>`;
        }
    } catch(e) { console.log("Location Error"); }
}

// 2. PythonAnywhere सर्वर से डेटा लाना
async function calculateKundli() {
    const status = document.getElementById('status-msg');
    const output = document.getElementById('output');
    
    status.innerHTML = `<span class="loading">खगोलीय गणना की जा रही है, कृपया प्रतीक्षा करें...</span>`;
    output.style.display = "none";

    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };

    try {
        const response = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if(data.status === 'success') {
            status.innerHTML = "";
            output.style.display = "grid";
            renderData(data);
        } else {
            status.innerHTML = `<span class="error">सर्वर एरर: ${data.message}</span>`;
        }
    } catch (error) {
        status.innerHTML = `<span class="error">कनेक्शन एरर: क्या PythonAnywhere सर्वर चालू (Reloaded) है?</span>`;
    }
}

// 3. डेटा को टेबल और चार्ट में दिखाना
function renderData(data) {
    // टेबल भरना
    const tableBody = document.getElementById('planetTable');
    tableBody.innerHTML = data.planets.map(p => `
        <tr>
            <td>${p.name}</td>
            <td>${p.rashi}</td>
            <td>${p.deg}°</td>
            <td>${p.naks}</td>
        </tr>
    `).join('');

    // चार्ट बनाना
    drawDiamondChart(data.lagna, data.planets);
}

function drawDiamondChart(asc, planets) {
    const svg = document.getElementById('kundliSvg');
    // घरों के केंद्र बिंदु
    const houseCoords = [
        {x:200, y:150}, {x:100, y:80}, {x:50, y:150}, {x:150, y:200},
        {x:50, y:250}, {x:100, y:320}, {x:200, y:250}, {x:300, y:320},
        {x:350, y:250}, {x:250, y:200}, {x:350, y:150}, {x:300, y:80}
    ];

    let svgContent = `
        <rect width="400" height="400" fill="white" stroke="#333" stroke-width="2"/>
        <line x1="0" y1="0" x2="400" y2="400" stroke="#333" stroke-width="1.5"/>
        <line x1="400" y1="0" x2="0" y2="400" stroke="#333" stroke-width="1.5"/>
        <line x1="200" y1="0" x2="0" y2="200" stroke="#333" stroke-width="1.5"/>
        <line x1="200" y1="0" x2="400" y2="200" stroke="#333" stroke-width="1.5"/>
        <line x1="0" y1="200" x2="200" y2="400" stroke="#333" stroke-width="1.5"/>
        <line x1="200" y1="400" x2="400" y2="200" stroke="#333" stroke-width="1.5"/>
    `;

    // राशि नंबर लिखना
    for (let i = 0; i < 12; i++) {
        let rashiNum = (asc + i) > 12 ? (asc + i) - 12 : (asc + i);
        svgContent += `<text x="${houseCoords[i].x}" y="${houseCoords[i].y}" fill="#b91c1c" font-size="22" font-weight="bold" text-anchor="middle">${rashiNum}</text>`;
        
        // ग्रहों को उनके सही राशि वाले घर में बैठाना
        let occupation = 0;
        planets.forEach(p => {
            if (p.rIdx === rashiNum) {
                svgContent += `<text x="${houseCoords[i].x}" y="${houseCoords[i].y + 25 + (occupation * 18)}" fill="#1e293b" font-size="14" font-weight="bold" text-anchor="middle">${p.name}</text>`;
                occupation++;
            }
        });
    }

    svg.innerHTML = svgContent;
}
</script>

</body>
</html>
