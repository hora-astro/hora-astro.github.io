<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>FortuneWithStars - Professional Commercial Kundli</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #daa520; --bg: #fffcf5; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f4f4; margin: 0; }
        
        /* Toolbar Styling */
        .toolbar { background: white; padding: 15px; border-bottom: 4px solid var(--maroon); display: flex; gap: 10px; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        .search-container { position: relative; width: 250px; }
        #suggestions { position: absolute; background: white; border: 1px solid #ccc; width: 100%; top: 42px; display: none; max-height: 200px; overflow-y: auto; z-index: 1001; }
        #suggestions div { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
        #suggestions div:hover { background: #f0f0f0; }

        /* PDF Page Styling */
        .pdf-page { width: 210mm; min-height: 297mm; margin: 20px auto; background: white; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 15px rgba(0,0,0,0.1); page-break-after: always; }
        .header { text-align: center; border: 2px double var(--maroon); padding: 15px; background: var(--bg); margin-bottom: 20px; }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-box { border: 2px solid var(--maroon); padding: 10px; text-align: center; background: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #999; padding: 10px; text-align: center; font-size: 14px; }
        th { background: #f8f8f8; color: var(--maroon); }
        
        .prediction-card { background: #fffdf0; border-left: 5px solid var(--gold); padding: 20px; margin: 20px 0; text-align: justify; line-height: 1.8; font-size: 16px; }
        h2 { color: var(--maroon); border-bottom: 2px solid var(--maroon); padding-bottom: 5px; margin-top: 30px; }
        
        #loading { display: none; text-align: center; padding: 20px; font-weight: bold; color: var(--maroon); }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित" placeholder="नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <div class="search-container">
        <input type="text" id="citySearch" placeholder="शहर खोजें..." oninput="searchLoc(this.value)">
        <div id="suggestions"></div>
    </div>
    <input type="hidden" id="lat" value="23.32">
    <input type="hidden" id="lon" value="74.26">
    <button onclick="generate()" style="background:var(--maroon); color:white; font-weight:bold; cursor:pointer;">कुंडली बनाएँ</button>
    <button onclick="downloadPDF()" style="background:green; color:white; cursor:pointer;">PDF डाउनलोड</button>
</div>

<div id="loading">गणना की जा रही है... कृपया प्रतीक्षा करें।</div>
<div id="printArea"></div>

<script>
const LORDS = ["", "मंगल", "शुक्र", "बुध", "चंद्र", "सूर्य", "बुध", "शुक्र", "मंगल", "गुरु", "शनि", "शनि", "गुरु"];
const HOUSE_TITLES = ["", "व्यक्तित्व एवं स्वभाव", "धन, वाणी एवं कुटुंब", "साहस एवं पराक्रम", "सुख, माता एवं वाहन", "शिक्षा एवं संतान", "रोग, ऋण एवं शत्रु", "विवाह एवं साझेदारी", "आयु एवं संकट", "भाग्य एवं धर्म", "करियर एवं पद-प्रतिष्ठा", "आय एवं लाभ", "व्यय एवं विदेश"];

async function searchLoc(q) {
    if(q.length < 3) return;
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const data = await res.json();
        const box = document.getElementById('suggestions');
        box.innerHTML = ""; box.style.display = "block";
        data.slice(0, 5).forEach(item => {
            let div = document.createElement('div');
            div.innerText = item.display_name;
            div.onclick = () => {
                document.getElementById('lat').value = item.lat;
                document.getElementById('lon').value = item.lon;
                document.getElementById('citySearch').value = item.display_name.split(',')[0];
                box.style.display = "none";
            };
            box.appendChild(div);
        });
    } catch(e) { console.log("Loc search error"); }
}

async function generate() {
    document.getElementById('loading').style.display = 'block';
    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };
    try {
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.status === 'success') renderUI(data);
        else alert("सर्वर त्रुटि: " + data.message);
    } catch(e) { 
        alert("कनेक्शन फेल! सुनिश्चित करें कि पाइथन कोड PythonAnywhere पर 'Reload' किया गया है।"); 
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

function renderUI(data) {
    let html = "";
    
    // पृष्ठ 1: मुख्य विवरण एवं चार्ट्स
    html += `<div class="pdf-page">
        <div class="header"><h1>॥ विस्तृत जन्म कुंडली ॥</h1><p><b>नाम:</b> ${document.getElementById('custName').value} | <b>स्थान:</b> ${document.getElementById('citySearch').value}</p></div>
        <div class="chart-grid">
            <div class="chart-box"><h3>लग्न कुंडली (D1)</h3><div id="d1_svg"></div></div>
            <div class="chart-box"><h3>नवांश कुंडली (D9)</h3><div id="d9_svg"></div></div>
        </div>
        <table>
            <tr style="background:#eee"><th>ग्रह</th><th>अंश</th><th>भाव</th><th>D9 राशि</th></tr>`;
    data.planets.forEach(p => {
        html += `<tr><td>${p.name}</td><td>${p.deg}</td><td>${p.house}</td><td>${p.d9}</td></tr>`;
    });
    html += `</table></div>`;

    // पृष्ठ 2: विंशोत्तरी महादशा
    html += `<div class="pdf-page">
        <h2>विंशोत्तरी महादशा विवरण</h2>
        <p>जन्म के समय चंद्रमा के नक्षत्र के आधार पर आपकी महादशा का क्रम इस प्रकार है:</p>
        <table>
            <tr style="background:var(--maroon); color:white;"><th>ग्रह</th><th>प्रारंभ तिथि</th><th>समाप्ति तिथि</th></tr>`;
    data.dasha.forEach(d => {
        html += `<tr><td><b>${d.lord}</b></td><td>${d.start}</td><td>${d.end}</td></tr>`;
    });
    html += `</table>
        <div class="prediction-card">
            <b>दशा फल:</b> ज्योतिष शास्त्र के अनुसार महादशा जीवन के महत्वपूर्ण पड़ावों को दर्शाती है। वर्तमान समय में चल रही महादशा के स्वामी का पूजन एवं दान जातक को सुख-समृद्धि प्रदान करता है।
        </div>
    </div>`;

    // पृष्ठ 3-14: 12 भावों का फलादेश
    for(let i=1; i<=12; i++) {
        let signIdx = (data.lagna.rIdx + i - 2) % 12 + 1;
        let lordName = LORDS[signIdx];
        let lordPos = data.planets.find(p => p.name === lordName);
        
        html += `<div class="pdf-page">
            <h2>${i} भाव विश्लेषण: ${HOUSE_TITLES[i]}</h2>
            <div class="prediction-card">
                <b>स्वामी की स्थिति:</b> आपके ${i} भाव का अधिपति <b>${lordName}</b> आपकी कुंडली के <b>${lordPos.house} वें भाव</b> में विराजमान है।
                <br><br>
                <b>विस्तृत फलादेश:</b> शास्त्रानुसार ${i} भाव के स्वामी का ${lordPos.house} भाव में होना आपके जीवन में ${HOUSE_TITLES[i]} से संबंधित विशेष परिणाम देगा। यह स्थिति दर्शाती है कि आपको इस क्षेत्र में ${lordPos.house <= 5 ? 'सफलता' : 'परिश्रम'} की प्राप्ति होगी। 
                <br><br>
                <b>उपाय:</b> ${lordName} के मंत्र 'ॐ ${lordName}ाय नमः' का नियमित जाप करें।
            </div>
        </div>`;
    }

    document.getElementById('printArea').innerHTML = html;
    
    // चार्ट ड्रा करने के लिए स्मॉल डिले
    setTimeout(() => {
        drawChart('d1_svg', data.lagna.rIdx, data.planets, 'house');
        drawChart('d9_svg', data.lagna.d9, data.planets, 'd9');
    }, 500);
}

function drawChart(id, asc, planets, mode) {
    const coords = {1:[112,85], 2:[55,47], 3:[27,85], 4:[75,132], 5:[27,172], 6:[55,210], 7:[112,172], 8:[170,210], 9:[197,172], 10:[150,132], 11:[197,85], 12:[170,47]};
    let svg = `<svg viewBox="0 0 225 240" width="100%"><path d="M0 0 L225 0 L225 225 L0 225 Z M0 0 L225 225 M225 0 L0 225 M112 0 L0 112 L112 225 L225 112 Z" fill="none" stroke="#800000" stroke-width="2"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]}" fill="maroon" font-weight="bold" font-size="14" text-anchor="middle">${sign}</text>`;
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        list.forEach((p, idx) => {
            svg += `<text x="${coords[i][0]}" y="${coords[i][1] + 12 + (idx*10)}" font-size="8" text-anchor="middle" fill="#333">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], { scale: 2 });
        if (i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save(`Professional_Kundli_Report.pdf`);
}
</script>
</body>
</html>
