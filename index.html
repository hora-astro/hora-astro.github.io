from flask import Flask, request, jsonify, make_response
from flask_cors import CORS
from flatlib.datetime import Datetime
from flatlib.geopos import GeoPos
from flatlib.chart import Chart
from flatlib import const

app = Flask(__name__)
CORS(app)

# नक्षत्र सूची
NAKSHATRAS = ["अश्विनी", "भरणी", "कृत्तिका", "रोहिणी", "मृगशिरा", "आर्द्रा", "पुनर्वसु", "पुष्य", "अश्लेषा", "मघा", "पूर्वाफाल्गुनी", "उत्तराफाल्गुनी", "हस्त", "चित्रा", "स्वाति", "विशाखा", "अनुराधा", "ज्येष्ठा", "मूल", "पूर्वाषाढ़ा", "उत्तरषाढ़ा", "श्रवण", "धनिष्ठा", "शतभिषा", "पूर्वाभाद्रपद", "उत्तरभाद्रपद", "रेवती"]
PLANETS_HI = {const.SUN:"सूर्य", const.MOON:"चंद्र", const.MARS:"मंगल", const.MERCURY:"बुध", const.JUPITER:"गुरु", const.VENUS:"शुक्र", const.SATURN:"शनि", const.NORTH_NODE:"राहु", const.SOUTH_NODE:"केतु"}

def get_details(obj):
    """ग्रह की डिग्री से राशि, नक्षत्र और पद निकालना"""
    lon = obj.lon
    r_idx = int(lon // 30) + 1 
    deg = round(lon % 30, 2)
    
    # नक्षत्र गणना (360 / 27 = 13.3333 डिग्री प्रति नक्षत्र)
    n_float = lon / (40.0/3.0)
    n_idx = int(n_float) % 27
    charan = int((n_float % 1) * 4) + 1
    
    # नवांश (D9)
    d9_sign = (int(lon // (10.0/3.0)) % 12) + 1
    
    return {"rIdx": r_idx, "deg": deg, "nak": NAKSHATRAS[n_idx], "charan": charan, "d9": d9_sign, "v_lon": lon}

@app.route('/calculate', methods=['POST', 'OPTIONS'])
def calculate():
    if request.method == "OPTIONS": return make_response("", 200)
    try:
        data = request.get_json()
        # समय और स्थान (Siderial Lahiri Mode)
        dt = Datetime(data['date'].replace('-', '/'), data['time'], '+05:30')
        pos = GeoPos(float(data.get('lat', 23.58)), float(data.get('lon', 74.44)))
        
        # मुख्य सुधार: सीधा Lahiri Mode में चार्ट लोड करना
        chart = Chart(dt, pos, mode='Lahiri')
        
        # लग्न (Ascendant)
        asc_obj = chart.get(const.ASC)
        lagna = get_details(asc_obj)
        
        planets = []
        for p_id, h_name in PLANETS_HI.items():
            obj = chart.get(p_id)
            if obj:
                det = get_details(obj)
                # भाव = (ग्रह राशि - लग्न राशि + 12) % 12 + 1
                house = (det['rIdx'] - lagna['rIdx'] + 12) % 12 + 1
                det.update({"name": h_name, "house": house})
                planets.append(det)

        return jsonify({"status": "success", "lagna": lagna, "planets": planets})
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500
