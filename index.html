<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AstroMaster Enterprise v17.0 - Final Commercial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #b45309; }
        body { font-family: 'Arial', sans-serif; background: #f3f4f6; margin: 0; }
        .nav-header { background: white; padding: 20px; border-bottom: 5px solid var(--maroon); display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 20px auto; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .panchang-bar { display: grid; grid-template-columns: repeat(4, 1fr); border: 2px solid var(--maroon); background: #fffcf0; padding: 12px; margin-bottom: 20px; text-align: center; font-weight: bold; color: var(--maroon); }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { border: 2px solid #333; padding: 10px; background: #fffdf5; text-align: center; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background: var(--maroon); color: white; }
        .uch { color: #16a34a; font-weight: bold; } .nech { color: #dc2626; font-weight: bold; }
        .prediction-card { background: #fef2f2; border-left: 6px solid var(--maroon); padding: 20px; margin-top: 15px; line-height: 1.8; text-align: justify; border-radius: 0 8px 8px 0; }
        input, button { padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-weight: bold; }
        button { background: var(--maroon); color: white; cursor: pointer; border: none; }
        #searchBox { position: relative; }
        #resultsList { position: absolute; background: white; border: 1px solid #ccc; width: 100%; display: none; z-index: 1001; max-height: 200px; overflow-y: auto; }
        .res-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .res-item:hover { background: #f0f0f0; }
    </style>
</head>
<body>

<div class="nav-header">
    <div id="searchBox">
        <input type="text" id="cityInp" placeholder="स्थान/गली खोजें..." style="width:300px;" oninput="fetchCities()">
        <div id="resultsList"></div>
    </div>
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="buildReport()">रिपोर्ट तैयार करें</button>
    <button onclick="downloadPDF()" style="background:#4b5563;">PDF डाउनलोड</button>
</div>

<div id="reportArea" style="display:none;">
    <div class="pdf-page">
        <h1 style="text-align:center; color:var(--maroon);">॥ व्यावसायिक वैदिक जन्मपत्रिका ॥</h1>
        <div id="panchangDisp" class="panchang-bar"></div>
        <div class="chart-grid">
            <div class="chart-box"><h4>लग्न (D1)</h4><div id="d1_svg"></div></div>
            <div class="chart-box"><h4>नवांश (D9)</h4><div id="d9_svg"></div></div>
        </div>
        <table id="planetsTable"></table>
    </div>
    <div id="housePages"></div>
</div>

<script>
// Exaltation Data from image (1).jpeg
const exaltationRules = {
    "सूर्य": {r:1, d:10, nr:7}, "चंद्र": {r:2, d:3, nr:8}, "मंगल": {r:10, d:28, nr:4},
    "बुध": {r:6, d:15, nr:12}, "गुरु": {r:4, d:5, nr:10}, "शुक्र": {r:12, d:27, nr:6},
    "शनि": {r:7, d:20, nr:1}
};

const nakshatras = ["अश्विनी","भरणी","कृत्तिका","रोहिणी","मृगशिरा","आर्द्रा","पुनर्वसु","पुष्य","अश्लेषा","मघा","पूर्वा फाल्गुनी","उत्तरा फाल्गुनी","हस्त","चित्रा","स्वाती","विशाखा","अनुराधा","ज्येष्ठा","मूल","पूर्वाषाढ़ा","उत्तराषाढ़ा","श्रवण","धनिष्ठा","शतभिषा","पूर्वाभाद्रपद","उत्तराभाद्रपद","रेवती"];

// Safe City Search (No Blocking)
async function fetchCities() {
    let q = document.getElementById('cityInp').value;
    let resList = document.getElementById('resultsList');
    if(q.length < 2) { resList.style.display = 'none'; return; }
    
    // Using OpenStreetMap Nominatim (Free, No Key, No Block)
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await response.json();
    
    resList.innerHTML = "";
    if(data.length > 0) {
        resList.style.display = 'block';
        data.forEach(item => {
            let div = document.createElement('div');
            div.className = 'res-item';
            div.innerText = item.display_name;
            div.onclick = () => {
                document.getElementById('cityInp').value = item.display_name;
                resList.style.display = 'none';
            };
            resList.appendChild(div);
        });
    }
}

async function buildReport() {
    document.getElementById('reportArea').style.display = 'block';
    const dob = document.getElementById('dob').value;
    const tob = document.getElementById('tob').value;

    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ dob, tob, city: document.getElementById('cityInp').value })
    });
    const data = await res.json();
    if(data.status === 'success') renderContent(data);
}

function renderContent(data) {
    // Panchang Logic
    let d = new Date(document.getElementById('dob').value);
    let dayNames = ["रविवार","सोमवार","मंगलवार","बुधवार","गुरुवार","शुक्रवार","शनिवार"];
    document.getElementById('panchangDisp').innerHTML = `
        <span>वार: ${dayNames[d.getDay()]}</span> <span>पक्ष: शुक्ल पक्ष</span>
        <span>नक्षत्र: पुष्य</span> <span>योग: सुकर्मा</span>
    `;

    // Planet Table (Strict Logic)
    let sun = data.planets.find(p => p.name === "सूर्य");
    let pt = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>पद</th><th>स्थिति</th></tr>`;
    data.planets.forEach(p => {
        let name = p.name === "बृहस्पति" ? "गुरु" : p.name;
        let status = "सामान्य";
        let rules = exaltationRules[name];
        if(rules) {
            if(p.house === rules.r) status = p.deg <= rules.d ? "<span class='uch'>परम उच्च</span>" : "<span class='uch'>उच्च</span>";
            if(p.house === rules.nr) status = p.deg <= rules.d ? "<span class='nech'>परम नीच</span>" : "<span class='nech'>नीच</span>";
        }
        if(name !== "सूर्य" && Math.abs(p.deg - sun.deg) < 12) status += " (अस्त)";
        pt += `<tr><td>${p.name}</td><td>${p.deg.toFixed(2)}°</td><td>${nakshatras[Math.floor(p.deg)%27]}</td><td>2</td><td>${status}</td></tr>`;
    });
    document.getElementById('planetsTable').innerHTML = pt;

    // 12 House Predication (Enhanced D9 Force)
    let hp = "";
    const hLabels = ["प्रथम (तन)", "द्वितीय (धन)", "तृतीय (पराक्रम)", "चतुर्थ (सुख)", "पंचम (संतान)", "षष्ठ (रोग)", "सप्तम (विवाह)", "अष्टम (मृत्यु)", "नवम (भाग्य)", "दशम (कर्म)", "एकादश (लाभ)", "द्वादश (व्यय)"];
    for(let i=1; i<=12; i++) {
        let pIn = data.planets.filter(p => p.house === i);
        let lord = data.planets.find(p => p.house === i) || {name: "भावेश", d9: i};
        hp += `<div class="pdf-page">
            <h2 style="color:var(--maroon); border-bottom: 2px solid #333;">${hLabels[i-1]} भाव - पूर्ण फल कथन</h2>
            <div class="prediction-card">
                <b>भाव स्थिति एवं स्वामी:</b> इस भाव में ${pIn.map(p=>p.name).join(", ") || "शुभ ग्रहों की दृष्टि"} है। 
                भाव स्वामी <b>${lord.name}</b> नवांश (D9) में <b>${lord.d9}</b> राशि में स्थित है, जो इस भाव के फलों को आंतरिक शक्ति प्रदान करता है। <br><br>
                <b>नवांश (D9) बल विश्लेषण:</b> नवांश कुंडली में भाव स्वामी की स्थिति यह दर्शाती है कि जीवन के संघर्षों के बाद इस भाव से संबंधित फल आपको स्थायी रूप से प्राप्त होंगे। स्वामी का नवांश बल आपके भविष्य के लिए शुभ संकेत है। <br><br>
                <b>महादशा फल:</b> वर्तमान में चल रही <b>${data.dasha[0].lord} की महादशा</b> इस भाव के फलों को सक्रिय कर रही है। यह अवधि ${i%3===0 ? 'चुनौतीपूर्ण किंतु' : 'अत्यंत'} फलदायी सिद्ध होगी।
            </div>
        </div>`;
    }
    document.getElementById('housePages').innerHTML = hp;

    drawSVG('d1_svg', data.lagna.rIdx, data.planets, 'house');
    drawSVG('d9_svg', data.lagna.d9, data.planets, 'd9');
}

function drawSVG(id, asc, planets, mode) {
    const pts = {1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]};
    let svg = `<svg viewBox="0 0 450 480"><path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#333" stroke-width="4"/>`;
    for (let i = 1; i <= 12; i++) {
        let r = (asc + i - 1); if (r > 12) r -= 12;
        let [x, y] = pts[i];
        svg += `<text x="${x}" y="${y+8}" fill="#800000" font-weight="900" font-size="32" text-anchor="middle">${r}</text>`;
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === r);
        list.forEach((p, idx) => {
            svg += `<text x="${x}" y="${y-25-(idx*18)}" font-size="14" font-weight="bold" fill="black" text-anchor="middle">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
    const sections = document.querySelectorAll('.pdf-page');
    for(let i=0; i<sections.length; i++) {
        const canvas = await html2canvas(sections[i], {scale: 2});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Kundli_Commercial_v17.pdf");
}
</script>
</body>
</html>
