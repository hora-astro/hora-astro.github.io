<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hora Astro | Final SVG Fix</title>
    <style>
        :root { --primary: #ff5722; --bg: #fdf2f0; }
        body { font-family: sans-serif; background: var(--bg); text-align: center; margin: 0; padding: 10px; }
        .card { background: white; max-width: 450px; margin: auto; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        input, button { padding: 12px; margin: 5px; width: 90%; border-radius: 8px; border: 1px solid #ddd; }
        button { background: var(--primary); color: white; font-weight: bold; border: none; cursor: pointer; }
        #suggestions { position: absolute; background: white; width: 90%; left: 5%; z-index: 100; border: 1px solid #ddd; display: none; }
        
        /* SVG Kundli Styling */
        .kundli-svg { width: 100%; max-width: 380px; height: auto; margin-top: 20px; background: white; border: 2px solid #333; }
        .line { stroke: #333; stroke-width: 2; }
        .rashi-text { fill: #d32f2f; font-size: 14px; font-weight: bold; }
        .planet-text { fill: #000; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>‡§∏‡§ü‡•Ä‡§ï SVG ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä üåå</h2>
    <div style="position:relative;">
        <input type="text" id="loc" placeholder="‡§∂‡§π‡§∞ ‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç..." oninput="searchLoc()">
        <div id="suggestions"></div>
    </div>
    <input type="hidden" id="lat"> <input type="hidden" id="lng">
    <input type="text" id="date" placeholder="YYYY/MM/DD">
    <input type="text" id="time" placeholder="HH:MM">
    <button onclick="fetchChart()">‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç</button>

    <div id="chart-area" style="display:none;">
        <svg viewBox="0 0 300 300" class="kundli-svg" id="kundliSVG">
            <rect width="300" height="300" fill="none" stroke="#333" stroke-width="2"/>
            <line x1="0" y1="0" x2="300" y2="300" class="line"/>
            <line x1="300" y1="0" x2="0" y2="300" class="line"/>
            <line x1="150" y1="0" x2="0" y2="150" class="line"/>
            <line x1="0" y1="150" x2="150" y2="300" class="line"/>
            <line x1="150" y1="300" x2="300" y2="150" class="line"/>
            <line x1="300" y1="150" x2="150" y2="0" class="line"/>
            
            <g id="rashiGroup"></g>
            <g id="planetGroup"></g>
        </svg>
    </div>
</div>

<script>
    const hNames = {"Sun":"‡§∏‡•Ç‡§∞‡•ç‡§Ø","Moon":"‡§ö‡§Ç‡§¶‡•ç‡§∞","Mercury":"‡§¨‡•Å‡§ß","Venus":"‡§∂‡•Å‡§ï‡•ç‡§∞","Mars":"‡§Æ‡§Ç‡§ó‡§≤","Jupiter":"‡§ó‡•Å‡§∞‡•Å","Saturn":"‡§∂‡§®‡§ø","North Node":"‡§∞‡§æ‡§π‡•Ç","South Node":"‡§ï‡•á‡§§‡•Å","Syzygy":"Sy","Pars Fortuna":"Pa"};

    // ‡§π‡§∞ ‡§ò‡§∞ (House) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡§ø‡§ï‡•ç‡§∏ ‡§ï‡•ã‡§Ü‡§∞‡•ç‡§°‡§ø‡§®‡•á‡§ü‡•ç‡§∏
    const houseCoords = {
        1: {rx: 145, ry: 105, px: 150, py: 125},
        2: {rx: 75, ry: 40, px: 60, py: 60},
        3: {rx: 215, ry: 40, px: 210, py: 60},
        4: {rx: 110, ry: 140, px: 85, py: 155},
        5: {rx: 40, ry: 210, px: 40, py: 230},
        6: {rx: 75, ry: 275, px: 60, py: 260},
        7: {rx: 145, ry: 205, px: 150, py: 185},
        8: {rx: 215, ry: 275, px: 210, py: 260},
        9: {rx: 250, ry: 210, px: 240, py: 230},
        10: {rx: 180, ry: 140, px: 200, py: 155},
        11: {rx: 250, ry: 40, px: 240, py: 60},
        12: {rx: 40, ry: 40, px: 40, py: 60}
    };

    function searchLoc() {
        const q = document.getElementById('loc').value;
        const s = document.getElementById('suggestions');
        if (q.length < 3) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`)
        .then(r => r.json()).then(data => {
            s.innerHTML = ""; s.style.display="block";
            data.forEach(p => {
                let d = document.createElement('div');
                d.style.padding="10px"; d.style.cursor="pointer"; d.innerText=p.display_name;
                d.onclick = () => {
                    document.getElementById('loc').value=p.display_name;
                    document.getElementById('lat').value=p.lat;
                    document.getElementById('lng').value=p.lon;
                    s.style.display="none";
                };
                s.appendChild(d);
            });
        });
    }

    async function fetchChart() {
        const lat = document.getElementById('lat').value;
        if(!lat) { alert("‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!"); return; }
        const res = await fetch(`https://hemantpurohit27.pythonanywhere.com/get_kundli?date=${document.getElementById('date').value}&time=${document.getElementById('time').value}&lat=${lat}&lng=${document.getElementById('lng').value}`);
        const result = await res.json();
        
        if (result.status === "success") {
            document.getElementById('chart-area').style.display='block';
            const rGroup = document.getElementById('rashiGroup');
            const pGroup = document.getElementById('planetGroup');
            rGroup.innerHTML = ""; pGroup.innerHTML = "";
            
            const lagna = result.asc_num;

            // 1. ‡§∞‡§æ‡§∂‡§ø‡§Ø‡§æ‡§Å ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            for (let i = 1; i <= 12; i++) {
                let rNum = ((lagna + i - 2) % 12) + 1;
                let coords = houseCoords[i];
                rGroup.innerHTML += `<text x="${coords.rx}" y="${coords.ry}" class="rashi-text">${rNum}</text>`;
            }

            // 2. ‡§ó‡•ç‡§∞‡§π ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§≠‡•Ä‡§°‡§º ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ë‡§´‡§∏‡•á‡§ü ‡§ï‡•á ‡§∏‡§æ‡§•)
            const houseCounters = {};
            result.data.forEach(p => {
                if (p.house) {
                    if(!houseCounters[p.house]) houseCounters[p.house] = 0;
                    let coords = houseCoords[p.house];
                    let offset = houseCounters[p.house] * 12; // ‡§π‡§∞ ‡§ó‡•ç‡§∞‡§π ‡§ï‡•ã ‡§•‡•ã‡§°‡§º‡§æ ‡§®‡•Ä‡§ö‡•á ‡§ñ‡§ø‡§∏‡§ï‡§æ‡§è‡§Ç
                    let name = hNames[p.name] || p.name.substring(0,2);
                    let deg = Math.floor(p.degree || 0);
                    
                    pGroup.innerHTML += `<text x="${coords.px}" y="${coords.py + offset}" class="planet-text" text-anchor="middle">${name} ${deg}¬∞</text>`;
                    houseCounters[p.house]++;
                }
            });
        }
    }
</script>
</body>
</html>
