<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hora Astro Pro | Accurate Kundli & Location Search</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #e64a19; --bg: #fff5f2; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); text-align: center; margin: 0; padding: 10px; }
        .card { background: white; max-width: 500px; margin: auto; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Input & Search Styling */
        .input-group { margin-bottom: 10px; text-align: left; }
        label { font-weight: bold; font-size: 14px; color: #555; display: block; margin-bottom: 5px; }
        input, button, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        
        /* Search Dropdown Styling */
        #location-results { position: absolute; background: white; width: 420px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; z-index: 1000; display: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .location-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
        .location-item:hover { background: #f0f0f0; }

        .tabs { display: flex; overflow-x: auto; gap: 5px; margin: 15px 0; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 12px; border: none; background: #eee; cursor: pointer; flex: 1; font-weight: bold; border-radius: 8px 8px 0 0; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; padding: 10px 0; }
        .kundli-svg { width: 100%; max-width: 350px; height: auto; background: white; border: 2px solid #333; margin: auto; }
        .line { stroke: #333; stroke-width: 1.5; }
        .rashi-text { fill: #d32f2f; font-size: 16px; font-weight: bold; }
        .planet-text { fill: #000; font-size: 11px; font-weight: bold; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; font-size: 14px; text-align: left; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="card" id="report-area">
    <h1 style="color:var(--primary); margin: 0;">Hora Astro Pro üåå</h1>
    <p style="font-size: 12px; color: #666; margin-bottom: 20px;">‡§≤‡§ó‡•ç‡§®, ‡§®‡§µ‡§æ‡§Ç‡§∂ ‡§î‡§∞ ‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó</p>
    
    <div class="no-print">
        <div class="input-group">
            <label>‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø (Date)</label>
            <input type="date" id="date" value="2006-11-06">
        </div>
        <div class="input-group">
            <label>‡§ú‡§®‡•ç‡§Æ ‡§∏‡§Æ‡§Ø (Time)</label>
            <input type="time" id="time" value="11:28">
        </div>
        
        <div class="input-group" style="position: relative;">
            <label>‡§ú‡§®‡•ç‡§Æ ‡§∏‡•ç‡§•‡§æ‡§® (Search Location)</label>
            <input type="text" id="city-search" placeholder="‡§∂‡§π‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç..." oninput="searchLocation()">
            <div id="location-results"></div>
        </div>

        <div style="display: flex; gap: 10px;">
            <input type="text" id="lat" placeholder="Lat" readonly>
            <input type="text" id="lng" placeholder="Lng" readonly>
        </div>
        
        <button onclick="fetchAllData()">‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
    </div>

    <div class="tabs no-print">
        <button class="tab-btn active" onclick="openTab(event, 'tab-d1')">D1 (‡§≤‡§ó‡•ç‡§®)</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-d9')">D9 (‡§®‡§µ‡§æ‡§Ç‡§∂)</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-panchang')">‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó</button>
    </div>

    <div id="tab-d1" class="tab-content" style="display:block;">
        <h3>‡§≤‡§ó‡•ç‡§® ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D1 Chart)</h3>
        <div id="svg-container-d1"></div>
    </div>
    <div id="tab-d9" class="tab-content">
        <h3>‡§®‡§µ‡§æ‡§Ç‡§∂ ‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä (D9 Chart)</h3>
        <div id="svg-container-d9"></div>
    </div>
    <div id="tab-panchang" class="tab-content">
        <h3>‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
        <table><tbody id="panchang-body"></tbody></table>
    </div>

    <button class="no-print" style="background:#2e7d32;" onclick="downloadPDF()">PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç üìÑ</button>
</div>

<script>
    // 1. LOCATION SEARCH FEATURE (Using Nominatim OpenStreetMaps)
    async function searchLocation() {
        const query = document.getElementById('city-search').value;
        const resultDiv = document.getElementById('location-results');
        if (query.length < 3) { resultDiv.style.display = 'none'; return; }

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
            const data = await response.json();
            
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'block';
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'location-item';
                div.innerText = item.display_name;
                div.onclick = () => {
                    document.getElementById('city-search').value = item.display_name;
                    document.getElementById('lat').value = parseFloat(item.lat).toFixed(2);
                    document.getElementById('lng').value = parseFloat(item.lon).toFixed(2);
                    resultDiv.style.display = 'none';
                };
                resultDiv.appendChild(div);
            });
        } catch (e) { console.log("Search Error", e); }
    }

    // 2. FETCH DATA FROM YOUR SERVER
    async function fetchAllData() {
        const btn = event.target;
        btn.innerText = "‡§ó‡§£‡§®‡§æ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...";
        
        try {
            const dateVal = document.getElementById('date').value.replace(/-/g, '/');
            const timeVal = document.getElementById('time').value;
            const latVal = document.getElementById('lat').value;
            const lngVal = document.getElementById('lng').value;

            if(!latVal) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!"); btn.innerText="‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç"; return; }

            const url = `https://hemantpurohit27.pythonanywhere.com/get_kundli?date=${dateVal}&time=${timeVal}&lat=${latVal}&lng=${lngVal}`;
            const res = await fetch(url);
            const result = await res.json();
            
            if(result.status === "success") {
                drawSVG("svg-container-d1", result.asc_num, result.d1_data);
                drawSVG("svg-container-d9", result.d9_asc_num, result.d9_data); 
                fillPanchang(result.panchang);
                btn.innerText = "‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç";
            } else {
                alert("‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§è‡§∞‡§∞: " + result.message);
            }
        } catch (e) {
            alert("Error fetching data! ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ö‡§æ‡§≤‡•Ç ‡§π‡•à‡•§");
            btn.innerText = "‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç";
        }
    }

    // SVG Drawing & Tabs Logic (Standard)
    const hNames = {"Sun":"‡§∏‡•Ç‡§∞‡•ç‡§Ø","Moon":"‡§ö‡§Ç‡§¶‡•ç‡§∞","Mercury":"‡§¨‡•Å‡§ß","Venus":"‡§∂‡•Å‡§ï‡•ç‡§∞","Mars":"‡§Æ‡§Ç‡§ó‡§≤","Jupiter":"‡§ó‡•Å‡§∞‡•Å","Saturn":"‡§∂‡§®‡§ø","North Node":"‡§∞‡§æ‡§π‡•Ç","South Node":"‡§ï‡•á‡§§‡•Å"};
    const coords = { 1: {rx: 150, ry: 75, px: 150, py: 110}, 2: {rx: 75, ry: 45, px: 55, py: 70}, 3: {rx: 40, ry: 75, px: 40, py: 110}, 4: {rx: 85, ry: 150, px: 55, py: 180}, 5: {rx: 40, ry: 225, px: 45, py: 255}, 6: {rx: 75, ry: 265, px: 75, py: 240}, 7: {rx: 150, ry: 220, px: 150, py: 185}, 8: {rx: 225, ry: 265, px: 225, py: 240}, 9: {rx: 265, ry: 225, px: 260, py: 255}, 10: {rx: 220, ry: 150, px: 250, py: 180}, 11: {rx: 265, ry: 75, px: 260, py: 110}, 12: {rx: 225, ry: 45, px: 245, py: 70} };

    function drawSVG(id, lagna, planets) {
        const container = document.getElementById(id);
        let svg = `<svg viewBox="0 0 300 300" class="kundli-svg"><rect width="300" height="300" fill="none" stroke="#333" stroke-width="2"/><line x1="0" y1="0" x2="300" y2="300" class="line"/><line x1="300" y1="0" x2="0" y2="300" class="line"/><line x1="150" y1="0" x2="0" y2="150" class="line"/><line x1="0" y1="150" x2="150" y2="300" class="line"/><line x1="150" y1="300" x2="300" y2="150" class="line"/><line x1="300" y1="150" x2="150" y2="0" class="line"/>`;
        for (let i = 1; i <= 12; i++) {
            let rNum = ((lagna + i - 2) % 12) + 1;
            svg += `<text x="${coords[i].rx}" y="${coords[i].ry}" class="rashi-text" text-anchor="middle">${rNum}</text>`;
        }
        const hCount = {};
        planets.forEach(p => {
            if(!hCount[p.house]) hCount[p.house] = 0;
            let c = coords[p.house];
            svg += `<text x="${c.px}" y="${c.py + (hCount[p.house]*12)}" class="planet-text" text-anchor="middle">${hNames[p.name] || p.name} ${Math.floor(p.degree)}¬∞</text>`;
            hCount[p.house]++;
        });
        container.innerHTML = svg + `</svg>`;
    }

    function openTab(evt, name) {
        document.querySelectorAll(".tab-content").forEach(t => t.style.display = "none");
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.getElementById(name).style.display = "block";
        evt.currentTarget.classList.add("active");
    }

    function fillPanchang(d) {
        document.getElementById("panchang-body").innerHTML = `<tr><td>‡§§‡§ø‡§•‡§ø</td><td>${d.tithi}</td></tr><tr><td>‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞</td><td>${d.nakshatra}</td></tr><tr><td>‡§Ø‡•ã‡§ó</td><td>${d.yoga}</td></tr><tr><td>‡§µ‡§æ‡§∞</td><td>${d.vaar}</td></tr>`;
    }

    function downloadPDF() { html2pdf().from(document.getElementById('report-area')).save('Kundli.pdf'); }
</script>
</body>
</html>
