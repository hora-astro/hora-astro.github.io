<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Professional Vedic Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #7c2d12; }
        body { font-family: 'serif'; background: #f4f4f4; margin: 0; padding: 0; }
        .no-print { background: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--main); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; background: white; margin: 20px auto; padding: 25mm; box-shadow: 0 0 10px rgba(0,0,0,0.1); border: 1px solid #ddd; page-break-after: always; }
        .section-title { background: var(--main); color: white; padding: 12px; font-size: 20px; margin-top: 25px; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid var(--main); padding: 10px; text-align: center; }
        .chart-container { display: flex; justify-content: space-around; margin: 25px 0; }
        svg { width: 320px; height: 320px; border: 2px solid var(--main); }
        .pred-text { line-height: 1.8; text-align: justify; font-size: 17px; color: #333; padding: 15px; background: #fffcf5; border-left: 4px solid var(--main); }
        input, button { padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .dasha-item { border-bottom: 1px solid #eee; padding: 5px; font-size: 14px; }
    </style>
</head>
<body>

<div class="no-print">
    <input type="text" id="uname" value="हेमंत पुरोहित" placeholder="नाम">
    <input type="text" id="cityInput" value="Banswara" placeholder="शहर का नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="generateReport()" style="background:var(--main); color:white; font-weight:bold; cursor:pointer;">विस्तृत रिपोर्ट बनाएँ</button>
    <button onclick="downloadPDF()" style="background:green; color:white; font-weight:bold; cursor:pointer;">PDF डाउनलोड</button>
</div>

<div id="reportContent">
    <div class="pdf-page">
        <h1 align="center" style="color:var(--main); margin:0;">॥ श्री गणेशाय नमः ॥</h1>
        <h2 align="center">सम्पूर्ण जन्म कुंडली विश्लेषण एवं फलादेश</h2>
        <p id="metaData" align="center" style="font-weight:bold;"></p>
        
        <div class="chart-container">
            <div><h3 align="center">लग्न कुंडली (D-1)</h3><div id="d1"></div></div>
            <div><h3 align="center">नवांश कुंडली (D-9)</h3><div id="d9"></div></div>
        </div>

        <div class="section-title">ग्रह स्पष्टीकरण एवं नक्षत्र विवरण</div>
        <table id="planetTable"></table>
    </div>

    <div class="pdf-page">
        <div class="section-title">विंशोत्तरी महादशा एवं अंतर्दशा</div>
        <div id="dashaInfo" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;"></div>
    </div>

    <div class="pdf-page">
        <div class="section-title">व्यक्तित्व एवं स्वभाव विश्लेषण</div>
        <div id="naturePred" class="pred-text"></div>
        
        <div class="section-title">करियर, धन एवं भाग्य</div>
        <div id="careerPred" class="pred-text"></div>

        <div class="section-title">विशेष ज्योतिषीय परामर्श</div>
        <div id="remedyPred" class="pred-text"></div>
    </div>
</div>

<script>
async function generateReport() {
    const city = document.getElementById('cityInput').value;
    const btn = document.querySelector('button');
    btn.innerText = "गणना चालू है...";

    try {
        // 1. Geocoding: शहर से Lat/Lon निकालना
        const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`).then(r => r.json());
        if(geo.length === 0) throw new Error("शहर नहीं मिल पाया");
        
        const lat = geo[0].lat;
        const lon = geo[0].lon;

        // 2. Server Request
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                date: document.getElementById('dob').value,
                time: document.getElementById('tob').value,
                lat: lat, lon: lon
            })
        }).then(r => r.json());

        if(res.status === 'success') render(res, city);
        else alert(res.message);

    } catch (e) {
        alert("Error: " + e.message);
    } finally {
        btn.innerText = "विस्तृत रिपोर्ट बनाएँ";
    }
}

function render(data, city) {
    const name = document.getElementById('uname').value;
    document.getElementById('metaData').innerHTML = `जातक: ${name} | स्थान: ${city} (${parseFloat(data.lat).toFixed(2)}°N, ${parseFloat(data.lon).toFixed(2)}°E) <br> तिथि: ${document.getElementById('dob').value} | समय: ${document.getElementById('tob').value}`;

    // Planet Table
    let html = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>चरण</th><th>भाव</th></tr>`;
    data.planets.forEach(p => {
        html += `<tr><td>${p.name}</td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.charan}</td><td>${p.house}</td></tr>`;
    });
    document.getElementById('planetTable').innerHTML = html;

    // Charts
    drawDiamond('d1', data.lagna.rIdx, data.planets, 'house');
    drawDiamond('d9', data.lagna.d9, data.planets, 'd9');

    // Dasha
    let dashaHtml = "";
    data.dasha.slice(0, 6).forEach(m => {
        dashaHtml += `<div style="border:1px solid #ccc; padding:10px;"><b>${m.lord} की महादशा</b> (${m.start}-${m.end})<br>`;
        m.ants.slice(0, 5).forEach(a => { dashaHtml += `<div class="dasha-item">${a.lord}: ${a.date}</div>`; });
        dashaHtml += `</div>`;
    });
    document.getElementById('dashaInfo').innerHTML = dashaHtml;

    // Advanced Predictions
    const getP = (n) => data.planets.find(p => p.name === n);
    const sun=getP("सूर्य"), sat=getP("शनि"), jup=getP("गुरु");

    document.getElementById('naturePred').innerHTML = `आपका जन्म <b>${data.lagna.nak}</b> नक्षत्र में हुआ है। आप एक आत्मविश्वासी और स्पष्टवादी व्यक्ति हैं। लग्न के स्वामी की स्थिति यह दर्शाती है कि आप अपने जीवन के फैसले खुद लेना पसंद करते हैं और समाज में आपकी एक विशिष्ट पहचान होगी।`;
    
    let cp = `दशम भाव (कर्म स्थान) का सूक्ष्म विश्लेषण दर्शाता है कि `;
    if(sat.house === 10 || sat.house === 11) cp += "शनि की मजबूत स्थिति आपको तकनीकी, निर्माण या प्रशासनिक क्षेत्र में बड़ी सफलता दिलाएगी। ";
    else cp += "आप व्यापार और प्रबंधन के क्षेत्र में विशेष उन्नति करेंगे। आर्थिक रूप से 32 वर्ष की आयु के बाद आपका स्वर्ण काल शुरू होगा। ";
    document.getElementById('careerPred').innerHTML = cp;

    document.getElementById('remedyPred').innerHTML = `कुंडली के अनुसार, आपको <b>${jup.name}</b> की मजबूती के लिए गुरुवार को केसर का तिलक लगाना चाहिए। सूर्य देव को जल देना आपके आत्मविश्वास और करियर में आ रही बाधाओं को दूर करेगा। शनिवार को तिल के तेल का दान करना आपके लिए श्रेष्ठ रहेगा।`;
}

function drawDiamond(id, asc, planets, key) {
    const pts = {1:[160,130], 2:[80,60], 3:[40,120], 4:[120,170], 5:[40,230], 6:[80,290], 7:[160,220], 8:[240,290], 9:[280,230], 10:[200,170], 11:[280,120], 12:[240,60]};
    let svg = `<svg viewBox="0 0 320 320"><path d="M0 0 L320 0 L320 320 L0 320 Z M0 0 L320 320 M320 0 L0 320 M160 0 L0 160 L160 320 L320 160 Z" fill="none" stroke="#7c2d12" stroke-width="2"/>`;
    for(let i=1; i<=12; i++) {
        let r = (asc + i - 1); if(r > 12) r -= 12;
        svg += `<text x="${pts[i][0]}" y="${pts[i][1]}" fill="red" font-weight="bold" font-size="18" text-anchor="middle">${r}</text>`;
        planets.filter(p => p[key] === i).forEach((p, idx) => {
            svg += `<text x="${pts[i][0]}" y="${pts[i][1] + 18 + (idx*14)}" font-size="11" font-weight="bold" text-anchor="middle">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], {scale: 2});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Deep_Astro_Report.pdf");
}
</script>
</body>
</html>
