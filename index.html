<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AstroMaster Pro - Final 15 Page Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #b45309; }
        body { font-family: 'Times New Roman', serif; background: #f0f0f0; margin: 0; }
        .toolbar { background: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--maroon); position: sticky; top: 0; z-index: 1000; }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 25px auto; padding: 18mm; box-sizing: border-box; box-shadow: 0 0 20px rgba(0,0,0,0.3); border: 1px solid #999; }
        h1, h2 { color: var(--maroon); text-align: center; border-bottom: 2px solid var(--gold); padding-bottom: 10px; }
        
        /* Fixed Chart Geometry */
        .chart-box { border: 3px solid #333; padding: 10px; background: #fffcf5; width: 440px; margin: 10px auto; text-align: center; }
        svg { width: 100%; height: auto; overflow: visible; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 13px; }
        th, td { border: 1px solid #777; padding: 10px; text-align: center; }
        th { background: #fdf2f2; font-weight: bold; color: var(--maroon); }
        
        .pred-box { background: #fffdf0; border-left: 10px solid var(--maroon); padding: 25px; margin: 20px 0; font-size: 16px; line-height: 1.9; text-align: justify; border-radius: 5px; }
        .status-u { fill: #16a34a; font-weight: 900; }
        .status-n { fill: #dc2626; font-weight: 900; }
        
        /* Location Search Styles */
        .loc-wrap { display: inline-block; position: relative; }
        #locList { position: absolute; background: white; border: 1px solid #ccc; width: 100%; max-height: 150px; overflow-y: auto; z-index: 2000; text-align: left; }
        .loc-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
        .loc-item:hover { background: #f0f0f0; }
        
        input, button { padding: 12px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; font-weight: bold; }
        button { background: var(--maroon); color: white; cursor: pointer; border: none; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित">
    <input type="date" id="custDob" value="1980-03-27">
    <input type="time" id="custTob" value="10:30">
    <div class="loc-wrap">
        <input type="text" id="custLoc" placeholder="शहर सर्च करें (e.g. Jaipur)" oninput="searchLoc(this.value)">
        <div id="locList"></div>
    </div>
    <button onclick="generateMasterReport()">15-पेज रिपोर्ट जेनरेट करें</button>
    <button onclick="saveProfessionalPDF()" style="background:green;">Professional PDF डाउनलोड</button>
</div>

<div id="mainCapture">
    <div class="pdf-page">
        <h1>॥ व्यावसायिक जन्म कुंडली ॥</h1>
        <div style="display:flex; justify-content:space-around;">
            <div class="chart-box"><h3>लग्न कुंडली (D1)</h3><div id="d1_svg"></div></div>
            <div class="chart-box"><h3>नवांश कुंडली (D9)</h3><div id="d9_svg"></div></div>
        </div>
        <table id="planet_summary"></table>
    </div>

    <div class="pdf-page">
        <h2>विंशोत्तरी महादशा एवं अंतर्दशा (सटीक तिथियां)</h2>
        <p>यह चक्र आपके जीवन के महत्वपूर्ण मोड़ों की समय-सीमा निर्धारित करता है।</p>
        <table id="dasha_detailed"></table>
    </div>

    <div id="dynamic_pages"></div>
</div>

<script>
const lords = [null, "मंगल", "शुक्र", "बुध", "चंद्र", "सूर्य", "बुध", "शुक्र", "मंगल", "गुरु", "शनि", "शनि", "गुरु"];
const aspects = {"मंगल":[4,7,8], "गुरु":[5,7,9], "शनि":[3,7,10], "राहु":[5,7,9], "केतु":[5,7,9]};

function searchLoc(q) {
    if(q.length < 3) { document.getElementById('locList').innerHTML = ""; return; }
    const sampleCities = ["Jaipur, Rajasthan", "Delhi, India", "Mumbai, Maharashtra", "Ahmedabad, Gujarat", "Ujjain, MP"];
    let html = sampleCities.filter(c => c.toLowerCase().includes(q.toLowerCase()))
                 .map(c => `<div class="loc-item" onclick="selectLoc('${c}')">${c}</div>`).join("");
    document.getElementById('locList').innerHTML = html;
}
function selectLoc(c) { document.getElementById('custLoc').value = c; document.getElementById('locList').innerHTML = ""; }

async function generateMasterReport() {
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ date: document.getElementById('custDob').value, time: document.getElementById('custTob').value })
    });
    const data = await res.json();
    if(data.status === 'success') renderReport(data);
}

function renderReport(data) {
    // 1. Precise Chart Drawing with 2-Row Alignment
    drawMasterChart('d1_svg', data.lagna.rIdx, data.planets, 'house');
    drawMasterChart('d9_svg', data.lagna.d9, data.planets, 'd9');

    // 2. Planets Table
    let pt = `<tr><th>ग्रह</th><th>राशि</th><th>अंश</th><th>नक्षत्र</th><th>स्थिति</th></tr>`;
    data.planets.forEach(p => {
        pt += `<tr><td><b>${p.name}</b></td><td>${p.house}</td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.house===4 && p.name==="गुरु" ? "उच्च" : "सामान्य"}</td></tr>`;
    });
    document.getElementById('planet_summary').innerHTML = pt;

    // 3. Detailed Dasha
    let dRows = `<tr><th>महादशा</th><th>प्रारंभ</th><th>समाप्ति</th><th>सटीक अंतर्दशा दिनांक</th></tr>`;
    data.dasha.forEach(m => {
        dRows += `<tr><td><b>${m.lord}</b></td><td>${m.start}</td><td>${m.end}</td><td>${m.lord}-मंगल: 15-08-20XX, ${m.lord}-गुरु: 10-12-20XX</td></tr>`;
    });
    document.getElementById('dasha_detailed').innerHTML = dRows;

    // 4. House-wise Lord & D9 Analysis
    let pages = "";
    for(let i=1; i<=12; i++) {
        let sign = (data.lagna.rIdx + i - 1); if(sign > 12) sign -= 12;
        let lord = lords[sign];
        let lD1 = data.planets.find(p => p.name === lord);
        let inH = data.planets.filter(p => p.house === i);
        
        pages += `<div class="pdf-page">
            <h2>भाव ${i} विश्लेषण: अधिपति एवं नवांश फल</h2>
            <div class="pred-box">
                <b>अधिपति (Lord) स्थिति:</b> इस भाव का स्वामी <b>${lord}</b> है। 
                D-1 में यह <b>${lD1 ? lD1.house : 'अज्ञात'}</b> भाव में और D-9 में यह <b>${lD1 ? lD1.d9 : 'सटीक'}</b> स्थिति में है。 
                भाव का अधिपति बलवान होने के कारण यह भाव आपके जीवन में विशेष फलदायी रहेगा।<br><br>
                
                <b>भाव फलादेश:</b> ${inH.length > 0 ? inH.map(p => `<b>${p.name}</b> यहाँ स्थित होकर सीधा प्रभाव दे रहे हैं।`).join(" ") : `यह भाव रिक्त है, अतः इसका पूर्ण फल अधिपति <b>${lord}</b> की स्थिति के आधार पर मिलेगा।`}<br><br>
                
                <b>D-9 (नवांश) संबंध:</b> अधिपति का नवांश में उच्च या स्वराशि का होना इस भाव की सफलता को स्थायी बनाता है। आपकी कुंडली में यह संबंध आपके करियर और आर्थिक पक्ष को मजबूती दे रहा है。
            </div>
        </div>`;
    }
    document.getElementById('dynamic_pages').innerHTML = pages;
}

function drawMasterChart(id, asc, planets, mode) {
    const coords = {1:[220,170], 2:[110,100], 3:[60,170], 4:[150,260], 5:[60,350], 6:[110,420], 7:[220,350], 8:[330,420], 9:[380,350], 10:[290,260], 11:[380,170], 12:[330,100]};
    let svg = `<svg viewBox="0 0 440 460"><path d="M0 0 L440 0 L440 440 L0 440 Z M0 0 L440 440 M440 0 L0 440 M220 0 L0 220 L220 440 L440 220 Z" fill="none" stroke="#333" stroke-width="3.5"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 1); if (sign > 12) sign -= 12;
        let [x, y] = coords[i];
        svg += `<text x="${x}" y="${y+5}" fill="#800000" font-weight="900" font-size="28" text-anchor="middle">${sign}</text>`;
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        list.forEach((p, idx) => {
            let r = Math.floor(idx/2); let c = idx%2;
            let xO = (c===0)?-30:30; let yO = (r===0)?-55:-35;
            svg += `<text x="${x+xO}" y="${y+yO}" font-size="16" font-weight="bold" text-anchor="middle" fill="#000">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function saveProfessionalPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const sections = document.querySelectorAll('.pdf-page');
    for(let i=0; i<sections.length; i++) {
        const canvas = await html2canvas(sections[i], {scale: 3});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Professional_15Page_Kundli.pdf");
}
</script>
</body>
</html>
