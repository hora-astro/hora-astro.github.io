<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hora Astro | Complete Professional Fix</title>
    <style>
        :root { --primary: #ff5722; --bg: #fdf2f0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); text-align: center; margin: 0; padding: 10px; }
        .card { background: white; max-width: 450px; margin: auto; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Location Dropdown Style */
        .search-box { position: relative; width: 100%; }
        #suggestions { 
            position: absolute; background: white; width: 95%; left: 2.5%; 
            z-index: 1000; border: 1px solid #ddd; border-radius: 0 0 8px 8px;
            max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        .suggest-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
        .suggest-item:hover { background: #f0f0f0; }

        input, button { width: 95%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #e64a19; }

        .kundli-svg { width: 100%; height: auto; background: white; border: 2px solid #333; margin-top: 20px; }
        .line { stroke: #333; stroke-width: 2; }
        .rashi-text { fill: #d32f2f; font-size: 16px; font-weight: bold; }
        .planet-text { fill: #000; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h1 style="color:var(--primary); margin: 10px 0;">Hora Astro üåå</h1>
    
    <div class="search-box">
        <input type="text" id="loc" placeholder="‡§∂‡§π‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á Banswara)..." autocomplete="off">
        <div id="suggestions"></div>
    </div>
    
    <input type="hidden" id="lat"> <input type="hidden" id="lng">
    <input type="text" id="date" placeholder="YYYY/MM/DD (‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø)">
    <input type="text" id="time" placeholder="HH:MM (‡§∏‡§Æ‡§Ø)">
    
    <button onclick="fetchChart()">‡§ï‡•Å‡§Ç‡§°‡§≤‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç</button>

    <div id="chart-area" style="display:none;">
        <svg viewBox="0 0 300 300" class="kundli-svg">
            <rect width="300" height="300" fill="none" stroke="#333" stroke-width="2"/>
            <line x1="0" y1="0" x2="300" y2="300" class="line"/>
            <line x1="300" y1="0" x2="0" y2="300" class="line"/>
            <line x1="150" y1="0" x2="0" y2="150" class="line"/>
            <line x1="0" y1="150" x2="150" y2="300" class="line"/>
            <line x1="150" y1="300" x2="300" y2="150" class="line"/>
            <line x1="300" y1="150" x2="150" y2="0" class="line"/>
            <g id="rashiLayer"></g>
            <g id="planetLayer"></g>
        </svg>
    </div>
</div>

<script>
    const hNames = {"Sun":"‡§∏‡•Ç‡§∞‡•ç‡§Ø","Moon":"‡§ö‡§Ç‡§¶‡•ç‡§∞","Mercury":"‡§¨‡•Å‡§ß","Venus":"‡§∂‡•Å‡§ï‡•ç‡§∞","Mars":"‡§Æ‡§Ç‡§ó‡§≤","Jupiter":"‡§ó‡•Å‡§∞‡•Å","Saturn":"‡§∂‡§®‡§ø","North Node":"‡§∞‡§æ‡§π‡•Ç","South Node":"‡§ï‡•á‡§§‡•Å","Syzygy":"Sy","Pars Fortuna":"Pa"};

    // Houses ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ Coordinates
    const coords = {
        1: {rx: 150, ry: 70, px: 150, py: 110},
        2: {rx: 70, ry: 40, px: 50, py: 65},
        3: {rx: 40, ry: 70, px: 45, py: 110},
        4: {rx: 75, ry: 150, px: 50, py: 185},
        5: {rx: 40, ry: 220, px: 45, py: 255},
        6: {rx: 70, ry: 260, px: 80, py: 245},
        7: {rx: 150, ry: 220, px: 150, py: 180},
        8: {rx: 230, ry: 260, px: 220, py: 245},
        9: {rx: 260, ry: 220, px: 255, py: 255},
        10: {rx: 225, ry: 150, px: 250, py: 185},
        11: {rx: 260, ry: 70, px: 255, py: 110},
        12: {rx: 230, ry: 40, px: 250, py: 65}
    };

    // 1. Location Suggestion Logic
    const locInput = document.getElementById('loc');
    const suggestDiv = document.getElementById('suggestions');

    locInput.oninput = async () => {
        const q = locInput.value;
        if(q.length < 3) { suggestDiv.style.display = 'none'; return; }
        
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
        const data = await res.json();
        
        suggestDiv.innerHTML = "";
        if(data.length > 0) {
            suggestDiv.style.display = 'block';
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggest-item';
                div.innerText = item.display_name;
                div.onclick = () => {
                    locInput.value = item.display_name;
                    document.getElementById('lat').value = item.lat;
                    document.getElementById('lng').value = item.lon;
                    suggestDiv.style.display = 'none';
                };
                suggestDiv.appendChild(div);
            });
        }
    };

    // 2. Kundli Logic
    async function fetchChart() {
        const lat = document.getElementById('lat').value;
        const lng = document.getElementById('lng').value;
        if(!lat) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡•á ‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!"); return; }

        const url = `https://hemantpurohit27.pythonanywhere.com/get_kundli?date=${document.getElementById('date').value}&time=${document.getElementById('time').value}&lat=${lat}&lng=${lng}`;
        
        const res = await fetch(url);
        const result = await res.json();
        
        if (result.status === "success") {
            document.getElementById('chart-area').style.display = 'block';
            const rLayer = document.getElementById('rashiLayer');
            const pLayer = document.getElementById('planetLayer');
            rLayer.innerHTML = ""; pLayer.innerHTML = "";
            
            // ‡§≤‡§ó‡•ç‡§® ‡§î‡§∞ ‡§∞‡§æ‡§∂‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§∏‡§π‡•Ä ‡§ï‡•ç‡§∞‡§Æ (Counter-Clockwise)
            const lagnaRashi = result.asc_num;
            for (let i = 1; i <= 12; i++) {
                let rNum = ((lagnaRashi + i - 2) % 12) + 1;
                let c = coords[i];
                rLayer.innerHTML += `<text x="${c.rx}" y="${c.ry}" class="rashi-text" text-anchor="middle">${rNum}</text>`;
            }

            // ‡§ó‡•ç‡§∞‡§π‡•ã‡§Ç ‡§ï‡•ã ‡§µ‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡§æ
            const hCount = {};
            result.data.forEach(p => {
                if (p.house) {
                    if(!hCount[p.house]) hCount[p.house] = 0;
                    let c = coords[p.house];
                    let offset = hCount[p.house] * 12;
                    let name = hNames[p.name] || p.name.substring(0,2);
                    let deg = Math.floor(p.degree || 0);
                    
                    pLayer.innerHTML += `<text x="${c.px}" y="${c.py + offset}" class="planet-text" text-anchor="middle">${name} ${deg}¬∞</text>`;
                    hCount[p.house]++;
                }
            });
        }
    }
</script>
</body>
</html>
