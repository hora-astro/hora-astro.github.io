<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroPro Universal - सम्पूर्ण फलादेश रिपोर्ट</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #7c2d12; --accent: #b91c1c; --gold: #b45309; --paper: #fffdf5; }
        body { font-family: 'Segoe UI', serif; background: #f0f2f5; margin: 0; color: #1a202c; }
        .no-print { background: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--main); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 20px auto; padding: 15mm; box-sizing: border-box; border-radius: 2px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .header { text-align: center; border-bottom: 2px solid var(--main); padding-bottom: 10px; margin-bottom: 25px; }
        .section-title { background: linear-gradient(90deg, var(--main), var(--gold)); color: white; padding: 12px; font-size: 18px; margin: 25px 0 15px; border-radius: 4px; font-weight: bold; clear: both; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { text-align: center; background: #fff; padding: 10px; border: 1px solid #eee; }
        svg { width: 330px; height: 330px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: center; }
        th { background: #fff7ed; color: var(--main); font-weight: 700; }
        .house-analysis { margin-bottom: 15px; padding: 15px; background: var(--paper); border-left: 5px solid var(--main); line-height: 1.8; text-align: justify; font-size: 15px; border-radius: 0 4px 4px 0; }
        .dasha-row { display: grid; grid-template-columns: 1fr 1fr 1fr; border-bottom: 1px solid #edf2f7; padding: 8px 0; font-size: 14px; }
        .dasha-header { font-weight: bold; background: #f8fafc; padding: 10px 0; border-top: 2px solid #e2e8f0; }
        input, button { padding: 12px; border-radius: 6px; border: 1px solid #cbd5e1; margin: 5px; font-size: 14px; }
        button { background: var(--main); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: var(--accent); transform: translateY(-1px); }
    </style>
</head>
<body>

<div class="no-print">
    <input type="text" id="uname" value="हेमंत पुरोहित" placeholder="नाम लिखें">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="generateFullReport()">सम्पूर्ण विस्तृत फलादेश जेनरेट करें</button>
    <button onclick="downloadPDF()" style="background:green;">PDF सेव करें</button>
</div>

<div id="reportArea">
    <div class="pdf-page">
        <div class="header">
            <h2 style="color:var(--main); margin:0;">॥ श्री गणेशाय नमः ॥</h2>
            <h3 style="margin:8px 0;">जन्म कुंडली एवं विस्तृत भविष्यवाणियां</h3>
            <p id="bio" style="font-size: 16px; color: var(--gold);"></p>
        </div>

        <div class="chart-grid">
            <div class="chart-container">
                <h4 style="margin:5px 0;">लग्न कुंडली (Lagna - D1)</h4>
                <div id="d1Chart"></div>
            </div>
            <div class="chart-container">
                <h4 style="margin:5px 0;">नवांश कुंडली (Navamsha - D9)</h4>
                <div id="d9Chart"></div>
            </div>
        </div>

        <div class="section-title">ग्रह स्पष्टीकरण एवं गोचर स्थिति</div>
        <table id="planetTable"></table>
    </div>

    <div class="pdf-page">
        <div class="section-title">द्वादश भाव (12 Houses) - सूक्ष्म फलादेश</div>
        <div id="detailedPredictions"></div>
    </div>

    <div class="pdf-page">
        <div class="section-title">विंशोत्तरी महादशा एवं अंतर्दशा चक्र</div>
        <div id="dashaSection"></div>

        <div class="section-title">विशेष दृष्टि प्रभाव एवं ज्योतिषीय परामर्श</div>
        <div class="house-analysis" id="specialRemedies"></div>
    </div>
</div>

<script>
async function generateFullReport() {
    const response = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            date: document.getElementById('dob').value, 
            time: document.getElementById('tob').value 
        })
    });
    const data = await response.json();
    if(data.status === 'success') renderReport(data);
}

function renderReport(data) {
    document.getElementById('bio').innerText = `जातक: ${document.getElementById('uname').value} | जन्म तिथि: ${document.getElementById('dob').value} | समय: ${document.getElementById('tob').value}`;
    
    // 1. Planet Table
    let table = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>पद</th><th>भाव</th></tr>`;
    data.planets.forEach(p => {
        table += `<tr><td><b>${p.name}</b></td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.charan}</td><td>${p.house}</td></tr>`;
    });
    document.getElementById('planetTable').innerHTML = table;

    // 2. Optimized Charts (Centered Elements)
    drawChart('d1Chart', data.lagna.rIdx, data.planets, 'house');
    drawChart('d9Chart', data.lagna.d9, data.planets, 'd9');

    // 3. Extended 12 House Predictions
    let houseHtml = "";
    const hDescriptions = [
        "प्रथम (लग्न): यह आपके व्यक्तित्व, स्वास्थ्य और आत्म-सम्मान का भाव है।",
        "द्वितीय (धन): यह कुटुंब, वाणी और संचित धन का भाव है।",
        "तृतीय (सहज): यह पराक्रम, छोटे भाई-बहन और साहस का भाव है।",
        "चतुर्थ (सुख): यह माता, भूमि, भवन और मानसिक शांति का भाव है।",
        "पंचम (बुद्धि): यह संतान, विद्या और पूर्व पुण्य का भाव है।",
        "षष्ठ (रिपु): यह रोग, ऋण, शत्रु और प्रतियोगिता का भाव है।",
        "सप्तम (कलत्र): यह वैवाहिक जीवन और व्यापारिक साझेदारी का भाव है।",
        "अष्टम (आयु): यह आयु, गुप्त ज्ञान और आकस्मिक घटनाओं का भाव है।",
        "नवम (भाग्य): यह धर्म, पिता और उच्च शिक्षा का भाव है।",
        "दशम (कर्म): यह आपके करियर, पद-प्रतिष्ठा और सामाजिक सम्मान का भाव है।",
        "एकादश (आय): यह लाभ, बड़ी इच्छाओं की पूर्ति और मित्रों का भाव है।",
        "द्वादश (व्यय): यह खर्च, मोक्ष और विदेश यात्रा का भाव है।"
    ];

    for(let i=1; i<=12; i++) {
        let pInH = data.planets.filter(p => p.house === i).map(p => p.name);
        houseHtml += `<div class="house-analysis"><b>● ${hDescriptions[i-1]}</b><br>`;
        if(pInH.length > 0) {
            houseHtml += `इस भाव में <b>${pInH.join(", ")}</b> विराजमान हैं। यह स्थिति दर्शाती है कि जीवन के इस क्षेत्र में आपकी ऊर्जा का विशेष प्रवाह रहेगा। ग्रहों के प्रभाव से आपको यहाँ मिश्रित परन्तु प्रभावशाली परिणाम प्राप्त होंगे। नक्षत्रों की स्थिति के अनुसार यह समय आपके लिए निर्णायक सिद्ध हो सकता है।`;
        } else {
            houseHtml += `इस भाव का स्वामी केंद्र/त्रिकोण में स्थित होने से इस भाव से जुड़े शुभ फलों में वृद्धि होगी। यहाँ कोई पाप ग्रह न होने से स्थिरता बनी रहेगी।`;
        }
        houseHtml += `</div>`;
    }
    document.getElementById('detailedPredictions').innerHTML = houseHtml;

    // 4. Full Dasha Table
    let dHtml = `<div class="dasha-row dasha-header"><span>ग्रह</span><span>आरंभ</span><span>समाप्ति</span></div>`;
    data.dasha.forEach(m => {
        dHtml += `<div class="dasha-row" style="background:#fef3c7;"><span><b>${m.lord} (महा)</b></span><span>${m.start}</span><span>${m.end}</span></div>`;
        ["शुक्र","सूर्य","चंद्र","मंगल","राहु","गुरु","शनि","बुध","केतु"].forEach((al, idx) => {
            if(idx < 2) dHtml += `<div class="dasha-row" style="padding-left:20px; color:#4a5568;"><span>└ ${al} (अंतरा)</span><span>${m.start + idx}</span><span>${m.start + idx + 1}</span></div>`;
        });
    });
    document.getElementById('dashaSection').innerHTML = dHtml;

    // 5. Aspects & Remedies
    document.getElementById('specialRemedies').innerHTML = `
        <b>दृष्टि संबंध विश्लेषण:</b> आपकी कुंडली में शनि की दृष्टि कर्म भाव पर होने से कार्यों में विलंब संभव है परन्तु सफलता निश्चित है। गुरु का प्रभाव आपके भाग्य भाव को सुदृढ़ कर रहा है। <br><br>
        <b>सटीक उपाय:</b> <br>
        1. प्रतिदिन 'ॐ नमो भगवते वासुदेवाय' का जाप करें। <br>
        2. शनिवार को पीपल के वृक्ष के नीचे सरसों के तेल का दीपक जलाएं। <br>
        3. पक्षियों को सप्तधान (7 अनाज) खिलाएं।
    `;
}

function drawChart(id, ascSign, planets, mode) {
    // Exact centers for North Indian Chart Houses to prevent bleeding into other houses
    const pts = {
        1: [165, 150],  2: [85, 90],    3: [50, 150], 
        4: [120, 215],  5: [50, 280],   6: [85, 335], 
        7: [165, 280],  8: [245, 335],  9: [280, 280], 
        10: [210, 215], 11: [280, 150], 12: [245, 90]
    };

    let svg = `<svg viewBox="0 0 330 380">
        <path d="M0 0 L330 0 L330 330 L0 330 Z M0 0 L330 330 M330 0 L0 330 M165 0 L0 165 L165 330 L330 165 Z" 
              fill="none" stroke="#7c2d12" stroke-width="2"/>`;

    for (let i = 1; i <= 12; i++) {
        let sign = (ascSign + i - 1); if (sign > 12) sign -= 12;
        
        // Sign Number (Small & Clear)
        svg += `<text x="${pts[i][0]}" y="${pts[i][1] - 15}" fill="#b91c1c" font-weight="bold" font-size="16" text-anchor="middle">${sign}</text>`;

        let inHouse = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        
        inHouse.forEach((p, idx) => {
            // Stack planets vertically within the house boundaries
            svg += `<text x="${pts[i][0]}" y="${pts[i][1] + 8 + (idx * 15)}" font-size="12" font-weight="bold" text-anchor="middle" fill="#333">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], {scale: 2.5});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Kundli_Vishesh_Analysis.pdf");
}
</script>
</body>
</html>
