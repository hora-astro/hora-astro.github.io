<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortuneWithStars Pro - Commercial Astrology Software</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #daa520; --bg-light: #fffcf5; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f0f0; margin: 0; color: #333; }
        
        /* Toolbar */
        .toolbar { background: white; padding: 15px; border-bottom: 4px solid var(--maroon); display: flex; gap: 10px; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex-wrap: wrap; }
        input, button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        button { font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-gen { background: var(--maroon); color: white; border: none; }
        .btn-pdf { background: #27ae60; color: white; border: none; }
        button:hover { opacity: 0.8; }

        /* Search Suggestions */
        .search-container { position: relative; width: 220px; }
        #suggestions { position: absolute; background: white; border: 1px solid #ccc; width: 100%; top: 42px; display: none; max-height: 250px; overflow-y: auto; z-index: 1001; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #suggestions div { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
        #suggestions div:hover { background: #f8f8f8; }

        /* PDF Page Styling */
        .pdf-page { width: 210mm; min-height: 297mm; margin: 20px auto; background: white; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 20px rgba(0,0,0,0.1); page-break-after: always; position: relative; }
        .page-border { border: 2px solid var(--maroon); height: 100%; padding: 10px; position: relative; }
        .header { text-align: center; border-bottom: 2px double var(--maroon); padding-bottom: 15px; margin-bottom: 20px; background: var(--bg-light); }
        
        /* Charts */
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-box { border: 1px solid var(--maroon); padding: 10px; text-align: center; background: #fff; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #999; padding: 10px; text-align: center; font-size: 13px; }
        th { background: var(--maroon); color: white; }
        .high { color: #27ae60; font-weight: bold; } /* Green for Exalted */
        .low { color: #e74c3c; font-weight: bold; }  /* Red for Debilitated */
        
        /* Dasha Styling */
        .dasha-block { margin-top: 15px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
        .dasha-header { background: #f4f4f4; padding: 10px; font-weight: bold; border-bottom: 1px solid #ddd; color: var(--maroon); }
        .antardasha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #ddd; }
        .antardasha-item { background: white; padding: 8px; font-size: 11px; text-align: left; }

        .prediction-card { background: #fffdf0; border-left: 5px solid var(--gold); padding: 15px; margin: 20px 0; font-size: 15px; line-height: 1.7; text-align: justify; }

        #loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 2000; }
    </style>
</head>
<body>

<div id="loading">कुंडली की गणना की जा रही है...</div>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित" placeholder="जातक का नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <div class="search-container">
        <input type="text" id="citySearch" placeholder="जन्म स्थान खोजें..." oninput="searchLoc(this.value)">
        <div id="suggestions"></div>
    </div>
    <input type="hidden" id="lat" value="23.32">
    <input type="hidden" id="lon" value="74.26">
    <button class="btn-gen" onclick="generate()">कुंडली बनाएँ</button>
    <button class="btn-pdf" onclick="downloadPDF()">PDF डाउनलोड</button>
</div>

<div id="printArea"></div>

<script>
const LORDS = ["", "मंगल", "शुक्र", "बुध", "चंद्र", "सूर्य", "बुध", "शुक्र", "मंगल", "गुरु", "शनि", "शनि", "गुरु"];

// 1. Location Search Functionality
async function searchLoc(q) {
    if(q.length < 3) return;
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const data = await res.json();
        const box = document.getElementById('suggestions');
        box.innerHTML = ""; box.style.display = "block";
        data.slice(0, 5).forEach(item => {
            let div = document.createElement('div');
            div.innerText = item.display_name;
            div.onclick = () => {
                document.getElementById('lat').value = item.lat;
                document.getElementById('lon').value = item.lon;
                document.getElementById('citySearch').value = item.display_name.split(',')[0];
                box.style.display = "none";
                generate(); // Auto-generate on selection
            };
            box.appendChild(div);
        });
    } catch(e) { console.log("Location fetch error"); }
}

// 2. Main Generation Function
async function generate() {
    document.getElementById('loading').style.display = 'block';
    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };

    try {
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.status === 'success') renderUI(data);
        else alert("Error: " + data.message);
    } catch(e) { 
        alert("सर्वर से संपर्क नहीं हो सका। सुनिश्चित करें कि PythonAnywhere पर कोड चल रहा है।");
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// 3. UI Rendering Logic
function renderUI(data) {
    let html = "";
    
    // PAGE 1: Basic Details, Charts, Planetary Positions
    html += `<div class="pdf-page"><div class="page-border">
        <div class="header">
            <h1 style="margin:0; color:var(--maroon);">॥ FortuneWithStars वृहद कुंडली ॥</h1>
            <p>नाम: <b>${document.getElementById('custName').value}</b> | स्थान: <b>${document.getElementById('citySearch').value}</b></p>
        </div>
        <div class="chart-grid">
            <div class="chart-box"><b>लग्न कुंडली (D1)</b><div id="d1_svg"></div></div>
            <div class="chart-box"><b>नवांश कुंडली (D9)</b><div id="d9_svg"></div></div>
        </div>
        <table>
            <tr><th>ग्रह</th><th>अंश</th><th>भाव</th><th>D1 स्थिति</th><th>D9 स्थिति</th><th>दृष्टि</th></tr>`;
    
    data.planets.forEach(p => {
        html += `<tr>
            <td><b>${p.name}</b></td>
            <td>${p.deg}</td>
            <td>${p.house}</td>
            <td class="${p.status_d1=='उच्च'?'high':(p.status_d1=='नीच'?'low':'')}">${p.status_d1}</td>
            <td class="${p.status_d9=='उच्च'?'high':(p.status_d9=='नीच'?'low':'')}">${p.status_d9}</td>
            <td>${p.aspect}वें भाव पर</td>
        </tr>`;
    });
    html += `</table>
    <div class="prediction-card">
        <b>ग्रह विश्लेषण:</b> आपकी कुंडली में उच्च के ग्रह जीवन में उन क्षेत्रों में सुगमता लाते हैं, जबकि नीच के ग्रह संघर्ष के बाद सफलता का संकेत देते हैं। सातवीं दृष्टि उस भाव को सक्रिय करती है जहाँ ग्रह की रश्मियाँ पूर्ण रूप से पड़ती हैं।
    </div>
    </div></div>`;

    // PAGE 2: Vimshottari Dasha & Antardasha
    html += `<div class="pdf-page"><div class="page-border">
        <h2 style="color:var(--maroon); border-bottom: 2px solid var(--maroon);">विंशोत्तरी महादशा एवं अंतर्दशा</h2>
        <p style="font-size:14px;">चंद्रमा के नक्षत्र पर आधारित 120 वर्ष की सटीक काल-गणना:</p>`;

    data.dashas.forEach(d => {
        html += `<div class="dasha-block">
            <div class="dasha-header">${d.lord} महादशा (${d.start} से ${d.end})</div>
            <div class="antardasha-grid">`;
        d.antardasha.forEach(ad => {
            html += `<div class="antardasha-item"><b>${d.lord}-${ad.lord}</b><br><span style="color:var(--gold)">${ad.end} तक</span></div>`;
        });
        html += `</div></div>`;
    });
    html += `</div></div>`;

    // PAGE 3: Bhav Analysis (Sample logic for repetition fix)
    html += `<div class="pdf-page"><div class="page-border">
        <h2 style="color:var(--maroon); border-bottom: 2px solid var(--maroon);">भाव फलादेश एवं विशेष विश्लेषण</h2>
        <div class="prediction-card">
            <b>लग्न भाव:</b> आपके लग्न का स्वामी <b>${LORDS[data.lagna]}</b> है। यह आपके व्यक्तित्व की नींव रखता है।
            <br><br>
            <b>कार्यक्षेत्र:</b> दशम भाव का स्वामी कुंडली में जिस स्थिति में है, वह आपके करियर में स्थिरता और समाज में मान-सम्मान को निर्धारित करता है।
        </div>
        <p style="text-align:center; margin-top:50px; color:#777;">-- रिपोर्ट समाप्त --</p>
    </div></div>`;

    document.getElementById('printArea').innerHTML = html;

    // Trigger Chart Drawing
    setTimeout(() => {
        drawChart('d1_svg', data.lagna, data.planets, 'house');
        drawChart('d9_svg', data.d9_lagna, data.planets, 'd9');
    }, 500);
}

// 4. SVG Chart Drawing (North Indian Style)
function drawChart(id, asc, planets, mode) {
    const coords = {1:[112,80], 2:[55,45], 3:[25,80], 4:[75,130], 5:[25,180], 6:[55,215], 7:[112,180], 8:[165,215], 9:[200,180], 10:[150,130], 11:[200,80], 12:[165,45]};
    let svg = `<svg viewBox="0 0 225 240" width="100%"><path d="M0 0 L225 0 L225 225 L0 225 Z M0 0 L225 225 M225 0 L0 225 M112 0 L0 112 L112 225 L225 112 Z" fill="none" stroke="maroon" stroke-width="2"/>`;
    
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]}" fill="maroon" font-weight="bold" font-size="14" text-anchor="middle">${sign}</text>`;
        
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9_sign === sign);
        
        list.forEach((p, idx) => {
            let st = (mode==='house'?p.status_d1:p.status_d9);
            let color = (st==='उच्च') ? 'green' : (st==='नीच' ? 'red' : '#333');
            let label = (st==='उच्च') ? '(U)' : (st==='नीच' ? '(N)' : '');
            svg += `<text x="${coords[i][0]}" y="${coords[i][1]+12+(idx*10)}" font-size="8" fill="${color}" font-weight="bold" text-anchor="middle">${p.name}${label}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

// 5. Professional PDF Download
async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    
    for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        if (i > 0) doc.addPage();
        doc.addImage(imgData, 'PNG', 0, 0, 210, 297);
    }
    doc.save(`${document.getElementById('custName').value}_Kundli.pdf`);
}
</script>
</body>
</html>
