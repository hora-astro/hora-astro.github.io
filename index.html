<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Sateek Kundli - सटीक कुंडली विश्लेषण</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #7c2d12; --gold: #b45309; }
        body { font-family: 'Arial', sans-serif; background: #fdfcf0; margin: 0; }
        .no-print { background: #fff; padding: 15px; text-align: center; border-bottom: 3px solid var(--main); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 10px auto; padding: 12mm; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .section-title { background: var(--main); color: white; padding: 10px; margin: 15px 0; border-radius: 4px; font-weight: bold; font-size: 18px; }
        .chart-box { display: flex; justify-content: space-around; gap: 10px; margin: 20px 0; }
        svg { width: 340px; height: 340px; background: #fff; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #fef3c7; color: var(--main); }
        .house-pred { border-left: 5px solid var(--gold); background: #fff9db; padding: 15px; margin-bottom: 12px; text-align: justify; line-height: 1.7; font-size: 15px; border-radius: 0 5px 5px 0; }
        .dasha-item { border-bottom: 1px solid #eee; padding: 8px; display: flex; justify-content: space-between; }
        input, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
        button { background: var(--main); color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #92400e; }
    </style>
</head>
<body>

<div class="no-print">
    <input type="text" id="uname" value="हेमंत पुरोहित">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="fetchData()">सटीक कुंडली जेनरेट करें</button>
    <button onclick="downloadPDF()" style="background:green;">PDF डाउनलोड</button>
</div>

<div id="reportContainer">
    <div class="pdf-page">
        <h2 align="center" style="color:var(--main); margin:0;">॥ श्री गणेशाय नमः ॥</h2>
        <h3 align="center" id="bioHeader">विस्तृत जन्म कुंडली एवं फलादेश</h3>
        
        <div class="chart-box">
            <div><h4 align="center">लग्न कुंडली (D1)</h4><div id="d1Chart"></div></div>
            <div><h4 align="center">नवांश कुंडली (D9)</h4><div id="d9Chart"></div></div>
        </div>

        <div class="section-title">ग्रह स्पष्टीकरण एवं नक्षत्र विवरण</div>
        <table id="planetTable"></table>
    </div>

    <div class="pdf-page">
        <div class="section-title">प्रत्येक भाव का विस्तृत फलादेश (House Analysis)</div>
        <div id="houseDetails"></div>
    </div>

    <div class="pdf-page">
        <div class="section-title">विंशोत्तरी दशा एवं डेट-वाइज अंतर्दशा</div>
        <div id="dashaList"></div>
        <div class="section-title">विशेष ज्योतिषीय उपाय</div>
        <div class="house-pred">
            <b>परामर्श:</b> आपकी कुंडली में युति का प्रभाव अधिक है। अनुकूलता के लिए पक्षियों को दाना डालें और गुरुवार को मंदिर में पीली वस्तुओं का दान करें। शनिवार को शनि चालीसा का पाठ मानसिक शांति प्रदान करेगा।
        </div>
    </div>
</div>

<script>
async function fetchData() {
    const response = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            date: document.getElementById('dob').value, 
            time: document.getElementById('tob').value 
        })
    });
    const data = await response.json();
    if(data.status === 'success') renderReport(data);
}

function renderReport(data) {
    document.getElementById('bioHeader').innerText = `${document.getElementById('uname').value} | ${document.getElementById('dob').value} | ${document.getElementById('tob').value}`;
    
    // Planet Table
    let pRows = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>पद</th><th>भाव</th></tr>`;
    data.planets.forEach(p => {
        pRows += `<tr><td><b>${p.name}</b></td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.charan}</td><td>${p.house}</td></tr>`;
    });
    document.getElementById('planetTable').innerHTML = pRows;

    // Charts with New Logic
    drawAccurateChart('d1Chart', data.lagna.rIdx, data.planets, 'house');
    drawAccurateChart('d9Chart', data.lagna.d9, data.planets, 'd9');

    // Detailed House Logic
    const hLabels = ["प्रथम (व्यक्तित्व)", "द्वितीय (धन)", "तृतीय (साहस)", "चतुर्थ (सुख)", "पंचम (संतान)", "षष्ठ (शत्रु)", "सप्तम (विवाह)", "अष्टम (आयु)", "नवम (भाग्य)", "दशम (करियर)", "एकादश (लाभ)", "द्वादश (व्यय)"];
    let hHtml = "";
    for(let i=1; i<=12; i++) {
        let inH = data.planets.filter(p => p.house === i).map(p => p.name).join(", ");
        hHtml += `<div class="house-pred"><b>${i}. ${hLabels[i-1]} भाव:</b><br>`;
        if(inH) hHtml += `इस भाव में <b>${inH}</b> स्थित हैं। यह संयोजन आपके जीवन के इस क्षेत्र में महत्वपूर्ण भूमिका निभाएगा। ग्रहों की युति के कारण यहाँ ऊर्जा का विशेष संचय है।`;
        else hHtml += `इस भाव का स्वामी कुंडली में मजबूत स्थिति में है, जो स्थिरता प्रदान करता है।`;
        hHtml += `</div>`;
    }
    document.getElementById('houseDetails').innerHTML = hHtml;

    // Dasha with Dates
    let dHtml = "";
    data.dasha.forEach(m => {
        dHtml += `<div class="dasha-item"><b>${m.lord} की महादशा</b> <span>${m.start} से ${m.end} तक</span></div>`;
    });
    document.getElementById('dashaList').innerHTML = dHtml;
}

function drawAccurateChart(divId, lagnaSign, planets, type) {
    // Centers Adjusted to be deep within the diamond to prevent edge bleeding
    const pos = {
        1: [170, 145], 2: [85, 85],   3: [50, 145], 
        4: [125, 215], 5: [50, 285],  6: [85, 345], 
        7: [170, 285], 8: [255, 345], 9: [290, 285], 
        10: [215, 215], 11: [290, 145], 12: [255, 85]
    };

    let svg = `<svg viewBox="0 0 340 380">
        <path d="M0 0 L340 0 L340 340 L0 340 Z M0 0 L340 340 M340 0 L0 340 M170 0 L0 170 L170 340 L340 170 Z" 
              fill="none" stroke="#7c2d12" stroke-width="2.5"/>`;

    for (let i = 1; i <= 12; i++) {
        let sign = (lagnaSign + i - 1); if (sign > 12) sign -= 12;
        
        // Sign Number (Red)
        svg += `<text x="${pos[i][0]}" y="${pos[i][1] - 18}" fill="#b91c1c" font-weight="bold" font-size="18" text-anchor="middle">${sign}</text>`;

        let list = (type === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        
        // Planet Placement Logic: Multi-line stacking
        list.forEach((p, idx) => {
            let xOff = (idx > 2) ? 22 : 0; // If more than 3 planets, move to second column
            let yOff = (idx % 3) * 16;     // Vertical spacing
            svg += `<text x="${pos[i][0] + xOff}" y="${pos[i][1] + 5 + yOff}" font-size="12" font-weight="bold" text-anchor="middle" fill="#333">${p.name}</text>`;
        });
    }
    document.getElementById(divId).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], {scale: 2.5});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Kundli_Professional_Report.pdf");
}
</script>
</body>
</html>
