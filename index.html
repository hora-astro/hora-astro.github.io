<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortuneWithStars - Professional Astro Software</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --maroon: #800000; --gold: #daa520; --bg: #fffcf5; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 0; }
        
        /* टूलबार और सर्च बॉक्स स्टाइल्स */
        .toolbar { background: white; padding: 15px; border-bottom: 4px solid var(--maroon); display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .toolbar input, .toolbar button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        .toolbar button { background: var(--maroon); color: white; cursor: pointer; font-weight: bold; border: none; }

        .search-container { position: relative; width: 200px; }
        #locationSearch { width: 100%; box-sizing: border-box; }
        #suggestions { 
            position: absolute; background: white; border: 1px solid #ccc; 
            width: 100%; top: 42px; left: 0; display: none; 
            max-height: 250px; overflow-y: auto; z-index: 9999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #suggestions div { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; line-height: 1.4; }
        #suggestions div:hover { background: #f0f0f0; color: var(--maroon); }

        /* कुंडली और रिपोर्ट स्टाइल्स */
        .pdf-page { width: 210mm; min-height: 297mm; margin: 20px auto; background: white; padding: 20mm; box-sizing: border-box; box-shadow: 0 0 15px rgba(0,0,0,0.1); position: relative; page-break-after: always; }
        .header { text-align: center; border: 2px double var(--maroon); padding: 15px; background: var(--bg); margin-bottom: 20px; }
        .header h1 { margin: 0; color: var(--maroon); font-size: 24px; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-box { border: 2px solid var(--maroon); padding: 15px; text-align: center; background: #fff; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #999; padding: 10px; text-align: center; font-size: 14px; }
        th { background: #fdf2f2; color: var(--maroon); }
        .prediction-card { background: #fffdf0; border-left: 5px solid var(--gold); padding: 15px; margin: 15px 0; line-height: 1.7; text-align: justify; }
        h2.page-title { color: var(--maroon); border-bottom: 2px solid var(--maroon); padding-bottom: 10px; }
        #loading { display: none; text-align: center; padding: 20px; font-weight: bold; color: var(--maroon); }
        @media print { .toolbar { display: none; } .pdf-page { margin: 0; box-shadow: none; } }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित" placeholder="नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    
    <div class="search-container">
        <input type="text" id="locationSearch" placeholder="शहर का नाम खोजें..." autocomplete="off" oninput="debounceSearch()">
        <div id="suggestions"></div>
    </div>

    <input type="text" id="lat" value="23.32" style="width:60px" placeholder="Lat">
    <input type="text" id="lon" value="74.26" style="width:60px" placeholder="Lon">
    
    <button onclick="generateKundli()">जेनरेट करें</button>
    <button onclick="downloadPDF()" style="background:green;">PDF डाउनलोड</button>
</div>

<div id="loading">गणना की जा रही है, कृपया प्रतीक्षा करें...</div>
<div id="printArea"></div>

<script>
// --- लोकेशन सर्च लॉजिक ---
let searchTimer;
function debounceSearch() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
        searchLocation();
    }, 500); // टाइप करने के आधा सेकंड बाद सर्च करेगा
}

async function searchLocation() {
    const query = document.getElementById('locationSearch').value;
    const suggestionsBox = document.getElementById('suggestions');
    
    if (query.length < 3) {
        suggestionsBox.style.display = 'none';
        return;
    }

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=5`);
        const results = await response.json();
        
        if (results.length > 0) {
            suggestionsBox.innerHTML = '';
            results.forEach(place => {
                const div = document.createElement('div');
                div.innerHTML = place.display_name;
                div.onclick = function() {
                    // इनपुट में नाम भरें
                    document.getElementById('locationSearch').value = place.display_name;
                    // Lat और Lon भरें
                    document.getElementById('lat').value = parseFloat(place.lat).toFixed(4);
                    document.getElementById('lon').value = parseFloat(place.lon).toFixed(4);
                    // लिस्ट छिपा दें
                    suggestionsBox.style.display = 'none';
                };
                suggestionsBox.appendChild(div);
            });
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.style.display = 'none';
        }
    } catch (error) {
        console.error("Location Error:", error);
    }
}

// बाहर क्लिक करने पर लिस्ट बंद करें
document.addEventListener('click', function(e) {
    if (e.target.id !== 'locationSearch') {
        document.getElementById('suggestions').style.display = 'none';
    }
});

// --- कुंडली लॉजिक ---
const LAGNA_CONFIG = {
    1: { name: "मेष", swami: "मंगल", info: "मेष लग्न का स्वामी मंगल है। मंगल, सूर्य और गुरु इस लग्न के लिए परम शुभ हैं।" },
    2: { name: "वृष", swami: "शुक्र", info: "वृष लग्न में शनि राजयोग कारक है। शुक्र और बुध भी शुभ फल प्रदान करते हैं।" },
    3: { name: "मिथुन", swami: "बुध", info: "मिथुन लग्न में बुध और शुक्र की मित्रता जीवन में सुख और वैभव लाती है।" },
    4: { name: "कर्क", swami: "चंद्र", info: "कर्क लग्न के लिए मंगल योगकारक होकर साहस और संपत्ति प्रदान करता है।" },
    5: { name: "सिंह", swami: "सूर्य", info: "सिंह लग्न का स्वामी सूर्य है। मंगल और गुरु इस लग्न के लिए अत्यंत भाग्यशाली हैं।" },
    6: { name: "कन्या", swami: "बुध", info: "कन्या लग्न में बुध और शुक्र की स्थिति व्यापार और बुद्धि के लिए उत्तम है।" },
    7: { name: "तुला", swami: "शुक्र", info: "तुला लग्न के लिए शनि सबसे महत्वपूर्ण ग्रह है जो सफलता सुनिश्चित करता।" },
    8: { name: "वृश्चिक", swami: "मंगल", info: "वृश्चिक लग्न के लिए चंद्र और गुरु भाग्योदय करने वाले ग्रह माने जाते हैं।" },
    9: { name: "धनु", swami: "गुरु", info: "धनु लग्न का स्वामी गुरु है। सूर्य और मंगल यहाँ राजयोग का सृजन करते हैं।" },
    10: { name: "मकर", swami: "शनि", info: "मकर लग्न में शुक्र पंचमेश और कर्मेश होकर जातक को धनी बनाता है।" },
    11: { name: "कुम्भ", swami: "शनि", info: "कुम्भ लग्न के लिए शुक्र और बुध जीवन में स्थायित्व और प्रगति देते हैं।" },
    12: { name: "मीन", swami: "गुरु", info: "मीन लग्न में चंद्र और मंगल जातक को समाज में मान-सम्मान दिलाते हैं।" }
};

const HOUSES = [
    "प्रथम भाव: व्यक्तित्व एवं स्वास्थ्य", "द्वितीय भाव: धन एवं वाणी", "तृतीय भाव: पराक्रम एवं भाई",
    "चतुर्थ भाव: सुख एवं माता", "पंचम भाव: बुद्धि एवं संतान", "षष्ठ भाव: रोग एवं शत्रु",
    "सप्तम भाव: विवाह एवं व्यापार", "अष्टम भाव: आयु एवं संकट", "नवम भाव: भाग्य एवं धर्म",
    "दशम भाव: कर्म एवं पद", "एकादश भाव: आय एवं लाभ", "द्वादश भाव: व्यय एवं विदेश"
];

async function generateKundli() {
    document.getElementById('loading').style.display = 'block';
    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };

    try {
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.status === 'success') renderReport(data);
    } catch(e) { alert("कनेक्शन फेल!"); }
    document.getElementById('loading').style.display = 'none';
}

function renderReport(data) {
    const config = LAGNA_CONFIG[data.lagna.rIdx];
    const locName = document.getElementById('locationSearch').value || "निर्धारित स्थान";
    let html = "";

    // Page 1: Main Charts & Table
    html += `<div class="pdf-page">
        <div class="header">
            <h1>॥ विस्तृत जन्म कुंडली विवरण ॥</h1>
            <p>नाम: ${document.getElementById('custName').value} | स्थान: ${locName}</p>
        </div>
        <div class="chart-grid">
            <div class="chart-box"><h3>D1 लग्न कुंडली</h3><div id="d1_main"></div></div>
            <div class="chart-box"><h3>D9 नवांश कुंडली</h3><div id="d9_main"></div></div>
        </div>
        <table>
            <tr><th>ग्रह</th><th>अंश</th><th>D1 स्थिति</th><th>D9 स्थिति</th><th>भाव</th></tr>`;
    data.planets.forEach(p => {
        html += `<tr><td>${p.name}</td><td>${p.deg}</td>
            <td class="${p.status_d1=='उच्च'?'status-u':'status-n'}">${p.status_d1||'-'}</td>
            <td class="${p.status_d9=='उच्च'?'status-u':'status-n'}">${p.status_d9||'-'}</td>
            <td>${p.house}</td></tr>`;
    });
    html += `</table></div>`;

    // Page 2: Lagna Prediction
    html += `<div class="pdf-page">
        <h2 class="page-title">${config.name} लग्न फलादेश विश्लेषण</h2>
        <div class="prediction-card"><b>लग्नेश:</b> ${config.swami}<br><br>${config.info}</div>
        <p>FortuneWithStars के अनुसार, आपके जीवन की मुख्य दिशा आपके लग्नेश की स्थिति तय करेगी।</p>
    </div>`;

    // 12 Houses Analysis...
    HOUSES.forEach((hName, idx) => {
        let houseNum = idx + 1;
        let pInHouse = data.planets.filter(p => p.house === houseNum);
        html += `<div class="pdf-page"><h2 class="page-title">अध्याय ${houseNum + 2}: ${hName}</h2><div class="prediction-card">इस भाव का आपके जीवन में विशेष महत्व है।</div>`;
        if(pInHouse.length > 0) {
            pInHouse.forEach(p => {
                html += `<div class="prediction-card"><b>${p.name} का फल:</b> यह ग्रह आपके ${houseNum} भाव में स्थित है।<p>विस्तृत विवेचना: ${p.name} की रश्मियाँ आपके व्यक्तित्व को प्रभावित कर रही हैं।</p></div>`;
            });
        } else {
            html += `<p>यह भाव रिक्त है।</p>`;
        }
        html += `</div>`;
    });

    document.getElementById('printArea').innerHTML = html;

    setTimeout(() => {
        drawChart('d1_main', data.lagna.rIdx, data.planets, 'house');
        drawChart('d9_main', 1, data.planets, 'd9');
    }, 500);
}

function drawChart(id, asc, planets, mode) {
    const coords = {1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]};
    let svg = `<svg viewBox="0 0 450 480" width="100%" height="320">
        <path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#333" stroke-width="2"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 1) > 12 ? (asc + i - 1) - 12 : (asc + i - 1);
        let [x, y] = coords[i];
        svg += `<text x="${x}" y="${y+5}" fill="maroon" font-weight="bold" font-size="22" text-anchor="middle">${sign}</text>`;
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        list.forEach((p, idx) => {
            let statusChar = "";
            if(mode === 'house' && p.status_d1) statusChar = p.status_d1 === "उच्च" ? "(U)" : "(N)";
            let color = statusChar === "(U)" ? "blue" : (statusChar === "(N)" ? "red" : "#444");
            svg += `<text x="${x}" y="${y-20-(idx*15)}" font-size="12" text-anchor="middle" fill="${color}" font-weight="bold">${p.name}${statusChar}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], { scale: 2 });
        if (i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save(`Kundli_Report_FortuneWithStars.pdf`);
}
</script>
</body>
</html>
