<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroPro - सम्पूर्ण फलादेश एवं महा-कुंडली</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #7c2d12; --gold: #b45309; --bg: #fffcf0; }
        body { font-family: 'Segoe UI', serif; background: #f3f4f6; margin: 0; color: #1f2937; }
        .no-print { background: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--main); position: sticky; top: 0; z-index: 1000; }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 15px auto; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .section-title { background: var(--main); color: white; padding: 10px; margin: 20px 0 10px; border-radius: 4px; font-weight: bold; }
        .chart-container { display: flex; justify-content: space-around; margin-bottom: 20px; }
        svg { width: 320px; height: 320px; border: 1px solid var(--main); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .house-pred { border-left: 5px solid var(--gold); background: var(--bg); padding: 12px; margin-bottom: 10px; line-height: 1.6; text-align: justify; }
        .dasha-table { width: 100%; margin-top: 10px; font-size: 12px; }
        input, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: var(--main); color: white; cursor: pointer; border: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="no-print">
    <input type="text" id="uname" value="हेमंत पुरोहित">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="generateReport()">विस्तृत रिपोर्ट जेनरेट करें</button>
    <button onclick="downloadPDF()" style="background:green;">PDF डाउनलोड</button>
</div>

<div id="reportContainer">
    <div class="pdf-page">
        <h2 align="center" style="color:var(--main); margin:0;">॥ श्री गणेशाय नमः ॥</h2>
        <h3 align="center" id="displayInfo">विस्तृत जन्म कुंडली विश्लेषण</h3>
        <div class="chart-container">
            <div><h4 align="center">लग्न कुंडली (D1)</h4><div id="d1"></div></div>
            <div><h4 align="center">नवांश कुंडली (D9)</h4><div id="d9"></div></div>
        </div>
        <div class="section-title">ग्रह स्पष्टीकरण (Siderial Lahiri)</div>
        <table id="pTable"></table>
    </div>

    <div class="pdf-page">
        <div class="section-title">प्रत्येक भाव का विस्तृत फलादेश (12 Houses Analysis)</div>
        <div id="houseDetails"></div>
    </div>

    <div class="pdf-page">
        <div class="section-title">विंशोत्तरी महादशा एवं डेट-वाइज अंतर्दशा</div>
        <div id="dashaFull"></div>
        <div class="section-title">दृष्टि संबंध एवं ज्योतिषीय उपाय</div>
        <div id="remedies" class="house-pred"></div>
    </div>
</div>

<script>
async function generateReport() {
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ date: document.getElementById('dob').value, time: document.getElementById('tob').value })
    });
    const data = await res.json();
    if(data.status === 'success') renderAll(data);
}

function renderAll(data) {
    document.getElementById('displayInfo').innerText = `${document.getElementById('uname').value} | ${document.getElementById('dob').value} | ${document.getElementById('tob').value}`;
    
    // 1. Planet Table
    let table = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>पद</th><th>भाव</th></tr>`;
    data.planets.forEach(p => {
        table += `<tr><td>${p.name}</td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.charan}</td><td><b>${p.house}</b></td></tr>`;
    });
    document.getElementById('pTable').innerHTML = table;

    // 2. Accurate Charts (Fixed Alignment)
    drawChart('d1', data.lagna.rIdx, data.planets, 'house');
    drawChart('d9', data.lagna.d9, data.planets, 'd9');

    // 3. 12 House Predictions
    let houseHtml = "";
    const houseNames = ["प्रथम (लग्न)", "द्वितीय (धन)", "तृतीय (पराक्रम)", "चतुर्थ (सुख)", "पंचम (संतान)", "षष्ठ (शत्रु)", "सप्तम (विवाह)", "अष्टम (आयु)", "नवम (भाग्य)", "दशम (करियर)", "एकादश (लाभ)", "द्वादश (व्यय)"];
    
    for(let i=1; i<=12; i++) {
        let pList = data.planets.filter(p => p.house === i).map(p => p.name).join(", ");
        houseHtml += `<div class="house-pred"><b>${i}. ${houseNames[i-1]} भाव:</b><br>`;
        if(pList) houseHtml += `इस भाव में ${pList} स्थित हैं। यह आपके जीवन के ${houseNames[i-1]} क्षेत्र में गहरी सक्रियता दर्शाता है। ग्रहों के नक्षत्र प्रभाव से आपको यहाँ विशेष परिणाम मिलेंगे।`;
        else houseHtml += `इस भाव का स्वामी शुभ स्थिति में होने से यह भाव सकारात्मक फल प्रदान करेगा।`;
        houseHtml += `</div>`;
    }
    document.getElementById('houseDetails').innerHTML = houseHtml;

    // 4. Date-wise Dasha
    let dashaHtml = "<table><tr><th>महादशा स्वामी</th><th>आरंभ तिथि</th><th>अंत तिथि</th><th>विशेष</th></tr>";
    data.dasha.forEach(m => {
        dashaHtml += `<tr style="background:#eee;"><td><b>${m.lord}</b></td><td>${m.start}</td><td>${m.end}</td><td>महादशा</td></tr>`;
        // Sample Antardasha Logic
        let aLords = ["केतु","शुक्र","सूर्य","चंद्र","मंगल","राहु","गुरु","शनि","बुध"];
        aLords.forEach((al, idx) => {
            if(idx < 3) dashaHtml += `<tr><td>└ ${al}</td><td>${m.start + idx}</td><td>${m.start + idx + 1}</td><td>अंतर्दशा</td></tr>`;
        });
    });
    document.getElementById('dashaFull').innerHTML = dashaHtml + "</table>";

    // 5. Remedies
    document.getElementById('remedies').innerHTML = `<b>दृष्टि विश्लेषण:</b> आपकी कुंडली में गुरु और शनि का विशेष दृष्टि संबंध बन रहा है। <br><b>उपाय:</b> सोमवार को शिव चालीसा का पाठ करें और पक्षियों को सात प्रकार का अनाज खिलाएं।`;
}

function drawChart(id, ascSign, planets, mode) {
    // कोऑर्डिनेट्स को सटीक नीचे खिसकाया गया है (Y-axis adjusted)
    const pts = {
        1: [160, 150],  2: [80, 90],    3: [45, 150], 
        4: [120, 215],  5: [45, 280],   6: [80, 340], 
        7: [160, 280],  8: [240, 340],  9: [275, 280], 
        10: [200, 215], 11: [275, 150], 12: [240, 90]
    };

    let svg = `<svg viewBox="0 0 320 380"><path d="M0 0 L320 0 L320 320 L0 320 Z M0 0 L320 320 M320 0 L0 320 M160 0 L0 160 L160 320 L320 160 Z" fill="none" stroke="#7c2d12" stroke-width="2"/>`;
    
    for(let i=1; i<=12; i++) {
        let sign = (ascSign + i - 1); if(sign > 12) sign -= 12;
        // राशि संख्या
        svg += `<text x="${pts[i][0]}" y="${pts[i][1] - 15}" fill="#b91c1c" font-weight="bold" font-size="16" text-anchor="middle">${sign}</text>`;
        // ग्रह
        let inH = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        inH.forEach((p, idx) => {
            svg += `<text x="${pts[i][0]}" y="${pts[i][1] + 10 + (idx*15)}" font-size="11" font-weight="bold" text-anchor="middle" fill="#333">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], {scale: 2});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Kundli_Full_Report.pdf");
}
</script>
</body>
</html>
