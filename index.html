<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Astro Pro V170</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Arial'; text-align: center; padding: 20px; }
        .card { background: white; color: black; width: 800px; margin: auto; padding: 30px; border: 5px double #8b0000; display: none; }
        .chart-svg { border: 2px solid #000; width: 400px; height: 400px; background: white; margin: 20px auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        .input-group { background: #1e293b; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #fbbf24; }
        input { padding: 10px; margin: 5px; border-radius: 5px; border: none; }
        .btn { background: #b45309; color: white; padding: 12px 25px; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; }
    </style>
</head>
<body>

<div class="input-group">
    <input type="text" id="name" placeholder="नाम" value="Hemant Purohit">
    <input type="date" id="date" value="1980-03-27">
    <input type="time" id="time" value="08:10">
    <button class="btn" onclick="buildKundli()">कुंडली बनाएँ</button>
</div>

<div id="report" class="card">
    <h2 style="color:#8b0000; margin:0;">॥ जन्म कुंडली ॥</h2>
    <p id="details"></p>
    
    <div class="chart-svg" id="chart-d1"></div>

    <table>
        <thead><tr style="background:#eee;"><th>ग्रह</th><th>राशि</th><th>अंश</th><th>भाव</th></tr></thead>
        <tbody id="p-body"></tbody>
    </table>

    <div style="margin-top:20px; padding:15px; background:#fffbeb; text-align:left; border-left:5px solid #b45309;">
        <b>फलादेश:</b> <span id="fala"></span>
    </div>
    <button onclick="savePDF()" style="margin-top:20px; background:green; color:white; border:none; padding:10px 20px; cursor:pointer;">PDF डाउनलोड करें</button>
</div>

<script>
async function buildKundli() {
    const d = document.getElementById('date').value;
    const t = document.getElementById('time').value;
    const res = await fetch(`https://hemantpurohit27.pythonanywhere.com/api/v170_precision?date=${d}&time=${t}`);
    const data = await res.json();

    document.getElementById('report').style.display = 'block';
    document.getElementById('details').innerText = `नाम: ${document.getElementById('name').value} | तिथि: ${d} | समय: ${t}`;

    // चार्ट ड्रॉइंग - यह पार्ट अब 'house' डेटा का उपयोग करेगा जो बैकएंड से आता है
    drawChart("chart-d1", data.asc, data.planets);

    // टेबल भरना
    let html = "";
    data.planets.forEach(p => {
        html += `<tr><td>${p.name}</td><td>${p.sign}</td><td>${p.deg}°</td><td><b>${p.house}</b></td></tr>`;
    });
    document.getElementById('p-body').innerHTML = html;

    // डायनामिक फलादेश
    const sun = data.planets.find(p => p.name === 'सूर्य').house;
    document.getElementById('fala').innerText = `आपका लग्न ${data.asc} है। सूर्य आपके ${sun}वें भाव में है, जो आपके करियर और सामाजिक मान-सम्मान को प्रभावित करता है।`;
}

function drawChart(divId, asc, planets) {
    // भावों के केंद्र बिंदु (House Coordinates)
    const pos = {
        1: [200, 150], 2: [100, 75], 3: [50, 150], 4: [140, 250],
        5: [50, 325], 6: [100, 400], 7: [200, 325], 8: [300, 400],
        9: [350, 325], 10: [260, 250], 11: [350, 150], 12: [300, 75]
    };

    let svg = `<svg viewBox="0 0 400 400" width="100%" height="100%">
        <path d="M0 0 L400 400 M400 0 L0 400 M200 0 L0 200 L200 400 L400 200 Z" fill="none" stroke="red" stroke-width="2"/>`;

    for (let h = 1; h <= 12; h++) {
        // राशि नंबर (लाल)
        let r_num = ((asc + h - 2) % 12) + 1;
        svg += `<text x="${pos[h][0]}" y="${pos[h][1]}" fill="red" font-weight="bold" font-size="20" text-anchor="middle">${r_num}</text>`;

        // उस भाव (h) के ग्रह (नीले)
        let pList = planets.filter(p => p.house === h).map(p => p.name).join(' ');
        if(pList) {
            svg += `<text x="${pos[h][0]}" y="${pos[h][1] + 25}" fill="blue" font-size="13" font-weight="bold" text-anchor="middle">${pList}</text>`;
        }
    }
    document.getElementById(divId).innerHTML = svg + `</svg>`;
}

function savePDF() {
    const element = document.getElementById('report');
    html2pdf().from(element).save('My_Kundli_V170.pdf');
}
</script>
</body>
</html>
