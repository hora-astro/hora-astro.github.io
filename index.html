<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Professional Kundli Software - Enterprise Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #b8860b; --bg: #fffcf5; }
        body { font-family: 'Segoe UI', Arial; background: #e0e0e0; margin: 0; }
        .toolbar { background: white; padding: 15px; border-bottom: 5px solid var(--maroon); display: flex; flex-wrap: wrap; gap: 8px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .pdf-page { width: 210mm; min-height: 297mm; margin: 20px auto; background: white; padding: 15mm; box-shadow: 0 0 15px rgba(0,0,0,0.3); page-break-after: always; }
        .data-table { width: 100%; border-collapse: collapse; border: 2px solid var(--maroon); margin-bottom: 20px; }
        .data-table td { border: 1px solid #ddd; padding: 10px; font-size: 14px; background: var(--bg); }
        .chart-box { width: 100%; height: 350px; border: 1px solid var(--maroon); margin: 10px 0; }
        .prediction-box { font-size: 16px; line-height: 1.8; color: #333; padding: 20px; border-left: 5px solid var(--gold); background: #fffdf0; text-align: justify; }
        #suggestions { position: absolute; background: white; border: 1px solid #ccc; width: 300px; display: none; z-index: 1000; }
        .suggest-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित" placeholder="नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <div style="position:relative">
        <input type="text" id="city" placeholder="शहर खोजें" oninput="searchLoc(this.value)">
        <div id="suggestions"></div>
    </div>
    Lat: <input type="text" id="lat" style="width:80px" value="23.4915">
    Lon: <input type="text" id="lon" style="width:80px" value="74.3502">
    <select id="ayMode"><option value="Lahiri">NC Lahiri</option><option value="KP">KP Ayanamsa</option></select>
    <button onclick="generate()" style="background:var(--maroon); color:white; border:none; cursor:pointer; padding:10px 20px;">कुण्डली तैयार करें</button>
    <button onclick="downloadPDF()" style="background:green; color:white; border:none; cursor:pointer; padding:10px 20px;">PDF डाउनलोड</button>
</div>

<div id="reportContainer"></div>

<script>
async function searchLoc(q) {
    if(q.length < 3) return;
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await res.json();
    let div = document.getElementById('suggestions');
    div.innerHTML = ""; div.style.display = "block";
    data.forEach(item => {
        let opt = document.createElement('div');
        opt.className = "suggest-item"; opt.innerText = item.display_name;
        opt.onclick = () => {
            document.getElementById('city').value = item.display_name.split(',')[0];
            document.getElementById('lat').value = item.lat;
            document.getElementById('lon').value = item.lon;
            div.style.display = "none";
        };
        div.appendChild(opt);
    });
}

async function generate() {
    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value,
        ayMode: document.getElementById('ayMode').value
    };
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
    });
    const data = await res.json();
    renderReport(data);
}

function renderReport(data) {
    const pan = data.panchang;
    const name = document.getElementById('custName').value;
    
    let html = `<div class="pdf-page">
        <h1 style="text-align:center; color:var(--maroon); margin-bottom:10px;">॥ वृहद ज्योतिष प्रतिवेदन ॥</h1>
        <table class="data-table">
            <tr><td><b>नाम:</b> ${name}</td><td><b>स्थान:</b> ${document.getElementById('city').value}</td></tr>
            <tr><td><b>वार:</b> ${pan.var}</td><td><b>इष्टकाल:</b> ${pan.ishtakal}</td></tr>
            <tr><td><b>नक्षत्र:</b> ${pan.nakshatra} (${pan.charan} चरण)</td><td><b>अयनांश:</b> ${data.ayanamsa} (${document.getElementById('ayMode').value})</td></tr>
            <tr><td><b>योनि:</b> ${pan.yoni} | <b>गण:</b> ${pan.gan}</td><td><b>नाड़ी:</b> अंत्य | <b>वर्ण:</b> क्षत्रिय</td></tr>
        </table>
        
        <div style="display:flex; gap:15px;">
            <div style="flex:1">
                <h3 style="text-align:center">लग्न कुण्डली (D-1)</h3>
                <div class="chart-box" id="d1_svg"></div>
            </div>
            <div style="flex:1">
                <h3 style="text-align:center">नवांश कुण्डली (D-9)</h3>
                <div class="chart-box" id="d9_svg"></div>
            </div>
        </div>
    </div>`;

    // फलादेश पेज (200 पेज के ढांचे के लिए लूप का आधार)
    html += `<div class="pdf-page">
        <h2 style="color:var(--maroon); border-bottom:2px solid var(--maroon)">व्यक्तित्व एवं स्वभाव फलादेश</h2>
        <div class="prediction-box">
            <b>प्रिय ${name} जी,</b> आपकी कुण्डली में लग्न का स्वामी भाव ${data.lagna} में स्थित है। 
            यह स्थिति आपके व्यक्तित्व में गजब का आत्मविश्वास और तेज पैदा करती है। [cite: 37, 38]
            (यहाँ आपके द्वारा बताए गए प्रत्येक लग्न और भाव के अनुसार 200 पेज का विशिष्ट फलादेश और उपाय प्रदर्शित होंगे...) [cite: 39]
        </div>
    </div>`;

    document.getElementById('reportContainer').innerHTML = html;
    
    setTimeout(() => {
        drawChart('d1_svg', data.lagna, data.planets, 'd1');
        drawChart('d9_svg', 1, data.planets, 'd9');
    }, 500);
}

function drawChart(id, asc, planets, mode) {
    const coords = {1:[100,75], 2:[50,40], 3:[20,75], 4:[65,120], 5:[20,165], 6:[50,200], 7:[100,165], 8:[150,200], 9:[185,165], 10:[140,120], 11:[185,75], 12:[150,40]};
    let svg = `<svg viewBox="0 0 210 210" width="100%" height="100%"><path d="M0 0 L210 0 L210 210 L0 210 Z M0 0 L210 210 M210 0 L0 210 M105 0 L0 105 L105 210 L210 105 Z" fill="none" stroke="maroon" stroke-width="2"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]}" fill="maroon" font-weight="bold" font-size="12" text-anchor="middle">${sign}</text>`;
        let list = planets.filter(p => (mode==='d1' ? p.house : p.d9_sign) === i);
        list.forEach((p, idx) => {
            svg += `<text x="${coords[i][0]}" y="${coords[i][1]+10+(idx*12)}" font-size="10" fill="${p.is_retro?'red':'black'}" text-anchor="middle">${p.name}${p.is_retro?'(R)':''}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], { scale: 2 });
        if (i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save(`Complete_Commercial_Kundli.pdf`);
}
</script>
</body>
</html>
