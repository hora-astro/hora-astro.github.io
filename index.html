<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>FortuneWithStars Pro - Antardasha Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #800000; --gold: #b8860b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f9f9f9; margin: 0; }
        .toolbar { background: white; padding: 15px; border-bottom: 4px solid var(--main); display: flex; gap: 10px; justify-content: center; position: sticky; top:0; z-index:100; }
        .pdf-page { width: 210mm; min-height: 297mm; margin: 15px auto; background: white; padding: 20mm; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.1); page-break-after: always; }
        .header { text-align: center; border: 2px solid var(--main); padding: 10px; margin-bottom: 20px; background: #fffcf5; }
        .chart-container { display: flex; gap: 20px; justify-content: space-between; margin-bottom: 20px; }
        .chart-box { border: 1px solid var(--main); padding: 10px; width: 48%; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 13px; }
        th { background: var(--main); color: white; }
        .status-ex { color: green; font-weight: bold; }
        .status-db { color: red; font-weight: bold; }
        .dasha-section { margin-top: 20px; border: 1px solid #eee; padding: 10px; }
        .antardasha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; font-size: 11px; background: #fefefe; padding: 5px; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित">
    <input type="date" id="dob" value="1980-03-27" onchange="generate()">
    <input type="time" id="tob" value="10:30" onchange="generate()">
    <button onclick="generate()" style="background:var(--main); color:white; border:none; padding:10px 20px; cursor:pointer;">अपडेट कुंडली</button>
    <button onclick="downloadPDF()" style="background:green; color:white; border:none; padding:10px 20px; cursor:pointer;">PDF डाउनलोड</button>
</div>

<div id="loading" style="display:none; text-align:center; font-weight:bold; padding:20px;">गणना जारी है...</div>
<div id="printArea"></div>

<script>
const LORDS = ["", "मंगल", "शुक्र", "बुध", "चंद्र", "सूर्य", "बुध", "शुक्र", "मंगल", "गुरु", "शनि", "शनि", "गुरु"];

async function generate() {
    document.getElementById('loading').style.display = 'block';
    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: 23.32, lon: 74.26
    };
    try {
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.status === 'success') renderUI(data);
    } catch(e) { alert("सर्वर त्रुटि!"); }
    finally { document.getElementById('loading').style.display = 'none'; }
}

function renderUI(data) {
    let html = `<div class="pdf-page">
        <div class="header"><h1>॥ FortuneWithStars वृहद फलादेश ॥</h1><p>नाम: ${document.getElementById('custName').value}</p></div>
        <div class="chart-container">
            <div class="chart-box"><h3>लग्न कुंडली (D1)</h3><div id="d1_svg"></div></div>
            <div class="chart-box"><h3>नवांश कुंडली (D9)</h3><div id="d9_svg"></div></div>
        </div>
        <table>
            <tr><th>ग्रह</th><th>अंश</th><th>भाव</th><th>D1 स्थिति</th><th>पूर्ण दृष्टि</th></tr>`;
    data.planets.forEach(p => {
        html += `<tr>
            <td>${p.name}</td><td>${p.deg}</td><td>${p.house}</td>
            <td class="${p.status=='उच्च'?'status-ex':(p.status=='नीच'?'status-db':'')}">${p.status}</td>
            <td>${p.aspects} भाव पर</td>
        </tr>`;
    });
    html += `</table></div>`;

    // महादशा और अंतर्दशा पृष्ठ
    data.dashas.forEach((d, idx) => {
        if(idx % 3 === 0) html += `<div class="pdf-page"><h2>विंशोत्तरी दशा एवं अंतर्दशा (भाग ${Math.floor(idx/3)+1})</h2>`;
        
        html += `<div class="dasha-section">
            <div style="background:#f0f0f0; padding:8px; font-weight:bold; border-left: 5px solid var(--main);">
                महादशा: ${d.lord} (${d.start} से ${d.end})
            </div>
            <div class="antardasha-grid">`;
        d.antardasha.forEach(a => {
            html += `<div>${d.lord}-${a.lord}: <br><span style="color:var(--gold)">${a.end} तक</span></div>`;
        });
        html += `</div></div>`;
        
        if(idx % 3 === 2 || idx === 8) html += `</div>`;
    });

    document.getElementById('printArea').innerHTML = html;
    setTimeout(() => {
        drawChart('d1_svg', data.lagna.rIdx, data.planets, 'house');
        drawChart('d9_svg', data.lagna.d9, data.planets, 'd9');
    }, 500);
}

function drawChart(id, asc, planets, mode) {
    const coords = {1:[110,80], 2:[55,45], 3:[20,80], 4:[75,130], 5:[20,185], 6:[55,220], 7:[110,185], 8:[165,220], 9:[205,185], 10:[150,130], 11:[205,80], 12:[165,45]};
    let svg = `<svg viewBox="0 0 225 250" width="100%"><path d="M0 0 L225 0 L225 225 L0 225 Z M0 0 L225 225 M225 0 L0 225 M112 0 L0 112 L112 225 L225 112 Z" fill="none" stroke="#800000" stroke-width="2"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]}" fill="maroon" font-weight="bold" font-size="14" text-anchor="middle">${sign}</text>`;
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        list.forEach((p, idx) => {
            svg += `<text x="${coords[i][0]}" y="${coords[i][1] + 15 + (idx*12)}" font-size="9" text-anchor="middle" fill="#333">${p.name}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], { scale: 2 });
        if (i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save(`Kundli_Antardasha_Report.pdf`);
}
</script>
</body>
</html>
