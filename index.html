<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Astro Software - FortuneWithStars</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --maroon: #800000; --gold: #daa520; --bg: #fffcf5; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f0f0; margin: 0; padding: 0; color: #333; }
        
        .toolbar { background: white; padding: 15px; border-bottom: 4px solid var(--maroon); display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .toolbar input, .toolbar button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        .toolbar button { background: var(--maroon); color: white; cursor: pointer; font-weight: bold; border: none; transition: 0.3s; }
        .toolbar button:hover { background: #a00000; }
        
        .search-container { position: relative; }
        #suggestions { position: absolute; background: white; border: 1px solid #ccc; width: 100%; display: none; top: 45px; z-index: 1001; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #suggestions div { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
        #suggestions div:hover { background: #f0f0f0; }

        .pdf-page { width: 210mm; min-height: 290mm; margin: 20px auto; background: white; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 15px rgba(0,0,0,0.1); position: relative; }
        .header { text-align: center; border: 2px double var(--maroon); padding: 15px; background: var(--bg); margin-bottom: 20px; }
        .header h1 { margin: 0; color: var(--maroon); font-size: 28px; }
        
        .info-bar { background: #f8f8f8; padding: 10px; border-radius: 5px; text-align: center; font-size: 14px; margin-bottom: 20px; border: 1px solid #ddd; }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-box { border: 2px solid var(--maroon); padding: 15px; text-align: center; background: #fff; }
        .chart-box h3 { margin-top: 0; color: var(--maroon); border-bottom: 1px solid #eee; padding-bottom: 5px; }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
        th, td { border: 1px solid #999; padding: 12px; text-align: center; }
        th { background: #fdf2f2; color: var(--maroon); font-weight: bold; }
        
        .status-ex { color: green; font-weight: bold; }
        .status-db { color: red; font-weight: bold; }
        
        .prediction-card { background: #fffdf0; border-left: 5px solid var(--gold); padding: 15px; margin: 15px 0; border-radius: 4px; line-height: 1.6; }
        .prediction-card b { color: var(--maroon); }

        @media print { .toolbar { display: none; } body { background: white; } .pdf-page { margin: 0; box-shadow: none; } }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित" placeholder="नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <div class="search-container">
        <input type="text" id="citySearch" placeholder="शहर खोजें..." oninput="searchLocation(this.value)">
        <div id="suggestions"></div>
    </div>
    <input type="text" id="lat" placeholder="Lat" value="23.32" style="width:70px">
    <input type="text" id="lon" placeholder="Lon" value="74.26" style="width:70px">
    <button onclick="generateKundli()">कुंडली जेनरेट करें</button>
    <button onclick="downloadAsPDF()" style="background:green;">PDF डाउनलोड</button>
</div>

<div id="printArea">
    <div class="pdf-page">
        <div class="header">
            <h1>॥ श्री गणेशाय नमः ॥</h1>
            <h1 style="font-size: 22px; margin-top: 5px;">जन्म कुंडली एवं विस्तृत फलादेश</h1>
            <p style="margin: 5px 0; font-style: italic;">FortuneWithStars सिद्धांतों पर आधारित सटीक गणना</p>
        </div>

        <div id="locInfo" class="info-bar">विवरण देखने के लिए डेटा भरें और बटन दबाएं।</div>

        <div class="chart-grid">
            <div class="chart-box">
                <h3>D1 लग्न कुंडली</h3>
                <div id="d1_svg"></div>
            </div>
            <div class="chart-box">
                <h3>D9 नवांश कुंडली</h3>
                <div id="d9_svg"></div>
            </div>
        </div>

        <div id="planetTableContainer"></div>
    </div>

    <div id="predictionPages"></div>
</div>

<style>
    .page-break { page-break-after: always; border-top: 2px dashed #ccc; margin: 40px 0; }
    .status-tag { font-size: 10px; font-weight: bold; }
    .u-color { color: blue; } /* उच्च के लिए नीला */
    .n-color { color: red; }  /* नीच के लिए लाल */
    .prediction-text { font-size: 14px; text-align: justify; margin-bottom: 20px; }
</style>

<script>
function renderUI(data) {
    const config = LAGNA_CONFIG[data.lagna.rIdx];
    
    // 1. D1 & D9 Charts
    drawChart('d1_svg', data.lagna.rIdx, data.planets, 'house');
    drawChart('d9_svg', 1, data.planets, 'd9'); // D9 logic

    let fullReportHtml = "";

    // पेज 1: परिचय और चार्ट्स
    fullReportHtml += `<div class="pdf-page">
        <div class="header"><h1>जन्म कुंडली विवरण</h1></div>
        <div class="chart-grid">
            <div class="chart-box"><h3>D1 लग्न कुंडली</h3><div id="d1_report"></div></div>
            <div class="chart-box"><h3>D9 नवांश कुंडली</h3><div id="d9_report"></div></div>
        </div>
        <table><tr><th>ग्रह</th><th>अंश</th><th>D1 स्थिति</th><th>D9 स्थिति</th></tr>`;
    
    data.planets.forEach(p => {
        fullReportHtml += `<tr><td>${p.name}</td><td>${p.deg}</td>
        <td class="${p.status_d1=='उच्च'?'u-color':'n-color'}">${p.status_d1 || 'सामान्य'}</td>
        <td class="${p.status_d9=='उच्च'?'u-color':'n-color'}">${p.status_d9 || 'सामान्य'}</td></tr>`;
    });
    fullReportHtml += `</table></div><div class="page-break"></div>`;

    // पेज 2-15: विस्तृत फलादेश (ग्रहों और भावों का विश्लेषण)
    const houses_meanings = [
        "प्रथम भाव (तनु): व्यक्तित्व, स्वास्थ्य और आत्म-शक्ति।",
        "द्वितीय भाव (धन): वाणी, धन-संपत्ति और कुटुंब।",
        "तृतीय भाव (सहज): पराक्रम, छोटे भाई-बहन और संचार।",
        "चतुर्थ भाव (सुख): माता, भूमि, भवन और मानसिक सुख।",
        "पंचम भाव (सुत): बुद्धि, संतान, प्रेम और विद्या।",
        "षष्ठ भाव (रिपु): शत्रु, रोग, ऋण और प्रतियोगिता।",
        "सप्तम भाव (जाया): विवाह, साझेदारी और वैवाहिक सुख।",
        "अष्टम भाव (मृत्यु): आयु, गुप्त विद्याएं और अचानक परिवर्तन।",
        "नवम भाव (भाग्य): धर्म, पिता, लंबी यात्रा और भाग्य।",
        "दशम भाव (कर्म): करियर, सत्ता, सम्मान और पिता का सुख।",
        "एकादश भाव (आय): लाभ, बड़ी इच्छाएं और बड़े भाई-बहन।",
        "द्वादश भाव (व्यय): मोक्ष, अस्पताल, व्यय और विदेश यात्रा।"
    ];

    for(let i=1; i<=12; i++) {
        fullReportHtml += `<div class="pdf-page">
            <h2 style="color:var(--maroon)">अध्याय ${i+1}: ${i} वें भाव का विस्तृत विश्लेषण</h2>
            <div class="prediction-card"><b>भाव का महत्व:</b> ${houses_meanings[i-1]}</div>`;
        
        let pInHouse = data.planets.filter(p => p.house === i);
        if(pInHouse.length > 0) {
            pInHouse.forEach(p => {
                fullReportHtml += `<div class="prediction-card">
                    <b>ग्रह फल (${p.name}):</b> ${p.name} आपके ${i} वें भाव में स्थित है। 
                    ${p.status_d1 ? 'यह यहाँ <b>' + p.status_d1 + '</b> का होकर असाधारण प्रभाव दे रहा है।' : 'यह ग्रह इस भाव के मध्यम फलों को नियंत्रित कर रहा है।'}
                    <p class="prediction-text">शास्त्रों के अनुसार, ${p.name} का ${i} भाव में होना जातक को ${i==1?'तेजस्वी':(i==10?'कर्मठ':'विशिष्ट')} बनाता है। यहाँ ${p.name} अपनी रश्मियों से आपके जीवन के इस क्षेत्र को प्रभावित कर रहा है। FortuneWithStars के अनुसार आपको इस भाव से संबंधित शुभ फल प्राप्त करने के लिए नियमित मंत्र जाप करना चाहिए।</p>
                </div>`;
            });
        } else {
            fullReportHtml += `<p class="prediction-text">आपका यह भाव वर्तमान में रिक्त है, अतः इसका फल इस भाव के स्वामी की स्थिति पर निर्भर करेगा। इस भाव का स्वामी आपके जीवन के अन्य क्षेत्रों से जुड़कर शुभ योग बना रहा है।</p>`;
        }
        fullReportHtml += `</div><div class="page-break"></div>`;
    }

    // अंतिम पेज: महादशा और उपाय
    fullReportHtml += `<div class="pdf-page">
        <h2 style="color:var(--maroon)">अध्याय 15: महादशा एवं समाधान</h2>
        <div class="prediction-card">आपका जन्म <b>${data.dasha_lord}</b> की महादशा में हुआ है।</div>
        <p class="prediction-text">वर्तमान समय की गणना के अनुसार आपकी मानसिक और आर्थिक स्थिति पर ग्रहों का गहरा प्रभाव है। कुंडली में जो ग्रह नीच के हैं (यदि कोई हो), उनके दान करें और उच्च ग्रहों का रत्न धारण करने से पहले परामर्श लें।</p>
    </div>`;

    document.getElementById('predictionPages').innerHTML = fullReportHtml;
    
    // चार्ट्स को दोबारा ड्रा करें ताकि वे रिपोर्ट में दिखें
    setTimeout(() => {
        drawChart('d1_report', data.lagna.rIdx, data.planets, 'house');
        drawChart('d9_report', 1, data.planets, 'd9');
    }, 500);
}

function drawChart(id, asc, planets, mode) {
    const positions = {
        1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 
        7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]
    };
    let svg = `<svg viewBox="0 0 450 480" width="100%" height="300">
        <path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#333" stroke-width="2"/>`;
    
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 1) > 12 ? (asc + i - 1) - 12 : (asc + i - 1);
        let [x, y] = positions[i];
        svg += `<text x="${x}" y="${y+5}" fill="#800000" font-weight="bold" font-size="22" text-anchor="middle">${sign}</text>`;
        
        let list = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        list.forEach((p, idx) => {
            let statusChar = "";
            if(mode === 'house' && p.status_d1) statusChar = p.status_d1 === "उच्च" ? "(U)" : "(N)";
            if(mode === 'd9' && p.status_d9) statusChar = p.status_d9 === "उच्च" ? "(U)" : "(N)";
            
            let color = statusChar === "(U)" ? "blue" : (statusChar === "(N)" ? "red" : "#444");
            
            svg += `<text x="${x}" y="${y-20-(idx*15)}" font-size="12" text-anchor="middle" fill="${color}">${p.name}${statusChar}</text>`;
        });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}
</script>
</body>
</html>
