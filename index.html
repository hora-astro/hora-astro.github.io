<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Professional Astro - FortuneWithStars</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #daa520; }
        body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
        .setup-box { background: white; padding: 20px; border-radius: 8px; max-width: 800px; margin: auto; border-top: 5px solid var(--maroon); }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .chart-box { border: 2px solid var(--maroon); padding: 10px; background: white; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #999; padding: 10px; text-align: center; }
        .status-ex { color: blue; font-weight: bold; }
        .status-db { color: red; font-weight: bold; }
        .prediction-card { background: #fffdf0; border-left: 5px solid var(--gold); padding: 20px; margin-top: 20px; line-height: 1.6; }
    </style>
</head>
<body>

<div class="setup-box">
    <h2 style="color:var(--maroon); text-align:center;">॥ श्री गणेशाय नमः ॥</h2>
    <input type="text" id="custName" value="हेमंत पुरोहित">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <input type="text" id="lat" value="23.54">
    <input type="text" id="lon" value="74.47">
    <button onclick="generateKundli()" style="background:var(--maroon); color:white; padding:10px 20px; border:none; cursor:pointer;">कुंडली जेनरेट करें</button>
</div>

<div id="report-area" style="display:none; max-width:900px; margin:auto;">
    <div id="capture-this" style="padding:20px; background:white; margin-top:20px;">
        <div class="chart-grid">
            <div class="chart-box"><h3>D1 लग्न कुंडली</h3><div id="d1-svg"></div></div>
            <div class="chart-box"><h3>D9 नवांश कुंडली</h3><div id="d9-svg"></div></div>
        </div>
        <table id="p-table">
            <thead><tr><th>ग्रह</th><th>अंश</th><th>भाव</th><th>राशि</th><th>स्थिति</th></tr></thead>
            <tbody></tbody>
        </table>
        <div id="predictions" class="prediction-card"></div>
    </div>
    <button onclick="savePDF()" style="background:green; color:white; padding:15px; margin-top:10px; width:100%;">PDF डाउनलोड करें</button>
</div>

<script>
const LAGNA_DATA = {
    1: { name: "मेष", swami: "मंगल", phal: "मेष लग्न के लिए मंगल, सूर्य और गुरु शुभ हैं। शनि और बुध मारक प्रभाव दे सकते हैं।" },
    2: { name: "वृष", swami: "शुक्र", phal: "वृष लग्न में शनि योगकारक है। बुध और शुक्र शुभ फल देते हैं।" },
    3: { name: "मिथुन", swami: "बुध", phal: "मिथुन लग्न के लिए बुध, शुक्र और शनि मित्र हैं। मंगल अशुभ फल दे सकता है।" },
    4: { name: "कर्क", swami: "चंद्र", phal: "कर्क लग्न में मंगल योगकारक है। गुरु और चंद्र शुभ फल देते हैं।" },
    5: { name: "सिंह", swami: "सूर्य", phal: "सिंह लग्न के लिए मंगल और सूर्य श्रेष्ठ हैं। शुक्र-बुध अशुभ हो सकते हैं।" },
    6: { name: "कन्या", swami: "बुध", phal: "कन्या लग्न में बुध और शुक्र राजयोग बनाते हैं। मंगल कष्टकारी होता है।" },
    7: { name: "तुला", swami: "शुक्र", phal: "तुला लग्न के लिए शनि परम योगकारक है। बुध-शुक्र शुभ फल देते हैं।" },
    8: { name: "वृश्चिक", swami: "मंगल", phal: "वृश्चिक लग्न के लिए चंद्र-गुरु शुभ हैं। लग्नेश मंगल उन्नति देता है।" },
    9: { name: "धनु", swami: "गुरु", phal: "धनु लग्न के लिए सूर्य और मंगल राजयोग कारक हैं। गुरु शुभ है।" },
    10: { name: "मकर", swami: "शनि", phal: "मकर लग्न के लिए शुक्र सबसे बड़ा मित्र है। बुध भी अनुकूल फल देता है।" },
    11: { name: "कुम्भ", swami: "शनि", phal: "कुम्भ लग्न के लिए शुक्र-बुध शुभ हैं। लग्नेश शनि अनुशासन देता है।" },
    12: { name: "मीन", swami: "गुरु", phal: "मीन लग्न के लिए मंगल-चंद्र अत्यंत शुभ हैं। गुरु ज्ञान देता है।" }
};

async function generateKundli() {
    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };

    try {
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.status === 'success') renderUI(data);
    } catch (e) { alert("कनेक्शन फेल!"); }
}

function renderUI(data) {
    let tableHtml = "";
    data.planets.forEach(p => {
        let sClass = p.status === "उच्च" ? "status-ex" : (p.status === "नीच" ? "status-db" : "");
        tableHtml += `<tr><td>${p.name}</td><td>${p.deg}</td><td>${p.house}</td><td>${p.sign}</td><td class="${sClass}">${p.status}</td></tr>`;
    });
    document.querySelector("#p-table tbody").innerHTML = tableHtml;

    const lag = LAGNA_DATA[data.lagna.idx];
    document.getElementById('predictions').innerHTML = `<h3>${data.lagna.name} लग्न फलादेश</h3><p><b>स्वामी:</b> ${lag.swami}</p><p>${lag.phal}</p>`;
    
    drawChart("d1-svg", data.lagna.idx, data.planets, 'house');
    drawChart("d9-svg", data.planets[0].d9, data.planets, 'd9');
    document.getElementById('report-area').style.display = 'block';
}

function drawChart(id, asc, planets, mode) {
    const coords = {1:[225,170], 2:[110,95], 3:[55,170], 4:[150,265], 5:[55,345], 6:[110,420], 7:[225,345], 8:[340,420], 9:[395,345], 10:[300,265], 11:[395,170], 12:[340,95]};
    let svg = `<svg viewBox="0 0 450 480" width="100%"><path d="M0 0 L450 0 L450 450 L0 450 Z M0 0 L450 450 M450 0 L0 450 M225 0 L0 225 L225 450 L450 225 Z" fill="none" stroke="#333" stroke-width="2"/>`;
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]+5}" fill="maroon" font-weight="bold" font-size="20" text-anchor="middle">${sign}</text>`;
        let inH = (mode === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        inH.forEach((p, idx) => { svg += `<text x="${coords[i][0]}" y="${coords[i][1]-20-(idx*15)}" font-size="12" text-anchor="middle">${p.name}</text>`; });
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function savePDF() {
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.getElementById('capture-this'), {scale: 2});
    const doc = new jsPDF('p', 'mm', 'a4');
    doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    doc.save("Kundli.pdf");
}
</script>
</body>
</html>
