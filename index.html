<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortuneWithStars Pro - Commercial Kundli Software</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --maroon: #800000; --gold: #daa520; --bg: #fffcf5; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f4f4; margin: 0; }
        
        /* Toolbar */
        .toolbar { background: white; padding: 15px; border-bottom: 4px solid var(--maroon); display: flex; gap: 10px; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-wrap: wrap; }
        input, button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-gen { background: var(--maroon); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-pdf { background: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; }

        /* Search Suggestions */
        .search-container { position: relative; width: 220px; }
        #suggestions { position: absolute; background: white; border: 1px solid #ccc; width: 100%; top: 42px; display: none; max-height: 200px; overflow-y: auto; z-index: 1001; }
        #suggestions div { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }

        /* PDF Layout */
        .pdf-page { width: 210mm; min-height: 297mm; margin: 20px auto; background: white; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 15px rgba(0,0,0,0.1); page-break-after: always; position: relative; border: 1px solid #ddd; }
        .header { text-align: center; border: 2px double var(--maroon); padding: 10px; background: var(--bg); margin-bottom: 20px; }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-box { border: 2px solid var(--maroon); padding: 10px; text-align: center; background: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #999; padding: 8px; text-align: center; font-size: 13px; }
        th { background: var(--maroon); color: white; }
        
        .high { color: #27ae60; font-weight: bold; } /* Green for Exalted */
        .low { color: #e74c3c; font-weight: bold; }  /* Red for Debilitated */
        
        .dasha-block { margin-top: 15px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
        .dasha-header { background: #f8f8f8; padding: 8px; font-weight: bold; border-bottom: 1px solid #ddd; color: var(--maroon); }
        .antardasha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #eee; }
        .antardasha-item { background: white; padding: 6px; font-size: 11px; }

        .prediction-card { background: #fffdf0; border-left: 5px solid var(--gold); padding: 15px; margin: 15px 0; font-size: 14px; line-height: 1.6; }
        
        #loading { display: none; text-align: center; padding: 10px; color: var(--maroon); font-weight: bold; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="custName" value="हेमंत पुरोहित" placeholder="नाम">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <div class="search-container">
        <input type="text" id="citySearch" placeholder="शहर खोजें..." oninput="searchLoc(this.value)">
        <div id="suggestions"></div>
    </div>
    <input type="hidden" id="lat" value="23.32">
    <input type="hidden" id="lon" value="74.26">
    <button class="btn-gen" onclick="generate()">कुंडली बनाएँ</button>
    <button class="btn-pdf" onclick="downloadPDF()">PDF डाउनलोड</button>
</div>

<div id="loading">गणना की जा रही है... कृपया प्रतीक्षा करें।</div>
<div id="printArea"></div>

<script>
const RASHIS = ["", "मेष", "वृष", "मिथुन", "कर्क", "सिंह", "कन्या", "तुला", "वृश्चिक", "धनु", "मकर", "कुंभ", "मीन"];

async function searchLoc(q) {
    if(q.length < 3) return;
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await res.json();
    const box = document.getElementById('suggestions');
    box.innerHTML = ""; box.style.display = "block";
    data.slice(0, 5).forEach(item => {
        let div = document.createElement('div');
        div.innerText = item.display_name;
        div.onclick = () => {
            document.getElementById('lat').value = item.lat;
            document.getElementById('lon').value = item.lon;
            document.getElementById('citySearch').value = item.display_name.split(',')[0];
            box.style.display = "none";
        };
        box.appendChild(div);
    });
}

async function generate() {
    document.getElementById('loading').style.display = 'block';
    const payload = {
        date: document.getElementById('dob').value,
        time: document.getElementById('tob').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value
    };
    try {
        const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.status === 'success') renderUI(data);
    } catch(e) { alert("कनेक्शन फेल!"); }
    finally { document.getElementById('loading').style.display = 'none'; }
}

function renderUI(data) {
    let html = "";
    
    // Page 1: Main Charts & Planets
    html += `<div class="pdf-page">
        <div class="header"><h1>॥ विस्तृत जन्म कुंडली रिपोर्ट ॥</h1><p>नाम: ${document.getElementById('custName').value} | स्थान: ${document.getElementById('citySearch').value}</p></div>
        <div class="chart-grid">
            <div class="chart-box"><b>लग्न कुंडली (D1)</b><div id="d1_svg"></div></div>
            <div class="chart-box"><b>नवांश कुंडली (D9)</b><div id="d9_svg"></div></div>
        </div>
        <table>
            <tr><th>ग्रह</th><th>अंश</th><th>D1 स्थिति</th><th>D9 स्थिति</th><th>दृष्टि</th></tr>`;
    data.planets.forEach(p => {
        html += `<tr><td>${p.name}</td><td>${p.deg}</td><td class="${p.status_d1=='उच्च'?'high':(p.status_d1=='नीच'?'low':'')}">${p.status_d1}</td><td class="${p.status_d9=='उच्च'?'high':(p.status_d9=='नीच'?'low':'')}">${p.status_d9}</td><td>${p.aspect}वें भाव</td></tr>`;
    });
    html += `</table></div>`;

    // Page 2: Ashtakvarga (SAV)
    html += `<div class="pdf-page">
        <h2 style="color:var(--maroon); border-bottom: 2px solid var(--maroon);">सर्व-अष्टकवर्ग (SAV) चार्ट</h2>
        <div style="display:flex; justify-content:center; margin:20px 0;"><div id="sav_svg" style="width:300px;"></div></div>
        <table>
            <tr><th>राशि</th><th>बिंदु</th><th>विशेषता</th></tr>`;
    data.sav.forEach((pts, i) => {
        html += `<tr><td>${RASHIS[i+1]}</td><td><b>${pts}</b></td><td>${pts >= 28 ? 'शुभ (प्रबल)' : 'सामान्य'}</td></tr>`;
    });
    html += `</table></div>`;

    // Page 3+: Dashas
    data.dashas.forEach((d, idx) => {
        if(idx % 2 === 0) html += `<div class="pdf-page"><h2>विंशोत्तरी महादशा एवं अंतर्दशा</h2>`;
        html += `<div class="dasha-block">
            <div class="dasha-header">${d.lord} महादशा (${d.start} - ${d.end})</div>
            <div class="antardasha-grid">`;
        d.antardasha.forEach(ad => {
            html += `<div class="antardasha-item"><b>${d.lord}-${ad.lord}</b><br>${ad.end}</div>`;
        });
        html += `</div></div>`;
        if(idx % 2 === 1 || idx === 8) html += `</div>`;
    });

    document.getElementById('printArea').innerHTML = html;
    
    setTimeout(() => {
        drawChart('d1_svg', data.lagna, data.planets, 'house');
        drawChart('d9_svg', data.d9_lagna, data.planets, 'd9');
        drawChart('sav_svg', data.lagna, data.sav, 'sav');
    }, 500);
}

function drawChart(id, asc, items, mode) {
    const coords = {1:[112,80], 2:[55,45], 3:[25,80], 4:[75,130], 5:[25,180], 6:[55,215], 7:[112,180], 8:[165,215], 9:[200,180], 10:[150,130], 11:[200,80], 12:[165,45]};
    let svg = `<svg viewBox="0 0 225 240" width="100%"><path d="M0 0 L225 0 L225 225 L0 225 Z M0 0 L225 225 M225 0 L0 225 M112 0 L0 112 L112 225 L225 112 Z" fill="none" stroke="#800000" stroke-width="2"/>`;
    
    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 2) % 12 + 1;
        svg += `<text x="${coords[i][0]}" y="${coords[i][1]}" fill="maroon" font-weight="bold" font-size="14" text-anchor="middle">${sign}</text>`;
        
        if(mode === 'sav') {
            svg += `<text x="${coords[i][0]}" y="${coords[i][1]+25}" fill="black" font-weight="bold" font-size="18" text-anchor="middle">${items[sign-1]}</text>`;
        } else {
            let list = (mode === 'house') ? items.filter(p => p.house === i) : items.filter(p => p.d9_sign === sign);
            list.forEach((p, idx) => {
                let st = (mode==='house'?p.status_d1:p.status_d9);
                let color = st==='उच्च'?'green':(st==='नीच'?'red':'black');
                svg += `<text x="${coords[i][0]}" y="${coords[i][1]+12+(idx*10)}" font-size="8" fill="${color}" text-anchor="middle">${p.name}${st=='उच्च'?'(U)':(st=='नीच'?'(N)':'')}</text>`;
            });
        }
    }
    document.getElementById(id).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], { scale: 2 });
        if (i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save(`Kundli_Report_Premium.pdf`);
}
</script>
</body>
</html>
