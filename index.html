<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AstroPro Universal - व्यावसायिक सॉफ्टवेयर</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #800000; --gold: #b45309; --text: #1a1a1a; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f4f4; margin: 0; color: var(--text); }
        .control-panel { background: white; padding: 20px; border-bottom: 4px solid var(--main); display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .pdf-page { width: 210mm; min-height: 297mm; background: white; margin: 20px auto; padding: 15mm; box-sizing: border-box; box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; }
        h1, h2, h3 { color: var(--main); text-align: center; margin: 5px 0; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-wrap { border: 2px solid #ddd; padding: 10px; border-radius: 8px; background: #fffaf5; text-align: center; }
        svg { width: 100%; height: auto; max-width: 360px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; font-size: 14px; }
        th { background: var(--main); color: white; }
        .prediction-section { background: #fffcf0; border-left: 5px solid var(--gold); padding: 15px; margin: 15px 0; line-height: 1.6; }
        .dasha-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, button { padding: 12px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: var(--main); color: white; cursor: pointer; font-weight: bold; border: none; }
        button:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div class="control-panel no-print">
    <input type="text" id="name" value="हेमंत पुरोहित" placeholder="नाम">
    <input type="text" id="place" value="दिल्ली" placeholder="स्थान">
    <input type="date" id="dob" value="1980-03-27">
    <input type="time" id="tob" value="10:30">
    <button onclick="generateUniversalReport()">सॉफ्टवेयर रन करें</button>
    <button onclick="downloadPDF()" style="background:green;">PDF डाउनलोड</button>
</div>

<div id="reportContent">
    <div class="pdf-page">
        <h1>॥ श्री गणेशाय नमः ॥</h1>
        <h2 id="rName">जन्म कुंडली विवरण</h2>
        <p align="center" id="rDetails" style="font-weight: bold;"></p>

        <div class="chart-grid">
            <div class="chart-wrap">
                <h3>लग्न कुंडली (D1)</h3>
                <div id="d1_chart"></div>
            </div>
            <div class="chart-wrap">
                <h3>नवांश कुंडली (D9)</h3>
                <div id="d9_chart"></div>
            </div>
        </div>

        <h3>ग्रह स्पष्टीकरण एवं नक्षत्र</h3>
        <table id="p_table"></table>
    </div>

    <div class="pdf-page">
        <h3>विंशोत्तरी महादशा एवं अंतर्दशा</h3>
        <div class="dasha-grid" id="dasha_content"></div>
        
        <div style="margin-top: 30px;">
            <h3>व्यावसायिक फलादेश एवं उपाय</h3>
            <div class="prediction-section" id="life_pred"></div>
        </div>
    </div>
</div>

<script>
async function generateUniversalReport() {
    const res = await fetch('https://hemantpurohit27.pythonanywhere.com/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ date: document.getElementById('dob').value, time: document.getElementById('tob').value })
    });
    const data = await res.json();
    if(data.status === 'success') renderUI(data);
}

function renderUI(data) {
    document.getElementById('rName').innerText = "नाम: " + document.getElementById('name').value;
    document.getElementById('rDetails').innerText = `स्थान: ${document.getElementById('place').value} | दिनांक: ${document.getElementById('dob').value} | समय: ${document.getElementById('tob').value}`;

    // Table
    let table = `<tr><th>ग्रह</th><th>अंश</th><th>नक्षत्र</th><th>पद</th><th>भाव</th></tr>`;
    data.planets.forEach(p => {
        table += `<tr><td><b>${p.name}</b></td><td>${p.deg}°</td><td>${p.nak}</td><td>${p.charan}</td><td>${p.house}</td></tr>`;
    });
    document.getElementById('p_table').innerHTML = table;

    // Drawing Charts (Centering Logic)
    drawUniversalChart('d1_chart', data.lagna.rIdx, data.planets, 'house');
    drawUniversalChart('d9_chart', data.lagna.d9, data.planets, 'd9');

    // Dasha & Antardasha
    let dashaHtml = "";
    data.dasha.forEach(m => {
        dashaHtml += `<div style="border:1px solid #ddd; padding:10px; background:#fff">
            <b style="color:var(--main)">${m.lord} महादशा</b><br>
            <small>${m.start} - ${m.end}</small><br>
            <div style="font-size:11px; margin-top:5px; color:#555">अंतर्दशा: ${m.lord}-${m.lord}, ${m.lord}-मंगल...</div>
        </div>`;
    });
    document.getElementById('dasha_content').innerHTML = dashaHtml;

    // Predictions
    document.getElementById('life_pred').innerHTML = `
        <b>● करियर:</b> दशम भाव में बुध और केतु की स्थिति व्यावसायिक सफलता और तकनीकी कौशल प्रदान करती है। <br>
        <b>● आर्थिक:</b> सूर्य की एकादश भाव में उपस्थिति धन लाभ के निरंतर स्रोत बनाए रखेगी। <br>
        <b>● उपाय:</b> हनुमान चालीसा का पाठ करें और पक्षियों को सात प्रकार का अनाज खिलाएं।
    `;
}

function drawUniversalChart(divId, asc, planets, type) {
    const centers = {
        1:[180,140], 2:[90,85], 3:[55,140], 4:[125,215], 5:[55,285], 6:[90,340],
        7:[180,285], 8:[270,340], 9:[305,285], 10:[235,215], 11:[305,140], 12:[270,85]
    };

    let svg = `<svg viewBox="0 0 360 380">
        <path d="M0 0 L360 0 L360 360 L0 360 Z M0 0 L360 360 M360 0 L0 360 M180 0 L0 180 L180 360 L360 180 Z" 
              fill="none" stroke="#800000" stroke-width="2.5"/>`;

    for (let i = 1; i <= 12; i++) {
        let sign = (asc + i - 1); if (sign > 12) sign -= 12;
        let [cx, cy] = centers[i];
        
        // राशि नंबर - गहरा रंग और बिल्कुल केंद्र में
        svg += `<text x="${cx}" y="${cy}" fill="#cc0000" font-weight="bold" font-size="22" text-anchor="middle" dominant-baseline="middle">${sign}</text>`;

        // ग्रहों का ग्रुपिंग - राशि के नीचे
        let list = (type === 'house') ? planets.filter(p => p.house === i) : planets.filter(p => p.d9 === sign);
        if(list.length > 0) {
            let pText = list.map(p => p.name).join(" ");
            // अगर 3 से अधिक ग्रह हैं तो दो लाइनों में
            if(list.length > 2) {
                let l1 = list.slice(0, 2).map(p => p.name).join(" ");
                let l2 = list.slice(2).map(p => p.name).join(" ");
                svg += `<text x="${cx}" y="${cy+18}" font-size="12" font-weight="bold" text-anchor="middle" fill="#000">${l1}</text>`;
                svg += `<text x="${cx}" y="${cy+32}" font-size="12" font-weight="bold" text-anchor="middle" fill="#000">${l2}</text>`;
            } else {
                svg += `<text x="${cx}" y="${cy+20}" font-size="13" font-weight="bold" text-anchor="middle" fill="#000">${pText}</text>`;
            }
        }
    }
    document.getElementById(divId).innerHTML = svg + `</svg>`;
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.pdf-page');
    for(let i=0; i<pages.length; i++) {
        const canvas = await html2canvas(pages[i], {scale: 3});
        if(i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
    }
    doc.save("Kundli_Professional_Universal.pdf");
}
</script>
</body>
</html>
